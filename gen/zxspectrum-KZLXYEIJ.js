import{D as C}from"./chunk-LJINFNAP.js";import{H as S}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";var E=[{id:"hello.bas",name:"Hello World (BASIC)",category:"BASIC"},{id:"hello.c",name:"Hello World (C)",category:"C"}],w=class{constructor(n){this.iframe=null;this.currentModel="48k";this.pauseResumeSupported=!0;this.isPaused=!1;this.blobUrls=[];this.originalBinary=null;this.originalFilename=null;this.lastLoadedDataUrl=null;this.lastLoadedContentType=null;this.mainElement=n,window.addEventListener("message",e=>{e.data&&e.data.type==="emulator_capabilities"&&(console.log("ZXSpectrumPlatform: Received emulator capabilities:",e.data.capabilities),e.data.capabilities&&typeof e.data.capabilities.pause=="boolean"&&(this.pauseResumeSupported=e.data.capabilities.pause),this.updateControlButtons())})}async start(){console.log("ZXSpectrumPlatform start() called"),this.iframe=document.createElement("iframe"),this.iframe.id="zxspectrum-iframe",this.iframe.style.width="100%",this.iframe.style.height="600px",this.iframe.style.border="1px solid #ccc",this.iframe.style.backgroundColor="#000",this.iframe.setAttribute("tabindex","-1"),this.iframe.addEventListener("focus",o=>{o.stopPropagation(),o.preventDefault()},!0),this.iframe.addEventListener("click",o=>{o.stopPropagation()},!0),this.iframe.addEventListener("blur",o=>{o.stopPropagation()},!0),this.mainElement.innerHTML="",this.mainElement.appendChild(this.iframe);let e=new URLSearchParams(window.location.search).get("model")||"48k";this.currentModel=e==="128k"?"128k":"48k";let t=`?t=${Date.now()}`,i=`&model=${encodeURIComponent(this.currentModel)}`;this.iframe.src=`zxspectrum-iframe.html${t}${i}`,console.log("ZXSpectrumPlatform: iframe created and qaop loading, model:",this.currentModel),this.setupCompilationListener(),setTimeout(()=>{this.updateControlButtons()},100)}stop(){console.log("ZXSpectrumPlatform stop() called")}reset(){if(console.log("ZXSpectrumPlatform reset() called"),this.iframe){let n=this.lastLoadedDataUrl,e=this.lastLoadedContentType,t=this.originalFilename,i=this.iframe.src.split("?")[0],o=`?t=${Date.now()}`,r=`&model=${encodeURIComponent(this.currentModel)}`;if(this.iframe.src=i+o+r,console.log("ZXSpectrumPlatform: Reloaded iframe for reset"),this.isPaused=!1,this.updatePauseButtonIcon(),n&&e){let u=()=>{console.log("ZXSpectrumPlatform: Iframe reloaded, reloading program"),this.iframe&&this.iframe.contentWindow&&setTimeout(()=>{this.iframe.contentWindow.postMessage({cmd:"load",url:n,contentType:e,filename:t},"*"),console.log("ZXSpectrumPlatform: Reloaded program after reset")},500),this.iframe.removeEventListener("load",u)};this.iframe.addEventListener("load",u,{once:!0})}}}isRunning(){return this.iframe!==null}getToolForFilename(n){let e=n.toLowerCase();return e.endsWith(".bas")?"zxbasic":e.endsWith(".c")||e.endsWith(".h")?"z88dk":C(n)}getDefaultExtension(){return".bas"}getPresets(){return E}pause(){if(!this.pauseResumeSupported){console.log("ZXSpectrumPlatform: Pause not supported");return}this.isPaused=!this.isPaused,console.log("ZXSpectrumPlatform pause() called, isPaused:",this.isPaused),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"pause",pause:this.isPaused},"*"),console.log("ZXSpectrumPlatform: Sent pause toggle command to iframe, paused:",this.isPaused)),this.updatePauseButtonIcon()}resume(){this.pause()}updatePauseButtonIcon(){let n=document.getElementById("dbg_pause");if(n){let e=n.querySelector(".glyphicon");e&&(this.isPaused?(e.classList.remove("glyphicon-pause"),e.classList.add("glyphicon-play"),n.title="Resume"):(e.classList.remove("glyphicon-play"),e.classList.add("glyphicon-pause"),n.title="Pause"))}}loadROM(n,e){var d,h,l,g,m,b,P,y,F;if(console.log("ZXSpectrumPlatform loadROM called with title:",n,"rom type:",typeof e,"rom length:",e instanceof Uint8Array?e.length:"N/A"),!this.iframe){console.error("ZXSpectrumPlatform: iframe not ready");return}if(e instanceof Uint8Array){let a=e.length;for(let s=e.length-1;s>=0;s--)if(e[s]!==0){a=s+1;break}a<e.length?(console.log(`ZXSpectrumPlatform: Trimming binary from ${e.length} to ${a} bytes (removed ${e.length-a} trailing zeros)`),this.originalBinary=e.slice(0,a)):this.originalBinary=new Uint8Array(e),console.log("ZXSpectrumPlatform: Stored original binary for download:",this.originalBinary.length,"bytes")}else this.originalBinary=null;let t=(d=window.IDE)==null?void 0:d.getCurrentMainFilename;if(t)this.originalFilename=t();else{let a=(h=window.IDE)==null?void 0:h.current_project;a&&a.mainPath?this.originalFilename=a.mainPath:this.originalFilename=n}let i;if(e&&typeof e=="object"&&!(e instanceof Uint8Array)){console.log("ZXSpectrumPlatform: Detected BASIC AST, getting source file");let a=null;if(t&&(a=t()),!a){let c=(l=window.IDE)==null?void 0:l.current_project;c&&c.mainPath&&(a=c.mainPath)}if(!a){let c=(g=window.IDE)==null?void 0:g.getCurrentProject;if(c){let x=c();x&&x.mainPath&&(a=x.mainPath)}}!a&&n&&(n.includes(".")||n.length<50)&&(a=n),a||(console.warn("ZXSpectrumPlatform: Could not get current filename. Title was:",n),a=n);let s=null;if(this.sourceFileFetch&&a){let c=this.sourceFileFetch(a);c&&typeof c=="string"&&(s=c)}if(!s){let c=(m=window.IDE)==null?void 0:m.current_project;c&&c.filedata&&a&&(s=c.filedata[a])}if(!s){let c=(b=window.IDE)==null?void 0:b.getCurrentProject;if(c){let x=c();x&&x.filedata&&a&&(s=x.filedata[a])}}if(s&&typeof s=="string")i=new TextEncoder().encode(s),console.log("ZXSpectrumPlatform: Using source file text from",a+",",i.length,"bytes");else{console.error("ZXSpectrumPlatform: Could not find source file for",a,"- tried sourceFileFetch and project.filedata");return}}else if(e instanceof Uint8Array)this.originalBinary&&this.originalBinary.length<e.length?(i=this.originalBinary,console.log("ZXSpectrumPlatform: Using trimmed binary data,",i.length,"bytes (original was",e.length,"bytes)")):(i=e,console.log("ZXSpectrumPlatform: Using binary data,",i.length,"bytes"));else{console.error("ZXSpectrumPlatform: Unexpected rom type:",typeof e);return}let o=null;if(t&&(o=t()),!o){let a=(P=window.IDE)==null?void 0:P.current_project;a&&a.mainPath&&(o=a.mainPath)}let r="application/x.zx.tap";if(i.length>0){if(i[0]===19)r="application/x.zx.tap",console.log("ZXSpectrumPlatform: TAP file detected (likely from z88dk), using as-is");else if(i.length>30&&i[0]===3&&i[1]===0)r="application/x.zx.z80";else if(i.length>27&&i[0]===63)r="application/x.zx.sna";else if(o&&(o.endsWith(".c")||o.endsWith(".C"))){console.log("ZXSpectrumPlatform: C program binary detected (not TAP), wrapping in CODE block");let a=((y=o.split("/").pop())==null?void 0:y.replace(/\.[^.]*$/,""))||"PROGRAM";i=this.createCodeTAPFile(i,a,32768),r="application/x.zx.tap"}else if(i.length>1024){let a=o&&((F=o.split("/").pop())==null?void 0:F.replace(/\.[^.]*$/,""))||"PROGRAM";i=this.createCodeTAPFile(i,a,32768),r="application/x.zx.tap"}}let u;if(i.length>65536){let a=[];for(let s=0;s<i.length;s+=8192){let c=i.slice(s,Math.min(s+8192,i.length));a.push(String.fromCharCode(...c))}u=btoa(a.join(""))}else u=btoa(String.fromCharCode(...i));let f=`data:${r};base64,${u}`;this.lastLoadedDataUrl=f,this.lastLoadedContentType=r,console.log("ZXSpectrumPlatform: Created data URL with content type:",r),console.log("ZXSpectrumPlatform: Data URL length:",f.length,"bytes (original:",i.length,"bytes)");let p=()=>{var a;if(this.iframe&&this.iframe.contentWindow){let s=o;if(!s&&t&&(s=t()),!s){let c=(a=window.IDE)==null?void 0:a.current_project;c&&c.mainPath&&(s=c.mainPath)}console.log("ZXSpectrumPlatform: Sending load command, filename:",s,"contentType:",r),this.iframe.contentWindow.postMessage({cmd:"load",url:f,contentType:r,data:Array.from(i),filename:s},"*"),console.log("ZXSpectrumPlatform: Sent load command to iframe with data URL and content type:",r)}else console.warn("ZXSpectrumPlatform: Iframe not ready, retrying..."),setTimeout(p,100)};setTimeout(p,100)}getROMExtension(n){var i,o;if(n&&n.length>0&&n[0]===19)return".tap";if(n&&n.length>30&&n[0]===3&&n[1]===0)return".z80";let e=null,t=(i=window.IDE)==null?void 0:i.getCurrentMainFilename;if(t&&(e=t()),!e){let r=(o=window.IDE)==null?void 0:o.current_project;r&&r.mainPath&&(e=r.mainPath)}return e&&(e.endsWith(".c")||e.endsWith(".C"))?".z80":".tap"}createCodeTAPFile(n,e,t){var g;let i=((g=e.split("/").pop())==null?void 0:g.replace(/\.[^.]*$/,""))||"PROGRAM",o=new Uint8Array(10);o.fill(32);for(let m=0;m<Math.min(i.length,10);m++)o[m]=i.toUpperCase().charCodeAt(m);let r=n.length,u=new Uint8Array(17);u[0]=3,u.set(o,1),u[11]=r&255,u[12]=r>>8&255,u[13]=t&255,u[14]=t>>8&255,u[15]=128,u[16]=0;let f=0;for(let m=0;m<17;m++)f^=u[m];let p=new Uint8Array(1+2+17+1);p[0]=19,p[1]=17,p[2]=0,p.set(u,3),p[3+17]=f;let d=new Uint8Array(1+2+r+1);d[0]=255,d[1]=r&255,d[2]=r>>8&255,d.set(n,3);let h=255;h^=r&255,h^=r>>8&255;for(let m=0;m<r;m++)h^=n[m];d[3+r]=h;let l=new Uint8Array(p.length+d.length);return l.set(p,0),l.set(d,p.length),l}getFileType(n){let e=n.toLowerCase();return e.endsWith(".tap")?"tap":e.endsWith(".z80")?"z80":e.endsWith(".sna")?"sna":e.endsWith(".rom")?"rom":e.endsWith(".scr")?"scr":"tap"}setupCompilationListener(){let n=window.setCompileOutput;n&&(window.setCompileOutput=e=>{n(e),e&&e.output&&!e.errors&&console.log("ZXSpectrumPlatform: Compilation detected, reloading program")})}updateControlButtons(){let n=document.getElementById("dbg_reset"),e=document.getElementById("dbg_pause"),t=document.getElementById("dbg_go");n&&(n.style.display="inline-block",console.log("ZXSpectrumPlatform: Reset button visible")),e&&(e.style.display=this.pauseResumeSupported?"inline-block":"none",console.log("ZXSpectrumPlatform: Pause button visibility:",this.pauseResumeSupported?"visible":"hidden"),this.updatePauseButtonIcon()),t&&(t.style.display="none",t.style.visibility="hidden",t.style.position="absolute",t.style.left="-9999px",console.log("ZXSpectrumPlatform: Resume button hidden (pause button toggles)"))}getDownloadFile(){if(this.originalBinary){console.log("ZXSpectrumPlatform: getDownloadFile() called, returning original binary:",this.originalBinary.length,"bytes");let n=".bin";if(this.originalFilename){let i=this.originalFilename.toLowerCase();i.endsWith(".bas")?n=".tap":i.endsWith(".c")?n=".bin":n=this.getROMExtension(this.originalBinary)}else n=this.getROMExtension(this.originalBinary);let e=new Uint8Array(this.originalBinary),t=new Blob([e],{type:"application/octet-stream"});return{extension:n,blob:t}}console.log("ZXSpectrumPlatform: getDownloadFile() called, but no original binary available")}loadState(n){console.log("ZXSpectrumPlatform: loadState not yet implemented")}saveState(){return console.log("ZXSpectrumPlatform: saveState not yet implemented"),null}createZ80Snapshot(n,e){let t=new Uint8Array(30);t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=255,t[10]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=0,t[16]=0,t[17]=0,t[18]=0,t[19]=0,t[20]=0,t[21]=0,t[22]=0,t[23]=58,t[24]=92,t[25]=0,t[26]=0,t[27]=0,t[28]=0,t[29]=0,t[27]=1,t[28]=1,t[29]=1;let i=new Uint8Array(23);i[0]=e&255,i[1]=e>>8&255;let o=new Uint8Array(25);o[0]=23&255,o[1]=23>>8&255,o.set(i,2);let r=new Uint8Array(49152);for(let l=0;l<6912;l++)r[l]=0;for(let l=6912;l<7168;l++)r[l]=71;for(let l=7168;l<7424;l++)r[l]=0;let u=e-16384;u>=0&&u+n.length<=r.length?r.set(n,u):console.warn(`ZXSpectrumPlatform: Code doesn't fit in RAM at address 0x${e.toString(16)}`);let f=[];for(let l=0;l<3;l++){let g=l*16384,m=g+16384,b=r.slice(g,m),P=b.length,y=new Uint8Array(2+P);y[0]=P&255,y[1]=P>>8&255,y.set(b,2),f.push(y)}let p=t.length+o.length;for(let l of f)p+=l.length;let d=new Uint8Array(p);d.set(t,0),d.set(o,t.length);let h=t.length+o.length;for(let l of f)d.set(l,h),h+=l.length;return console.log(`ZXSpectrumPlatform: Created Z80 snapshot: ${d.length} bytes (header: ${t.length}, blocks: ${f.map(l=>l.length).join(", ")})`),d}compressZ80RAM(n){let e=[],t=0;for(;t<n.length;){let i=n[t];if(i===237){t+1<n.length&&n[t+1]===237?(e.push(237,237,0),t++):e.push(237,237,0),t++;continue}let o=1;for(;t+o<n.length&&n[t+o]===i&&o<255;)o++;if(o>=4)e.push(237,237,o,i),t+=o;else{for(let r=0;r<o;r++)e.push(n[t+r]);t+=o}}return new Uint8Array(e)}};S.zxspectrum=w;var B=w;export{w as ZXSpectrumPlatform,B as default};
//# sourceMappingURL=zxspectrum-KZLXYEIJ.js.map
