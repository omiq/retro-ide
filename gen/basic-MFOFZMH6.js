import{b as v}from"./chunk-3XE5YOCV.js";import{a as f,t as S}from"./chunk-P5GZXNEB.js";import"./chunk-T4FRG4BA.js";import"./chunk-B2GOFULO.js";import"./chunk-EVJEJUX2.js";import"./chunk-CO72NYTV.js";import{H as p,R as d,S as g,a as b,y as m}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";function O(u){return u.value!=null}function y(u){return u.name!=null}function N(u){return u.op!=null&&u.left!=null&&u.right!=null}function I(u){return u.op!=null&&u.expr!=null}var E=class{randomize(){this.seed(Math.random()*2147483647,Math.random()*2147483647,Math.random()*2147483647,Math.random()*2147483647)}constructor(){(()=>{var e,r,i,n;this.seed=function(s,a,o,h){e=s,r=a,i=o,n=h},this.seedfloat=function(s){this.seed(s,s*4294,s*429496,s*4294967296),this.next(),this.next(),this.next()},this.next=function(){e>>>=0,r>>>=0,i>>>=0,n>>>=0;var s=e+r|0;return e=r^r>>>9,r=i+(i<<3)|0,i=i<<21|i>>>11,n=n+1|0,s=s+n|0,i=i+s|0,(s>>>0)/4294967296}})(),this.seedfloat(-1)}},w=1024*1024,l=class{constructor(){this.margin=80;this.running=!1;this.exited=!0;this.trace=!1}load(t){let e=null,r=0;if(this.pc2label!=null){let s=this.curpc;for(;s>0&&(e=this.pc2label.get(s))==null;)s--;r=this.curpc-s,console.log("oldpc=",this.curpc,"restart @ label",e,"+",r)}this.program=t,this.opts=t.opts,this.opts.maxArrayElements||(this.opts.maxArrayElements=w),this.allstmts=t.stmts,this.label2pc=t.labels,this.label2dataptr={},this.pc2label=new Map,this.datums=[],this.subroutines={},this.builtins=this.getBuiltinFunctions();for(var i in t.labels){var n=t.labels[i];this.pc2label.set(n,i)}return this.allstmts.forEach((s,a)=>{this.curpc=a+1,this.compileStatement(s),s.command=="DATA"&&(this.label2dataptr[s.$loc.label]=this.datums.length,s.datums.forEach(o=>{this.curpc=s.$loc.offset,this.datums.push(o)}))}),this.label2pc[e]!=null?(this.curpc=this.label2pc[e]+r,!0):(this.curpc=0,!1)}reset(){this.curpc=0,this.dataptr=0,this.clearVars(),this.returnStack=[],this.column=0,this.running=!0,this.exited=!1}clearVars(){this.globals=this.vars={},this.arrays={},this.defs={},this.forLoops={},this.forLoopStack=[],this.whileLoops=[],this.rng=new E,this.opts&&this.opts.staticArrays&&this.allstmts.filter(t=>t.command=="DIM").forEach(t=>{t.args.forEach(e=>this.compileJS(this._DIM(e))())})}saveState(){return $.extend(!0,{},this)}loadState(t){$.extend(!0,this,t)}getBuiltinFunctions(){var t=this.program&&this.opts.validFunctions;t||(t=Object.getOwnPropertyNames(l.prototype).filter(i=>/^[A-Z]{3,}[$]?$/.test(i)));var e={};for(var r of t)this.supportsFunction(r)&&(e[r]=this[r].bind(this));return e}supportsFunction(t){return typeof this[t]=="function"}runtimeError(t){throw this.curpc--,new d(t,this.getCurrentSourceLocation())}dialectError(t){this.runtimeError(`I can't ${t} in this dialect of BASIC.`)}getLineForPC(t){var e=this.allstmts[t];return e&&e.$loc&&e.$loc.line}getLabelForPC(t){var e=this.allstmts[t];return e&&e.$loc&&e.$loc.label}getCurrentSourceLocation(){var t=this.getStatement();return t&&t.$loc}getCurrentLabel(){var t=this.getCurrentSourceLocation();return t&&t.label}getStatement(){return this.allstmts[this.curpc]}step(){if(!this.running)return!1;var t=this.getStatement();return t?(this.trace&&console.log(this.curpc,t,this.vars,Object.keys(this.arrays)),this.curpc++,this.executeStatement(t),this.running):(this.running=!1,this.exited=!0,!1)}compileStatement(t){if(t.$run==null)try{var e=this["do__"+t.command];e==null&&this.runtimeError(`I don't know how to "${t.command}".`);var r=e.bind(this)(t);this.trace&&console.log(r),t.$run=this.compileJS(r)}catch(i){throw r&&console.log(r),i}}compileJS(t){return new Function(t).bind(this)}executeStatement(t){this.compileStatement(t),t.$run()}skipToEOL(){do this.curpc++;while(this.curpc<this.allstmts.length&&!this.pc2label.get(this.curpc))}skipToElse(){for(;this.curpc<this.allstmts.length;){var t=this.allstmts[this.curpc].command;if(t=="ELSE"){this.curpc++;break}else if(t=="IF")return this.skipToEOL();if(this.curpc++,this.pc2label.get(this.curpc))break}}skipToEOF(){this.curpc=this.allstmts.length}skipToAfterNext(t){for(var e=this.curpc;e<this.allstmts.length;){var r=this.allstmts[e];if(r.command=="NEXT"){var i=r.lexpr;if(i&&i.name==t){this.curpc=e+1;return}}e++}this.runtimeError(`I couldn't find a matching NEXT ${t} to skip this for loop.`)}skipToAfterWend(){for(var t=this.curpc-1,e=0;t<this.allstmts.length;){var r=this.allstmts[t];if(r.command=="WHILE")e++;else if(r.command=="WEND"&&(e--,e==0)){this.curpc=t+1;return}t++}this.runtimeError("I couldn't find a matching WEND for this WHILE.")}gotoLabel(t){var e=this.label2pc[t];e>=0?this.curpc=e:this.runtimeError(`I tried to go to the label "${t}" but couldn't find it.`)}newLocalScope(){this.vars=Object.create(this.vars)}popLocalScope(){this.vars!==this.globals&&(this.vars=Object.getPrototypeOf(this.vars))}gosubLabel(t){this.returnStack.length>32767&&this.runtimeError("I did too many GOSUBs without a RETURN."),this.returnStack.push(this.curpc),this.gotoLabel(t)}returnFromGosub(){this.returnStack.length==0&&this.runtimeError("I tried to RETURN, but there wasn't a corresponding GOSUB.");var t=this.returnStack.pop();this.curpc=t,this.popLocalScope()}popReturnStack(){this.returnStack.length==0&&this.runtimeError("I tried to POP, but there wasn't a corresponding GOSUB."),this.returnStack.pop()}valueToString(t,e){var r;if(typeof t=="number"){var i=this.float2str(t,this.opts.printZoneLength-4);return e?i.startsWith("-")?`${i} `:` ${i} `:i}else if(t==`
`)this.column=0,r=t;else if(t=="	"){var n=this.opts.printZoneLength,s=Math.floor(this.column/n),a=(s+1)*this.opts.printZoneLength;a+n>this.margin?(this.column=0,r=`
`):r=this.TAB(a)}else r=`${t}`;return r}float2str(t,e){var r=t.toString().toUpperCase();if(e>0){for(var i=e;r.length>e;)r=t.toPrecision(i--);r.startsWith("0.")?r=r.substr(1):r.startsWith("-0.")&&(r="-"+r.substr(2))}return r}printExpr(t){var e=this.valueToString(t,this.opts.numericPadding);this.column+=e.length,this.print(e)}print(t){console.log(t)}async input(t,e){return{line:"",vals:[]}}resume(){}expr2js(t,e){if(e||(e={}),O(t))return JSON.stringify(t.value);if(y(t)){if(!t.args&&e.locals&&e.locals.indexOf(t.name)>=0)return t.name;{e.isconst&&this.runtimeError("I expected a constant value here.");var r="",i=JSON.stringify(t.name);let o=t.args?t.args.map(h=>this.expr2js(h,e)).join(", "):[];return t.name.startsWith("FN")?r+=`this.getDef(${i})(${o})`:this.builtins[t.name]?(this.checkFuncArgs(t,this.builtins[t.name]),r+=`this.builtins.${t.name}(${o})`):t.args?this.opts.arraysContainChars&&t.name.endsWith("$")?r+=`this.getStringSlice(this.vars.${t.name}, ${o})`:r+=`this.arrayGet(${i}, ${o})`:r+=`this.vars.${t.name}`,e.novalid?r:`this.checkValue(${r}, ${i})`}}else if(N(t)){var n=this.expr2js(t.left,e),s=this.expr2js(t.right,e);return`this.${t.op}(${n}, ${s})`}else if(I(t)){var a=this.expr2js(t.expr,e);return`this.${t.op}(${a})`}}assign2js(t,e){e||(e={});var r="";return(t.name.startsWith("FN")||this.builtins[t.name])&&this.runtimeError("I can't call a function here."),t.args?this.opts.arraysContainChars&&t.name.endsWith("$")?this.runtimeError("I can't set array slices via this command yet."):r+=this.array2js(t,e):r=`this.globals.${t.name}`,r}array2js(t,e){var r=JSON.stringify(t.name),i=t.args||[];return this.expr2js(t,{novalid:!0})+`;this.getArray(${r}, ${i.length})`+i.map(n=>"[this.ROUND("+this.expr2js(n,e)+")]").join("")}checkFuncArgs(t,e){var r=t.args?t.args.length:0;t.name=="RND"&&r==0||t.name=="MID$"&&r==2||t.name=="INSTR"&&r==2||e.length!=r&&this.runtimeError(`I expected ${e.length} arguments for the ${t.name} function, but I got ${r}.`)}startForLoop(t,e,r,i,n){var s=this.curpc-1,a=this.pc2label.get(s);i||(i=1),this.vars[t]=e,this.trace&&console.log(`FOR ${t} = ${e} TO ${r} STEP ${i}`);var o=()=>i>=0?this.vars[t]>r:this.vars[t]<r;this.opts.testInitialFor&&o()&&(n!=null?this.curpc=n+1:this.skipToAfterNext(t)),this.forLoopStack[t]!=null&&(this.forLoopStack=this.forLoopStack.filter(h=>h==t)),this.forLoopStack.push(t),this.forLoops[t]={$next:h=>{h&&t!=h&&this.runtimeError(`I executed NEXT "${h}", but the last FOR was for "${t}".`),this.vars[t]+=i;var c=o();c?(this.forLoopStack.pop(),delete this.forLoops[t]):this.curpc=(a!=null&&this.label2pc[a]||s)+1,this.trace&&console.log(`NEXT ${t}: ${this.vars[t]} TO ${r} STEP ${i} DONE=${c}`)}}}nextForLoop(t){var e=this.forLoops[t||this.opts.optionalNextVar&&this.forLoopStack[this.forLoopStack.length-1]];e||this.runtimeError("I couldn't find a matching FOR for this NEXT."),e.$next(t)}whileLoop(t){t?this.whileLoops.push(this.curpc-1):this.skipToAfterWend()}nextWhileLoop(){var t=this.whileLoops.pop();t==null?this.runtimeError("I couldn't find a matching WHILE for this WEND."):this.curpc=t}assign(t,e,r){return r&&t.endsWith("$")?this.checkValue(this.convert(t,e),t):t.endsWith("$")?this.convertToString(e,t):this.convertToNumber(e,t)}convert(t,e){return t.endsWith("$")?e==null?"":e.toString():typeof e=="number"?e:parseFloat(e+"")}convertToString(t,e){if(typeof t!="string")this.runtimeError(`I can't convert ${t} to a string.`);else return t}convertToNumber(t,e){if(typeof t!="number")this.runtimeError(`I can't convert ${t} to a number.`);else return this.checkNum(t)}dimArray(t,...e){if(e=e.map(Math.round),this.arrays[t]!=null){if(this.opts.staticArrays)return;this.runtimeError(`I already dimensioned this array (${t}) earlier.`)}var r=this.getTotalArrayLength(e);r>this.opts.maxArrayElements&&this.runtimeError("I can't create an array with this many elements.");var i=t.endsWith("$"),n=i?Array:Float64Array;if(e.length==1)this.arrays[t]=new n(e[0]+1);else if(e.length==2){this.arrays[t]=new Array(e[0]+1);for(var s=0;s<e[0]+1;s++)this.arrays[t][s]=new n(e[1]+1)}else this.runtimeError("I only support arrays of one or two dimensions.")}getTotalArrayLength(t){for(var e=1,r=0;r<t.length;r++)t[r]<this.opts.defaultArrayBase&&this.runtimeError(`I can't create an array with a dimension less than ${this.opts.defaultArrayBase}.`),e*=t[r];return e}getArray(t,e){return this.arrays[t]||(this.opts.defaultArraySize==0&&this.dialectError("automatically declare arrays without a DIM statement (or did you mean to call a function?)"),e==1?this.dimArray(t,this.opts.defaultArraySize-1):e==2?this.dimArray(t,this.opts.defaultArraySize-1,this.opts.defaultArraySize-1):this.runtimeError("I only support arrays of one or two dimensions.")),this.arrays[t]}arrayGet(t,...e){var r=this.getArray(t,e.length);e=e.map(this.ROUND.bind(this));for(var i=r,n=0;n<e.length;n++){var s=e[n];m(i)||this.runtimeError(`I tried to lookup ${t}(${e}) but used too many dimensions.`),s<this.opts.defaultArrayBase&&this.runtimeError(`I tried to lookup ${t}(${e}) but an index was less than ${this.opts.defaultArrayBase}.`),s>=i.length&&this.runtimeError(`I tried to lookup ${t}(${e}) but it exceeded the dimensions of the array.`),i=i[e[n]]}return m(i)&&this.runtimeError(`I tried to lookup ${t}(${e}) but used too few dimensions.`),i}modifyStringSlice(t,e,r,i){return t=t||"",this.checkString(t),this.checkString(e),i||(i=r),r=this.ROUND(r),i=this.ROUND(i),r<1&&this.dialectError("accept a string slice index less than 1"),i<r&&this.dialectError("accept a string slice index less than the starting index"),(t+" ".repeat(r)).substr(0,r-1)+e.substr(0,i+1-r)+t.substr(i)}getStringSlice(t,e,r){return t=this.checkString(t),e=this.ROUND(e),e<1&&this.dialectError("accept a string slice index less than 1"),r!=null?(r=this.ROUND(r),r<e&&this.dialectError("accept a string slice index less than the starting index"),t.substr(e-1,r+1-e)):t.substr(e-1)}checkOnGoto(t,e){return t=this.ROUND(t),t<0&&this.runtimeError(`I needed a number between 1 and ${e.length}, but I got ${t}.`),this.opts.checkOnGotoIndex&&(t<1||t>e.length)&&this.runtimeError(`I needed a number between 1 and ${e.length}, but I got ${t}.`),t<1||t>e.length?0:t}onGotoLabel(t,...e){t=this.checkOnGoto(t,e),t&&this.gotoLabel(e[t-1])}onGosubLabel(t,...e){t=this.checkOnGoto(t,e),t&&this.gosubLabel(e[t-1])}nextDatum(){return this.dataptr>=this.datums.length&&this.runtimeError("I tried to READ, but ran out of data."),this.datums[this.dataptr++].value}do__PRINT(t){var e="";for(var r of t.args){var i=this.expr2js(r),n=i.name;e+=`this.printExpr(this.checkValue(${i}, ${JSON.stringify(n)}));`}return e}preInput(){this.running=!1,this.curpc--}postInput(t){t&&this.curpc++,this.running=!0,this.resume()}do__INPUT(t){var e=t.prompt!=null?this.expr2js(t.prompt):'""',r=t.elapsed!=null?this.assign2js(t.elapsed):"let ___",i="";return t.args.forEach((n,s)=>{var a=this.assign2js(n);i+=`
            var value = this.convert(${JSON.stringify(n.name)}, response.vals[${s}]);
            valid &= this.isValid(value);
            ${a} = value;
            `}),`this.preInput();
                this.input(${e}, ${t.args.length}).then((response) => {
                    let valid = 1;
                    ${i}
                    this.postInput(valid);
                    this.column = 0; // assume linefeed
                    ${r} = response.elapsed;
                })`}do__LET(t){var e=this.expr2js(t.right),r=`let _right = ${e};`;for(var i of t.lexprs)if(this.opts.arraysContainChars&&i.args&&i.name.endsWith("$"))r+=`this.globals.${i.name} = this.modifyStringSlice(this.vars.${i.name}, _right, `,r+=i.args.map(s=>this.expr2js(s)).join(", "),r+=");";else{var n=this.assign2js(i);r+=`${n} = this.assign(${JSON.stringify(i.name)}, _right);`}return r}do__FOR(t){var e=JSON.stringify(t.lexpr.name),r=this.expr2js(t.initial),i=this.expr2js(t.target),n=t.step?this.expr2js(t.step):"null";return`this.startForLoop(${e}, ${r}, ${i}, ${n}, ${t.endpc})`}do__NEXT(t){var e=t.lexpr&&JSON.stringify(t.lexpr.name);return`this.nextForLoop(${e})`}do__IF(t){var e=this.expr2js(t.cond);return t.endpc!=null?`if (!(${e})) { this.curpc = ${t.endpc}; }`:`if (!(${e})) { this.skipToElse(); }`}do__ELSE(t){return t.endpc!=null?`this.curpc = ${t.endpc}`:"this.skipToEOL()"}do__WHILE(t){var e=this.expr2js(t.cond);return t.endpc!=null?`if (!(${e})) { this.curpc = ${t.endpc+1}; }`:`this.whileLoop(${e})`}do__WEND(t){return t.startpc!=null?`this.curpc = ${t.startpc}`:"this.nextWhileLoop()"}do__DEF(t){var e=[];for(var r of t.lexpr.args||[])y(r)?e.push(r.name):this.runtimeError("I found a DEF statement with arguments other than variable names.");var i=this.expr2js(t.def,{locals:e});return`this.defs.${t.lexpr.name} = function(${e.join(",")}) { return ${i}; }.bind(this)`}_DIM(t){if(this.opts.arraysContainChars&&t.name.endsWith("$"))return"";var e="";for(var r of t.args)e+=", "+this.expr2js(r,{isconst:this.opts.staticArrays});return`this.dimArray(${JSON.stringify(t.name)}${e});`}do__DIM(t){if(!this.opts.staticArrays){var e="";return t.args.forEach(r=>e+=this._DIM(r)),e}}do__GOTO(t){var e=this.expr2js(t.label);return`this.gotoLabel(${e})`}do__GOSUB(t){var e=this.expr2js(t.label);return`this.gosubLabel(${e})`}do__RETURN(t){return"this.returnFromGosub()"}do__ONGOTO(t){var e=this.expr2js(t.expr),r=t.labels.map(i=>this.expr2js(i,{isconst:!0})).join(", ");return t.command=="ONGOTO"?`this.onGotoLabel(${e}, ${r})`:`this.onGosubLabel(${e}, ${r})`}do__ONGOSUB(t){return this.do__ONGOTO(t)}do__DATA(){}do__READ(t){var e="";return t.args.forEach(r=>{e+=`${this.assign2js(r)} = this.assign(${JSON.stringify(r.name)}, this.nextDatum(), true);`}),e}do__RESTORE(t){return t.label!=null?`this.dataptr = this.label2dataptr[${this.expr2js(t.label,{isconst:!0})}] || 0`:"this.dataptr = 0"}do__END(){return"this.skipToEOF()"}do__STOP(){return"this.skipToEOF()"}do__OPTION(t){}do__POP(){return"this.popReturnStack()"}do__GET(t){var e=this.assign2js(t.lexpr);return`this.preInput();
                this.input().then((vals) => {
                    ${e} = this.convert(${JSON.stringify(t.lexpr.name)}, vals[0]);
                    this.postInput(true);
                })`}do__CLEAR(){return"this.clearVars()"}do__RANDOMIZE(){return"this.rng.randomize()"}do__CHANGE(t){var e=t.dest.name.endsWith("$");if(e){let r=t.src.name||this.runtimeError("I can only change to a string from an array."),i=this.assign2js(t.dest);return`
            let arrname = ${JSON.stringify(r)};
            let len = this.arrayGet(arrname, 0);
            let s = '';
            for (let i=0; i<len; i++) {
                s += String.fromCharCode(this.arrayGet(arrname, i+1));
            }
            ${i} = s;
            `}else{let r=this.expr2js(t.src),i=this.array2js(t.dest);return`
            let src = ${r}+"";
            ${i}[0] = src.length;
            for (let i=0; i<src.length; i++) {
                ${i}[i+1] = src.charCodeAt(i);
            }
            `}}do__CONVERT(t){var e=t.dest.name.endsWith("$");let r=this.expr2js(t.src),i=this.assign2js(t.dest);return e?`${i} = this.valueToString(${r}, false)`:`${i} = this.VAL(${r})`}do__SUB(t){return this.subroutines[t.lexpr.name]=t,`this.curpc = ${t.endpc}`}do__CALL(t){var e=this.subroutines[t.call.name];e==null&&this.runtimeError(`I can't find a subroutine named "${t.call.name}".`);var r=e.lexpr.args||[],i=t.call.args||[];r.length!=i.length&&this.runtimeError(`I tried to call ${t.call.name} with the wrong number of parameters.`);var n="";n+=`this.gosubLabel(${JSON.stringify(t.call.name)});`,n+="this.newLocalScope();";for(var s=0;s<r.length;s++){var a=r[s];n+=`this.vars.${a.name} = ${this.expr2js(i[s])};`}return n}isValid(t){return typeof t=="number"&&!isNaN(t)&&(!this.opts.checkOverflow||isFinite(t))?!0:typeof t=="string"}checkValue(t,e){if(typeof t!="number"&&typeof t!="string"){if(t==null&&this.opts.defaultValues)return e.endsWith("$")?"":0;e!=null&&t==null?this.runtimeError(`I haven't assigned a value to ${e}.`):e!=null?this.runtimeError(`I got an invalid value for ${e}: ${t}`):this.runtimeError(`I got an invalid value: ${t}`)}return t}getDef(t){var e=this.defs[t];return e||this.runtimeError(`I haven't run a DEF statement for ${t}.`),e}checkNum(t){return this.checkValue(t,"this"),t===1/0&&this.runtimeError("I computed a number too big to store."),isNaN(t)&&this.runtimeError("I computed an invalid number."),t}checkString(t){return this.checkValue(t,"this"),typeof t!="string"?this.runtimeError("I expected a string here."):t.length>this.opts.maxStringLength&&this.dialectError(`create strings longer than ${this.opts.maxStringLength} characters`),t}add(t,e){if(typeof t=="number"&&typeof e=="number")return this.checkNum(t+e);if(this.opts.stringConcat)return this.checkString(t+e);this.dialectError('use the "+" operator to concatenate strings')}sub(t,e){return this.checkNum(t-e)}mul(t,e){return this.checkNum(t*e)}div(t,e){return e==0&&this.runtimeError("I can't divide by zero."),this.checkNum(t/e)}idiv(t,e){return this.FIX(this.INT(t)/this.INT(e))}mod(t,e){return this.checkNum(t%e)}pow(t,e){return t==0&&e<0&&this.runtimeError("I can't raise zero to a negative power."),this.checkNum(Math.pow(t,e))}band(t,e){return t&e}bor(t,e){return t|e}bnot(t){return~t}bxor(t,e){return t^e}bimp(t,e){return this.bor(this.bnot(t),e)}beqv(t,e){return this.bnot(this.bxor(t,e))}land(t,e){return t&&e?this.opts.bitwiseLogic?-1:1:0}lor(t,e){return t||e?this.opts.bitwiseLogic?-1:1:0}lnot(t){return t?0:this.opts.bitwiseLogic?-1:1}neg(t){return-t}eq(t,e){return t==e?this.opts.bitwiseLogic?-1:1:0}ne(t,e){return t!=e?this.opts.bitwiseLogic?-1:1:0}lt(t,e){return t<e?this.opts.bitwiseLogic?-1:1:0}gt(t,e){return t>e?this.opts.bitwiseLogic?-1:1:0}le(t,e){return t<=e?this.opts.bitwiseLogic?-1:1:0}ge(t,e){return t>=e?this.opts.bitwiseLogic?-1:1:0}min(t,e){return t<e?t:e}max(t,e){return t>e?t:e}ABS(t){return this.checkNum(Math.abs(t))}ASC(t){return t=this.checkString(t),t==""&&this.runtimeError("I tried to call ASC() on an empty string."),t.charCodeAt(0)}ATN(t){return this.checkNum(Math.atan(t))}CHR$(t){return String.fromCharCode(this.checkNum(t))}CINT(t){return this.ROUND(t)}COS(t){return this.checkNum(Math.cos(t))}COT(t){return this.checkNum(1/Math.tan(t))}CTL(t){return this.CHR$(t)}EXP(t){return this.checkNum(Math.exp(t))}FIX(t){return this.checkNum(t<0?Math.ceil(t):Math.floor(t))}HEX$(t){return this.ROUND(t).toString(16)}INSTR(t,e,r){return r!=null?this.checkString(e).indexOf(this.checkString(r),this.checkNum(t)-1)+1:this.checkString(t).indexOf(this.checkString(e))+1}INT(t){return this.checkNum(Math.floor(t))}LEFT$(t,e){return t=this.checkString(t),e=this.ROUND(e),t.substr(0,e)}LEN(t){return this.checkString(t).length}LIN(t){return this.STRING$(t,`
`)}LOG(t){return t==0&&this.runtimeError(`I can't take the logarithm of zero (${t}).`),t<0&&this.runtimeError(`I can't take the logarithm of a negative number (${t}).`),this.checkNum(Math.log(t))}LOG10(t){return t==0&&this.runtimeError(`I can't take the logarithm of zero (${t}).`),t<0&&this.runtimeError(`I can't take the logarithm of a negative number (${t}).`),this.checkNum(Math.log10(t))}MID$(t,e,r){return t=this.checkString(t),r||(r=t.length),e=this.ROUND(e),r=this.ROUND(r),e<1&&this.runtimeError("I can't compute MID$ if the starting index is less than 1."),t.substr(e-1,r)}OCT$(t){return this.ROUND(t).toString(8)}PI(){return Math.PI}POS(t,e){return typeof t=="string"&&typeof e=="string"?t.indexOf(e)>=0+1:this.column+1}RIGHT$(t,e){return t=this.checkString(t),e=this.ROUND(e),t.substr(t.length-e,e)}RND(t){return t<0&&this.rng.seedfloat(t),this.rng.next()}ROUND(t){return this.checkNum(Math.round(t))}SGN(t){return this.checkNum(t),t<0?-1:t>0?1:0}SIN(t){return this.checkNum(Math.sin(t))}SPACE$(t){return this.STRING$(t," ")}SPC(t){return this.SPACE$(t)}SQR(t){return t<0&&this.runtimeError(`I can't take the square root of a negative number (${t}).`),this.checkNum(Math.sqrt(t))}STR$(t){return this.valueToString(this.checkNum(t),!1)}STRING$(t,e){return t=this.ROUND(t),t<=0?"":(t>this.opts.maxStringLength&&this.dialectError(`create a string longer than ${this.opts.maxStringLength} characters`),typeof e=="string"?e.substr(0,1).repeat(t):String.fromCharCode(e).repeat(t))}TAB(t){t<1&&(t=1);var e=this.ROUND(t)-1-this.column;return this.SPACE$(e)}TAN(t){return this.checkNum(Math.tan(t))}TIM(t){var e=new Date;switch(this.ROUND(t)){case 0:return e.getMinutes();case 1:return e.getHours();case 2:var r=[0,31,59,90,120,151,181,212,243,273,304,334],i=e.getMonth(),n=e.getDate(),s=r[i]+n,a=(e.getFullYear()&3)==0;return i>1&&a&&s++,s;case 3:return e.getFullYear()%100;case 4:return e.getSeconds();default:return 0}}TIMER(){return Date.now()/1e3}UPS$(t){return this.checkString(t).toUpperCase()}VAL(t){var e=parseFloat(this.checkString(t));return isNaN(e)?0:e}LPAD$(t,e){for(t=this.checkString(t);t.length<e;)t=" "+t;return t}RPAD$(t,e){for(t=this.checkString(t);t.length<e;)t=t+" ";return t}NFORMAT$(t,e){var r=this.float2str(t,e);return e>0?this.LPAD$(r,e):this.RPAD$(r,-e)}};var L=[{id:"23match.bas",name:"23match"},{id:"3dplot.bas",name:"3dplot"},{id:"aceyducey.bas",name:"aceyducey"},{id:"amazing.bas",name:"amazing"},{id:"animal.bas",name:"animal"},{id:"awari.bas",name:"awari"},{id:"bagels.bas",name:"bagels"},{id:"banner.bas",name:"banner"},{id:"basketball.bas",name:"basketball"},{id:"batnum.bas",name:"batnum"},{id:"battle.bas",name:"battle"},{id:"blackjack.bas",name:"blackjack"},{id:"bombardment.bas",name:"bombardment"},{id:"bombsaway.bas",name:"bombsaway"},{id:"bounce.bas",name:"bounce"},{id:"bowling.bas",name:"bowling"},{id:"boxing.bas",name:"boxing"},{id:"bug.bas",name:"bug"},{id:"bullfight.bas",name:"bullfight"},{id:"bullseye.bas",name:"bullseye"},{id:"bunny.bas",name:"bunny"},{id:"buzzword.bas",name:"buzzword"},{id:"calendar.bas",name:"calendar"},{id:"change.bas",name:"change"},{id:"checkers.bas",name:"checkers"},{id:"chemist.bas",name:"chemist"},{id:"chomp.bas",name:"chomp"},{id:"civilwar.bas",name:"civilwar"},{id:"combat.bas",name:"combat"},{id:"craps.bas",name:"craps"},{id:"cube.bas",name:"cube"},{id:"depthcharge.bas",name:"depthcharge"},{id:"diamond.bas",name:"diamond"},{id:"dice.bas",name:"dice"},{id:"digits.bas",name:"digits"},{id:"evenwins.bas",name:"evenwins"},{id:"flipflop.bas",name:"flipflop"},{id:"football.bas",name:"football"},{id:"ftball.bas",name:"ftball"},{id:"gameofevenwins.bas",name:"gameofevenwins"},{id:"golf.bas",name:"golf"},{id:"gomoko.bas",name:"gomoko"},{id:"guess.bas",name:"guess"},{id:"gunner.bas",name:"gunner"},{id:"hammurabi.bas",name:"hammurabi"},{id:"hangman.bas",name:"hangman"},{id:"haunted.bas",name:"haunted"},{id:"hello.bas",name:"hello"},{id:"hexapawn.bas",name:"hexapawn"},{id:"hi-lo.bas",name:"hi-lo"},{id:"highiq.bas",name:"highiq"},{id:"hockey.bas",name:"hockey"},{id:"horserace.bas",name:"horserace"},{id:"hurkle.bas",name:"hurkle"},{id:"kinema.bas",name:"kinema"},{id:"lander.bas",name:"lander"},{id:"lem.bas",name:"lem"},{id:"letter.bas",name:"letter"},{id:"life.bas",name:"life"},{id:"litquiz.bas",name:"litquiz"},{id:"love.bas",name:"love"},{id:"lunar.bas",name:"lunar"},{id:"mastermind.bas",name:"mastermind"},{id:"mathdice.bas",name:"mathdice"},{id:"mortgage.bas",name:"mortgage"},{id:"mugwump.bas",name:"mugwump"},{id:"name.bas",name:"name"},{id:"nicomachus.bas",name:"nicomachus"},{id:"nim.bas",name:"nim"},{id:"number.bas",name:"number"},{id:"onecheck.bas",name:"onecheck"},{id:"orbit.bas",name:"orbit"},{id:"pizza.bas",name:"pizza"},{id:"poetry.bas",name:"poetry"},{id:"poker.bas",name:"poker"},{id:"qubit.bas",name:"qubit"},{id:"queen.bas",name:"queen"},{id:"reverse.bas",name:"reverse"},{id:"rocket.bas",name:"rocket"},{id:"rockscissors.bas",name:"rockscissors"},{id:"roulette.bas",name:"roulette"},{id:"russianroulette.bas",name:"russianroulette"},{id:"salvo.bas",name:"salvo"},{id:"sieve.bas",name:"sieve"},{id:"sinewave.bas",name:"sinewave"},{id:"slalom.bas",name:"slalom"},{id:"slots.bas",name:"slots"},{id:"splat.bas",name:"splat"},{id:"stars.bas",name:"stars"},{id:"startrader.bas",name:"startrader"},{id:"startrek.bas",name:"startrek"},{id:"startrekins.bas",name:"startrekins"},{id:"stockmarket.bas",name:"stockmarket"},{id:"suite.bas",name:"suite"},{id:"synonym.bas",name:"synonym"},{id:"target.bas",name:"target"},{id:"tictactoe.bas",name:"tictactoe"},{id:"tower.bas",name:"tower"},{id:"train.bas",name:"train"},{id:"trap.bas",name:"trap"},{id:"tutorial.bas",name:"tutorial"},{id:"war.bas",name:"war"},{id:"weekday.bas",name:"weekday"},{id:"word.bas",name:"word"},{id:"wumpus.bas",name:"wumpus"}],k=class{constructor(t){this.clock=0;this.hotReload=!0;this.animcount=0;this.internalFiles={};this.mainElement=t,t.style.overflowY="auto"}async start(){this.runtime=new l,this.runtime.reset();var t=this.mainElement,e=$('<div id="gameport" style="margin-top:calc(100vh - 8em)"/>').appendTo(t),r=$('<div id="windowport" class="transcript transcript-style-2"/>').appendTo(e),i=$('<div id="inputport" class="transcript-bottom"/>').appendTo(e),n=$('<input class="transcript-input transcript-style-2" type="text" style="max-width:95%"/>').appendTo(i);this.tty=new v(r[0],!0,n[0]),this.tty.keepinput=!0,this.tty.splitInput=!0,this.tty.keephandler=!1,this.tty.hideinput(),this.tty.scrolldiv=t,this.tty.bell=new Audio("res/ttybell.mp3"),this.runtime.input=async(s,a)=>new Promise((o,h)=>{s!=null?(this.tty.addtext(s,0),this.tty.addtext("? ",0),this.tty.waitingfor="line"):this.tty.waitingfor="char",this.tty.focusinput(),this.tty.resolveInput=o}),this.timer=new g(60,this.animate.bind(this)),this.resize=()=>{this.tty.resize(80)},this.resize(),this.runtime.print=s=>{this.animcount=0,this.tty.print(s),this.transcript.push(s)},this.runtime.resume=this.resume.bind(this)}animate(){if(!this.tty.isBusy()){var t=this.program.opts.commandsPerSec||1e3;for(this.animcount+=t/60;this.runtime.running&&this.animcount-- >0&&this.advance(););}}advance(t){if(this.runtime.running){if(this.checkDebugTrap())return 0;var e=this.runtime.step();return e||(this.pause(),this.runtime.exited&&(this.exitmsg(),this.didExit())),this.clock++,1}else return 0}exitmsg(){this.tty.print(`

`),this.tty.addtext("*** END OF PROGRAM ***",1),this.tty.showPrintHead(!1)}loadROM(t,e){var r=this.runtime.exited;this.program=e;var i=this.runtime.load(e);this.tty.uppercaseOnly=!0,f.input=this.program.opts.uppercaseOnly?n=>n.toUpperCase():null,(!this.hotReload||r||!i)&&this.reset()}getROMExtension(){return".json"}reset(){this.tty.clear(),this.runtime.reset(),this.clock=0,this.transcript=[]}pause(){this.timer.stop()}resume(){this.isBlocked()||(this.animcount=0,this.timer.start())}isBlocked(){return this.tty.waitingfor!=null||this.runtime.exited}isRunning(){return this.timer.isRunning()}getDefaultExtension(){return".bas"}getToolForFilename(){return"basic"}getPresets(){return L}getPC(){return this.runtime.curpc}getSP(){return 4096-this.runtime.returnStack.length}isStable(){return!0}getCPUState(){return{PC:this.getPC(),SP:this.getSP()}}saveState(){return{c:this.getCPUState(),rt:this.runtime.saveState()}}loadState(t){this.runtime.loadState(t)}getDebugTree(){return{CurrentLine:this.runtime.getCurrentLabel(),Variables:this.runtime.vars,Arrays:this.runtime.arrays,Functions:this.runtime.defs,ForLoops:this.runtime.forLoops,WhileLoops:this.runtime.whileLoops,ReturnStack:this.runtime.returnStack,NextDatum:this.runtime.datums[this.runtime.dataptr],Clock:this.clock,Options:this.runtime.opts,Internals:this.runtime}}inspect(t){let e=this.runtime.vars[t];if(e!=null)return`${t} = ${e}`}showHelp(){return"https://8bitworkshop.com/docs/platforms/basic/"}getDebugCategories(){return["Variables"]}getDebugInfo(t,e){switch(t){case"Variables":return this.varsToLongString()}}varsToLongString(){var t="",e=Object.keys(this.runtime.vars);e.sort();for(var r of e){var i=this.runtime.vars[r],n=JSON.stringify(i);n.length>24&&(n=`${n.substr(0,24)}...(${n.length})`),t+=b(r,3)+" = "+n+`
`}return t}setupDebug(t){this.onBreakpointHit=t}clearDebug(){this.onBreakpointHit=null,this.debugTrap=null}checkDebugTrap(){return this.debugTrap&&this.debugTrap()?(this.pause(),this.break(),!0):!1}break(){this.onBreakpointHit&&this.onBreakpointHit(this.saveState())}step(){var t=this.clock;this.debugTrap=()=>this.clock>t,this.resume()}stepOver(){var t=this.runtime.getStatement();if(t&&(t.command=="GOSUB"||t.command=="ONGOSUB")){var e=this.getPC()+1;this.runEval(()=>this.getPC()==e)}else this.step()}runUntilReturn(){var t=this.getSP();this.runEval(()=>this.getSP()>t)}runEval(t){this.debugTrap=()=>t(this.getCPUState()),this.resume()}restartAtPC(t){return t=Math.round(t),t>=0&&t<this.runtime.allstmts.length?(this.runtime.curpc=t,this.tty.cancelinput(),this.clock=0,!0):!1}readFile(t){return this.internalFiles[t]}writeFile(t,e){return this.internalFiles[t]=e,!0}didExit(){this.internalFiles["stdout.txt"]=this.transcript.join(""),S()}};p.basic=k;
//# sourceMappingURL=basic-MFOFZMH6.js.map
