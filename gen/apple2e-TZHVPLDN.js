import{H as B}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";var L=[{id:"hello.bas",name:"Hello World (BASIC)",category:"BASIC Tutorial"},{id:"colors.bas",name:"Color Demo (BASIC)"},{id:"graphics.bas",name:"Graphics Demo (BASIC)"},{id:"keyboard.bas",name:"Keyboard Demo (BASIC)"},{id:"game.bas",name:"Simple Game (BASIC)"}],I=class{constructor(e){this.iframe=null;this.emulatorReady=!1;this.lastLoadedProgram=null;this.isLoadingProgram=!1;this.currentDiskBlob=null;this.currentBinaryBlob=null;this.mainElement=e,window.addEventListener("message",t=>{t.data&&t.data.type==="apple2e_ready"?(console.log("Apple2EPlatform: Emulator ready"),this.emulatorReady=!0,setTimeout(()=>{console.log("Apple2EPlatform: Emulator fully ready, can accept ROM loads")},200)):t.data&&t.data.type==="apple2e_error"&&(console.error("Apple2EPlatform: Emulator error:",t.data.error),this.emulatorReady=!1)})}getName(){return"Apple IIe"}getDescription(){return"Apple IIe - 6502-based personal computer"}async init(){console.log("Apple2EPlatform init() called")}start(){console.log("Apple2EPlatform start() called"),this.iframe=document.createElement("iframe"),this.iframe.id="apple2e-iframe",this.iframe.style.width="100%",this.iframe.style.height="600px",this.iframe.style.border="1px solid #ccc",this.iframe.style.backgroundColor="#000",this.iframe.setAttribute("tabindex","0"),console.log("Apple2EPlatform: Iframe will handle its own events"),this.iframe.addEventListener("focus",r=>{r.stopPropagation()},!0),this.iframe.addEventListener("click",r=>{r.stopPropagation()},!0),this.mainElement.innerHTML="",this.mainElement.appendChild(this.iframe);let e=`?t=${Date.now()}`;this.iframe.src=`apple2e-iframe.html${e}`,this.mainElement.style.pointerEvents="auto",this.mainElement.style.userSelect="none",this.iframe.style.pointerEvents="auto",this.iframe.style.border="1px solid #ccc",console.log("Apple2EPlatform: Iframe created, clicks should pass through to iframe"),this.iframe.src="apple2e-iframe.html",console.log("Apple2EPlatform: iframe created and loading");let t=setInterval(()=>{this.emulatorReady&&this.iframe&&this.iframe.contentWindow&&(clearInterval(t),console.log("Apple2EPlatform: Auto-resetting emulator on start for clean BASIC prompt"),this.reset())},100);setTimeout(()=>clearInterval(t),1e4)}stop(){console.log("Apple2EPlatform stop() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"stop"},"*")}reset(){console.log("Apple2EPlatform reset() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"reset"},"*")}isRunning(){return this.emulatorReady}getToolForFilename(e){let t=e.toLowerCase();return t.endsWith(".bas")?"applesoftbasic":t.endsWith(".c")||t.endsWith(".h")?"cc65":"applesoftbasic"}getDefaultExtension(){return".bas"}getPresets(){return L}getDownloadFile(){if(console.log("Apple2EPlatform: getDownloadFile() called, currentBinaryBlob:",this.currentBinaryBlob?`${this.currentBinaryBlob.size} bytes`:"null"),this.currentBinaryBlob)return{extension:".bin",blob:this.currentBinaryBlob};console.log("Apple2EPlatform: No binary blob available for download")}getDownloadDiskFile(){if(console.log("Apple2EPlatform: getDownloadDiskFile() called, currentDiskBlob:",this.currentDiskBlob?`${this.currentDiskBlob.size} bytes`:"null"),this.currentDiskBlob)return{extension:".dsk",blob:this.currentDiskBlob};console.log("Apple2EPlatform: No disk blob available for download")}pause(){console.log("Apple2EPlatform pause() called"),this.iframe&&this.iframe.contentWindow}break(){console.log("Apple2EPlatform break() called (Ctrl+C / BRK)"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"break"},"*")}resume(){console.log("Apple2EPlatform resume() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"run"},"*");let e=this.getApple2API();e&&e.apple2&&!e.apple2.isRunning()&&e.apple2.run()}getApple2API(){if(!this.iframe||!this.iframe.contentWindow)return console.warn("Apple2EPlatform: iframe not available"),null;try{let e=this.iframe.contentWindow;return!e.apple2&&!e.APPLE2_API?(console.warn("Apple2EPlatform: apple2 API not available in iframe yet"),null):{get apple2(){var t;return e.apple2||((t=e.APPLE2_API)==null?void 0:t.apple2)},getIO:()=>{var s;let t=e.apple2||((s=e.APPLE2_API)==null?void 0:s.apple2);if(!t)return console.error("Apple2EPlatform: Cannot getIO - emulator not available"),null;let r=t.getIO();return r?(console.log("Apple2EPlatform: getIO() returned:",{hasSetKeyBuffer:typeof r.setKeyBuffer=="function",hasKeyDown:typeof r.keyDown=="function",methods:Object.keys(r).filter(l=>typeof r[l]=="function")}),r):(console.error("Apple2EPlatform: getIO() returned null"),null)},getCPU:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);return t?t.getCPU():null},setAcceleration:t=>{let r=e.APPLE2_API;r&&r.setAcceleration?r.setAcceleration(t):console.error("Apple2EPlatform: setAcceleration not available")},getAcceleration:()=>{let t=e.APPLE2_API;return t&&t.getAcceleration?t.getAcceleration():!1},reset:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);return t?(console.log("Apple2EPlatform: Resetting emulator (enters BASIC)..."),t.reset(),setTimeout(()=>{t.isRunning()||(console.log("Apple2EPlatform: Starting emulator after reset"),t.run()),console.log("Apple2EPlatform: Reset complete, BASIC prompt should be ready")},100),!0):(console.error("Apple2EPlatform: Cannot reset - emulator not available"),!1)},run:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);t&&t.run()},stop:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);t&&t.stop()},isRunning:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);return t?t.isRunning():!1},type:t=>{var a;let r=e.apple2||((a=e.APPLE2_API)==null?void 0:a.apple2);if(!r)return console.error("Apple2EPlatform: Cannot type - emulator not available"),console.log("Available in iframe:",{apple2:!!e.apple2,APPLE2_API:!!e.APPLE2_API}),!1;console.log("Apple2EPlatform: Typing text:",t.substring(0,50)),console.log("Apple2EPlatform: Emulator running?",r.isRunning());let s=r.getIO();if(!s)return console.error("Apple2EPlatform: Cannot type - getIO() returned null"),!1;if(!s.setKeyBuffer)return console.error("Apple2EPlatform: Cannot type - io.setKeyBuffer is not a function"),console.log("IO object:",Object.keys(s)),!1;console.log("Apple2EPlatform: Resetting emulator to enter BASIC..."),r.reset(),r.isRunning()||(console.log("Apple2EPlatform: Starting emulator after reset..."),r.run()),console.log("Apple2EPlatform: Waiting for BASIC prompt..."),setTimeout(()=>{l(s,t)},1200);function l(p,c){console.log("Apple2EPlatform: Sending text:",JSON.stringify(c.substring(0,80)));try{let m=e.document.querySelector("#screen");m&&m.focus&&(m.focus(),console.log("Apple2EPlatform: Focused canvas in iframe for keyboard input"))}catch(o){console.warn("Apple2EPlatform: Could not focus canvas (cross-origin?):",o)}let n=c;/^\d+\s/.test(c.trim())&&(n=c.replace(/\r\n/g,"\r").replace(/\n/g,"\r"),n.startsWith("\r")||(n="\r"+n),n.endsWith("\r")||(n+="\r"),n+="RUN\r",console.log("Apple2EPlatform: Formatted BASIC program:",JSON.stringify(n.substring(0,100)))),setTimeout(()=>{try{p.setKeyBuffer(n),console.log("Apple2EPlatform: \u2705 setKeyBuffer called with formatted text"),console.log("Apple2EPlatform: Program sent to emulator"),setTimeout(()=>{var m;let o=e.apple2||((m=e.APPLE2_API)==null?void 0:m.apple2);o&&(console.log("Apple2EPlatform: Resetting emulator after program sent (for clean state)..."),o.reset(),o.isRunning()||o.run(),console.log("Apple2EPlatform: Reset complete, ready for next program"),setTimeout(()=>{this.lastLoadedProgram=null},500))},500)}catch(o){console.error("Apple2EPlatform: setKeyBuffer failed:",o)}},100)}return!0},getVideoModes:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);return t?t.getVideoModes():null},getStats:()=>{var r;let t=e.apple2||((r=e.APPLE2_API)==null?void 0:r.apple2);return t?t.getStats():null},break:()=>{var s;let t=e.apple2||((s=e.APPLE2_API)==null?void 0:s.apple2);if(!t)return console.error("Apple2EPlatform: Cannot break - emulator not available"),!1;if(this.iframe&&this.iframe.contentWindow)return console.log("Apple2EPlatform: Sending break command to iframe (will handle focus)"),this.iframe.contentWindow.postMessage({type:"break"},"*"),!0;let r=t.getIO();if(!r)return console.error("Apple2EPlatform: Cannot break - getIO() returned null"),!1;console.log("Apple2EPlatform: Sending BRK (Ctrl+C) to interrupt program...");try{return r.keyDown(3),setTimeout(()=>{r.keyUp&&r.keyUp()},50),console.log("Apple2EPlatform: \u2705 BRK sent"),!0}catch(l){return console.error("Apple2EPlatform: Error sending BRK:",l),!1}}}}catch(e){return console.error("Apple2EPlatform: Error accessing iframe API:",e),null}}loadROM(e,t){if(console.log("Apple2EPlatform loadROM() called",{title:e,romLength:t==null?void 0:t.length}),!t||t.length===0){console.warn("Apple2EPlatform: No ROM data provided");return}let r=new Uint8Array(t);this.currentBinaryBlob=new Blob([r],{type:"application/octet-stream"}),console.log(`Apple2EPlatform: Binary blob stored for download: ${this.currentBinaryBlob.size} bytes`),this.isCompiledBinary(t)?(console.log("Apple2EPlatform: Detected compiled binary, creating disk image"),this.loadCompiledProgram(e,t).catch(l=>{console.error("Apple2EPlatform: Error loading compiled program:",l)})):(console.log("Apple2EPlatform: Detected BASIC program, creating disk image"),this.loadBasicProgram(e,t).catch(l=>{console.error("Apple2EPlatform: Error loading BASIC program:",l)}))}isCompiledBinary(e){if(e.length<100)return!1;let t;try{t=new TextDecoder("utf-8",{fatal:!1}).decode(e)}catch(l){return!0}let r=t.trim();if(/^\d+\s/.test(r))return!1;let s=0;for(let l=0;l<Math.min(e.length,1e3);l++)e[l]<32&&e[l]!==10&&e[l]!==13&&e[l]!==9&&s++;return s>Math.min(e.length,1e3)*.1}createAppleIIDiskImage(e,t,r,s){let l=35,a=16,p=256,c=l*a*p,n=new Uint8Array(c);n.fill(0);let o=(i,f,g)=>{if(typeof f=="string")for(let d=0;d<f.length&&i+d<n.length;d++)n[i+d]=f.charCodeAt(d)&255;else if(typeof f=="number"){let d=g||1;for(let b=0;b<d&&i+b<n.length;b++)n[i+b]=f>>b*8&255}else if(f instanceof Uint8Array)for(let d=0;d<f.length&&i+d<n.length;d++)n[i+d]=f[d]};o(0,0),o(1,17),o(2,15),o(3,3),o(39,35),o(48,35),o(49,35);for(let i=0;i<16;i++){let f=4+Math.floor(i/8),g=i%8;n[f]|=1<<7-g}for(let i=0;i<16;i++){let f=6+Math.floor(i/8),g=i%8;n[f]|=1<<7-g}for(let i=0;i<16;i++){let f=8+Math.floor(i/8),g=i%8;n[f]|=1<<7-g}let m=Math.ceil(e.length/p),u=3,y=0,x=u,h=y;for(let i=0;i<m;i++){let f=4+Math.floor((x*16+h)/8),g=(x*16+h)%8;n[f]|=1<<7-g,h++,h>=16&&(h=0,x++)}let S=17,k=15,A=(S*a+k)*p;o(A+0,17),o(A+1,14),o(A+2,0),o(A+3,1),o(A+4,0);let P=A+11,C=(t.substring(0,30).toUpperCase()+"                    ").substring(0,30);o(P+0,C.substring(0,30)),o(P+30,u),o(P+31,y),o(P+32,128),o(P+33,m&255),o(P+34,m>>8&255);let E=(u*a+y)*p;o(E+0,r&255),o(E+1,r>>8&255),o(E+2,e);let w=E+2+e.length;return o(w+0,s&255),o(w+1,s>>8&255),console.log(`Apple2EPlatform: Created disk image: ${t}.BIN, ${m} sectors, ${e.length} bytes, Load: $${r.toString(16)}, Run: $${s.toString(16)}`),n}parseBinaryHeader(e){if(e.length>=58&&e[0]===0&&e[1]===5&&e[2]===22&&e[3]===0){let a=e[56]<<8|e[57],p=a,c=58,n=e.slice(c);return console.log(`Apple2EPlatform: Detected AppleSingle header - Load: $${a.toString(16)}, Size: ${n.length} bytes`),{loadAddress:a,runAddress:p,headerSize:c,programData:n}}if(e.length>=4){let a=e[0]|e[1]<<8,p=e[2]|e[3]<<8,c=a<49152&&a+p<77824&&(a===2051||(a&255)==0);if(p===e.length-4&&c){let n=a,o=a,m=4,u=e.slice(m);return console.log(`Apple2EPlatform: Detected DOS header - Load: $${n.toString(16)}, Size: ${u.length} bytes`),{loadAddress:n,runAddress:o,headerSize:m,programData:u}}}let t=2051,r=2051,s=0,l=e;return console.log(`Apple2EPlatform: No header detected, using default - Load: $${t.toString(16)}, Size: ${l.length} bytes`),{loadAddress:t,runAddress:r,headerSize:s,programData:l}}async loadBasicProgram(e,t){if(!this.iframe||!this.iframe.contentWindow){console.error("Apple2EPlatform: Cannot load program - iframe not available"),this.isLoadingProgram=!1;return}let r=e.replace(/\.[^.]*$/,"").toUpperCase().substring(0,8)||"PROGRAM",s=new TextDecoder().decode(t);console.log(`Apple2EPlatform: Creating bootable disk for BASIC program ${r}, ${s.length} bytes`),console.log("Apple2EPlatform: BASIC program preview:",s.substring(0,200));try{let l="https://ide.retrogamecoders.com";console.log("Apple2EPlatform: Calling PHP API to create disk with BASIC program...");let a=await fetch(`${l}/api/apple2/create_disk.php`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({basic:s,filename:r,loadAddress:0,runAddress:0,sessionID:`apple2_${Date.now()}`})});if(console.log(`Apple2EPlatform: API response status: ${a.status}`),!a.ok){let o=await a.text();throw console.error("Apple2EPlatform: API error response:",o),new Error(`API error: ${a.status} ${a.statusText} - ${o}`)}let p=await a.json();if(console.log("Apple2EPlatform: API result:",p),p.error)throw console.error("Apple2EPlatform: API returned error:",p.error),new Error(p.error);if(!p.disk)throw console.error("Apple2EPlatform: API result missing disk data:",p),new Error("API response missing disk data");let c=Uint8Array.from(atob(p.disk),o=>o.charCodeAt(0));console.log(`Apple2EPlatform: Bootable disk created: ${p.filename}, ${c.length} bytes`);let n=new ArrayBuffer(c.length);new Uint8Array(n).set(c),this.currentDiskBlob=new Blob([n],{type:"application/octet-stream"}),console.log(`Apple2EPlatform: Disk blob stored for download: ${this.currentDiskBlob.size} bytes`),console.log("Apple2EPlatform: currentDiskBlob is now:",this.currentDiskBlob?"set":"null"),this.iframe.contentWindow.postMessage({type:"load_disk",data:{drive:1,filename:p.filename,diskData:Array.from(c)}},"*"),setTimeout(()=>{this.isLoadingProgram=!1},5e3)}catch(l){console.error("Apple2EPlatform: Error creating bootable disk via PHP API:",l),console.error("Apple2EPlatform: Error details:",{message:l instanceof Error?l.message:String(l),stack:l instanceof Error?l.stack:void 0}),this.isLoadingProgram=!1}}async loadCompiledProgram(e,t){if(!this.iframe||!this.iframe.contentWindow){console.error("Apple2EPlatform: Cannot load program - iframe not available"),this.isLoadingProgram=!1;return}let{loadAddress:r,runAddress:s}=this.parseBinaryHeader(t),l=e.replace(/\.[^.]*$/,"").toUpperCase().substring(0,8)||"PROGRAM";console.log(`Apple2EPlatform: Creating bootable disk for ${l} - Load: $${r.toString(16)}, Run: $${s.toString(16)}, Size: ${t.length} bytes (full binary with header)`);try{let a="https://ide.retrogamecoders.com",p=btoa(String.fromCharCode(...t)),c=await fetch(`${a}/api/apple2/create_disk.php`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({binary:p,filename:l,loadAddress:r,runAddress:s,sessionID:`apple2_${Date.now()}`})});if(!c.ok)throw new Error(`API error: ${c.status} ${c.statusText}`);let n=await c.json();if(n.error)throw new Error(n.error);let o=Uint8Array.from(atob(n.disk),u=>u.charCodeAt(0));console.log(`Apple2EPlatform: Bootable disk created: ${n.filename}, ${o.length} bytes`);let m=new ArrayBuffer(o.length);new Uint8Array(m).set(o),this.currentDiskBlob=new Blob([m],{type:"application/octet-stream"}),console.log(`Apple2EPlatform: Disk blob stored for download: ${this.currentDiskBlob.size} bytes`),this.iframe.contentWindow.postMessage({type:"load_disk",data:{drive:1,filename:n.filename,diskData:Array.from(o)}},"*"),setTimeout(()=>{this.isLoadingProgram=!1},5e3)}catch(a){throw console.error("Apple2EPlatform: Error creating bootable disk via PHP API:",a),this.isLoadingProgram=!1,a}}sendROMToEmulator(e){if(!this.iframe||!this.iframe.contentWindow){console.error("Apple2EPlatform: Cannot send ROM - iframe not available"),this.isLoadingProgram=!1;return}let t=new TextDecoder().decode(e);console.log("Apple2EPlatform: Sending program to iframe:",t.substring(0,50)),this.iframe.contentWindow.postMessage({type:"load_basic",data:{program:t}},"*"),setTimeout(()=>{this.isLoadingProgram=!1},2e3)}getROMExtension(e){return".bas"}readAddress(e){return 0}writeAddress(e,t){}getMemoryMap(){return{main:[{name:"Zero Page RAM",start:0,size:256,type:"ram"},{name:"Line Input RAM",start:512,size:256,type:"ram"},{name:"Text/Lores Page 1",start:1024,size:1024,type:"ram"},{name:"Hires Page 1",start:8192,size:8192,type:"ram"},{name:"Hires Page 2",start:16384,size:8192,type:"ram"},{name:"I/O",start:49152,size:4096,type:"io"},{name:"ROM",start:53248,size:12288,type:"rom"}]}}showHelp(){return"https://github.com/whscullin/apple2js#readme"}};B.apple2e=I;var T=I;export{I as Apple2EPlatform,T as default};
//# sourceMappingURL=apple2e-TZHVPLDN.js.map
