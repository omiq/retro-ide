import{H as h}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";(function(){window.vic20_debug={generateIframeURL:(c,e=!0)=>{let o="vic20-iframe.html";if(e){let t=String.fromCharCode.apply(null,Array.from(c)),n=btoa(t);return`${o}?program=${encodeURIComponent(n)}`}else{let t=Array.from(c).map(n=>n.toString(16).padStart(2,"0")).join(" ");return`${o}?hex=${encodeURIComponent(t)}`}},openIframeWithCurrentProgram:()=>{var e;let c=(e=window.IDE)==null?void 0:e.getCurrentOutput();if(c&&c instanceof Uint8Array){let o=window.vic20_debug.generateIframeURL(c);return console.log("Opened VIC-20 iframe with current program:",o),o}else return console.error("No compiled program available. Compile first."),null},getCurrentProgramHex:()=>{var e;let c=(e=window.IDE)==null?void 0:e.getCurrentOutput();if(c&&c instanceof Uint8Array){let o=Array.from(c).map(t=>t.toString(16).padStart(2,"0")).join(" ");return console.log("Current program hex:",o),o}else return console.error("No compiled program available. Compile first."),null},getCurrentProgramInfo:()=>{var e;let c=(e=window.IDE)==null?void 0:e.getCurrentOutput();if(c&&c instanceof Uint8Array){if(console.log("Current program info:"),console.log("  Size:",c.length,"bytes"),console.log("  First 16 bytes:",Array.from(c.slice(0,16)).map(o=>o.toString(16).padStart(2,"0")).join(" ")),c.length>=2){let o=c[1]<<8|c[0];console.log("  Load address: 0x"+o.toString(16))}return{size:c.length,loadAddress:c.length>=2?c[1]<<8|c[0]:null,firstBytes:Array.from(c.slice(0,16))}}else return console.error("No compiled program available. Compile first."),null}},console.log("\u2705 VIC-20 debug functions added to window.vic20_debug"),console.log("Available functions:"),console.log("  - vic20_debug.generateIframeURL(programData, useBase64)"),console.log("  - vic20_debug.openIframeWithCurrentProgram()"),console.log("  - vic20_debug.getCurrentProgramHex()"),console.log("  - vic20_debug.getCurrentProgramInfo()")})();var f=class{constructor(){this.module=null;this.canvas=null;this.running=!1;this.programLoaded=!1;this.isLoadingProgram=!1;this.emulatorFocused=!1;this.cpu={getPC:()=>0,getSP:()=>0,isStable:()=>!0,saveState:()=>({PC:0,SP:0}),loadState:e=>{},reset:()=>{},connectMemoryBus:e=>{}};this.joymask0=0;this.joymask1=0;this.name="VIC-20 (chips-test)",this.description="VIC-20 emulator using chips-test WebAssembly"}getName(){return this.name}getDescription(){return this.description}async init(){try{console.log("Initializing chips-test VIC-20 emulator..."),this.canvas=document.createElement("canvas"),this.canvas.id="canvas",this.canvas.width=800,this.canvas.height=501,this.canvas.style.border="1px solid #333",this.canvas.style.width="100%",this.canvas.style.height="auto",this.canvas.style.maxWidth="800px",this.canvas.style.maxHeight="600px",this.canvas.style.outline="none",this.canvas.style.cursor="pointer";let e=document.getElementById("vic20-chips-div"),o=document.getElementById("vic20-chips-screen");e&&o?(o.appendChild(this.canvas),console.log("\u2705 Added VIC-20 canvas to pre-existing div")):(document.body.appendChild(this.canvas),console.log("\u2705 Added VIC-20 canvas to document body")),this.connectCanvasToEmulator(),this.addClickToFocusFunctionality(),this.addSimpleFocusProtection(),this.loadVIC20ScriptIfNeeded(),this.addCanvasDragAndDropListeners(),setTimeout(()=>{this.detectModule(),this.enableJoystickSupport()},1e3)}catch(e){console.error("Error initializing VIC-20 chips emulator:",e)}}loadVIC20ScriptIfNeeded(){if(typeof window.h!="undefined"){console.log("\u2705 VIC-20 script already loaded");return}if(document.querySelector('script[src*="vic20.js"]')){console.log("\u2705 VIC-20 script tag already exists, waiting for it to load");return}console.log("\u{1F527} Loading VIC-20 script...");let o=document.createElement("script");o.src=`res/vic20.js?t=${Date.now()}`,o.async=!0,o.onload=()=>{console.log("\u2705 VIC-20 script loaded successfully"),setTimeout(()=>{console.log("\u{1F50D} Checking for global keyboard event listeners...");let t=window.h;t&&(console.log("\u{1F50D} VIC-20 'h' object functions:",Object.keys(t).filter(n=>typeof t[n]=="function")),t.canvas&&(console.log("\u{1F50D} VIC-20 canvas found:",t.canvas),console.log("\u{1F50D} Canvas tabIndex:",t.canvas.tabIndex),console.log("\u{1F50D} Canvas focusable:",t.canvas.tabIndex>=0)))},1e3)},o.onerror=t=>{console.error("\u274C Failed to load VIC-20 script:",t)},document.head.appendChild(o)}detectModule(){if(typeof window.Module!="undefined"&&window.Module)console.log("Found Module object, setting module reference"),this.module=window.Module;else if(window.h)console.log("Found 'h' object, using as module"),this.module=window.h;else{console.log("VIC-20 module not detected yet, will retry later");return}console.log("VIC-20 chips-test emulator module detected")}enableJoystickSupport(){if(console.log("\u{1F527} Enabling joystick support..."),window.h&&typeof window.h.__sargs_add_kvp=="function")try{window.h.__sargs_add_kvp("joystick","true"),console.log("\u2705 Joystick support enabled via URL parameters")}catch(e){console.log("\u274C Error enabling joystick support:",e)}if(this.module&&typeof this.module.vic20_enable_joystick=="function")try{this.module.vic20_enable_joystick(!0),console.log("\u2705 Joystick support enabled via module function")}catch(e){console.log("\u274C Error enabling joystick support in module:",e)}}connectCanvasToEmulator(){if(!this.canvas){console.log("\u274C No canvas available for emulator connection");return}console.log("\u{1F517} Connecting canvas to VIC-20 emulator for display output..."),this.module&&(typeof this.module.canvas=="undefined"&&(this.module.canvas=this.canvas,console.log("\u2705 Connected canvas to module.canvas")),typeof window.canvas=="undefined"&&(window.canvas=this.canvas,console.log("\u2705 Connected canvas to window.canvas")),typeof this.module.requestAnimationFrame=="function"&&console.log("\u2705 Module has requestAnimationFrame - display should work")),this.addCanvasDragAndDropListeners(),setTimeout(()=>{if(this.canvas){let e=this.canvas.getContext("2d");e&&(e.fillStyle="black",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="white",e.font="16px monospace",e.fillText("VIC-20 Emulator Ready",10,30),console.log("\u2705 Canvas is working - test pattern drawn"))}},1e3)}async waitForModuleDetection(){let e=0,o=20;for(;e<o;){if(this.module||window.Module||window.h){this.detectModule();break}await new Promise(t=>setTimeout(t,100)),e++}e>=o&&(console.log("VIC-20 module detection timed out, but emulator should still work"),this.detectModule())}run(){this.module&&this.running||(this.running=!0,this.module&&typeof this.module.vic20_run=="function"?this.module.vic20_run():typeof window.vic20_run=="function"&&window.vic20_run())}stop(){this.running=!1}reset(){this.module&&typeof this.module.vic20_reset=="function"?this.module.vic20_reset():typeof window.vic20_reset=="function"&&window.vic20_reset()}advanceFrame(e){return 0}loadROM(e,o){console.log(`VIC20ChipsPlatform loadROM called with title: ${o} and ${e.length} bytes`);let t=e;this.debugCompilationOutput(),this.loadProgram(t),this.addGlobalDebugFunctions()}loadControlsState(e){}saveControlsState(){return{}}loadProgram(e){if(console.log("VIC20ChipsPlatform loadROM called with title: hello.c and",e.length,"bytes"),this.isLoadingProgram){console.log("\u26A0\uFE0F Program already loading, ignoring to prevent infinite loop");return}this.isLoadingProgram=!0;try{let o=window.h;if(!o){console.log("\u274C No 'h' object available for loading program");return}if(console.log("\u2705 Found 'h' object, using as module"),typeof o.__sapp_emsc_begin_drop=="function"){console.log("\u{1F3AF} Loading program via drop function...");let t=new File([e],"main.prg",{type:"application/octet-stream"}),n=new DataTransfer;n.items.add(t);let s=new DragEvent("drop",{dataTransfer:n,bubbles:!0,cancelable:!0}),r=document.getElementById("canvas");r?(r.dispatchEvent(s),console.log("\u2705 Drop event dispatched to canvas"),setTimeout(()=>{console.log("\u{1F3AF} Executing loaded program..."),this.executeLoadedProgram()},1e3)):console.log("\u274C Canvas not found")}else console.log("\u274C No drop function available")}catch(o){console.error("Error loading program:",o)}finally{setTimeout(()=>{this.isLoadingProgram=!1},2e3)}}executeLoadedProgram(){console.log("\u{1F3AF} Executing loaded program...");let e=window.h;if(!e){console.log("\u274C No 'h' object available for execution");return}let o=Object.keys(e).filter(t=>t.toLowerCase().includes("run")||t.toLowerCase().includes("execute")||t.toLowerCase().includes("start")||t.toLowerCase().includes("main"));if(console.log("\u{1F3AF} Found potential execution functions:",o),typeof e.__sapp_emsc_begin_drop=="function"){console.log("\u{1F3AF} Trying __sapp_emsc_begin_drop...");try{e.__sapp_emsc_begin_drop(),console.log("\u2705 Successfully called __sapp_emsc_begin_drop")}catch(t){console.log("\u274C Error calling __sapp_emsc_begin_drop:",t)}}for(let t of o)if(typeof e[t]=="function"){console.log(`\u{1F3AF} Trying ${t}...`);try{e[t](),console.log(`\u2705 Successfully called ${t}`);break}catch(n){console.log(`\u274C Error calling ${t}:`,n)}}}loadProgramViaURL(e){console.log("=== ATTEMPTING URL PARAMETER LOAD ===");let o;e.length>=2&&e[0]===24&&e[1]===16?(console.log("Program already has PRG header, using as-is"),o=e):(console.log("Adding PRG header to program"),o=new Uint8Array(e.length+2),o[0]=24,o[1]=16,o.set(e,2));let t=new Blob([o],{type:"application/octet-stream"}),n=URL.createObjectURL(t);console.log("Created temporary file URL:",n);let s=new URL(window.location.href);if(s.searchParams.set("file",n),s.searchParams.set("autorun","1"),s.searchParams.set("joystick","true"),console.log("New URL with file parameter and joystick:",s.toString()),window.h){let r=window.h,l=Object.keys(r).filter(i=>i.toLowerCase().includes("url")||i.toLowerCase().includes("param")||i.toLowerCase().includes("args")||i.toLowerCase().includes("parse"));console.log("URL-related functions found:",l);for(let i of l)if(typeof r[i]=="function"){console.log(`Trying to call ${i}...`);try{r[i](),console.log(`\u2705 Successfully called ${i}`)}catch(a){console.log(`\u274C Error calling ${i}:`,a)}}if(typeof r.__sargs_add_kvp=="function"){console.log("Trying to add file parameter via __sargs_add_kvp...");try{r.__sargs_add_kvp("file",n),r.__sargs_add_kvp("autorun","1"),r.__sargs_add_kvp("joystick","true");let a=new URLSearchParams(window.location.search).get("input");a&&(console.log("Found input parameter:",a),r.__sargs_add_kvp("input",a)),console.log("\u2705 Successfully added file parameters including joystick support")}catch(i){console.log("\u274C Error adding file parameters:",i)}}}setTimeout(()=>{console.log("Falling back to drop method..."),this.loadProgramViaDrop(o)},1e3)}loadProgramViaDrop(e){console.log("=== ATTEMPTING DROP METHOD LOAD ===");let o=e[1]<<8|e[0];console.log("Detected load address: 0x"+o.toString(16).toUpperCase()+" ("+o+")"),console.log("PRG header bytes: 0x"+e[0].toString(16).toUpperCase()+" 0x"+e[1].toString(16).toUpperCase()),console.log(o===4097||o===4608||o===4120?o===4120?"\u2705 Valid VIC-20 BASIC program detected (0x1018) - alternative load address":"\u2705 Valid VIC-20 program detected":"\u26A0\uFE0F Unexpected load address - may not be a valid VIC-20 program");let t=window.h,n=Object.keys(window).filter(a=>typeof window[a]=="function"&&(a.toLowerCase().includes("drop")||a.toLowerCase().includes("load")||a.toLowerCase().includes("run"))),s=this.module?Object.keys(this.module).filter(a=>typeof this.module[a]=="function"&&(a.toLowerCase().includes("drop")||a.toLowerCase().includes("load")||a.toLowerCase().includes("run"))):[];console.log("Available window functions:",n),console.log("Available module functions:",s),console.log("PRG data length:",e.length),console.log("PRG header:",e[0],e[1]),console.log("First few bytes of program:",e.slice(0,10));let r;try{if(typeof this.module._malloc=="function")r=this.module._malloc(e.length),console.log("\u2705 Allocated memory at address:",r);else if(typeof this.module._fs_emsc_alloc=="function")r=this.module._fs_emsc_alloc(e.length),console.log("\u2705 Allocated memory using _fs_emsc_alloc at address:",r);else{console.log("\u274C No memory allocation function available");return}}catch(a){console.log("\u274C Error allocating memory:",a);return}try{if(this.module.HEAPU8)this.module.HEAPU8.set(e,r),console.log("\u2705 Copied PRG data to WASM heap");else if(this.module.HEAP8)this.module.HEAP8.set(e,r),console.log("\u2705 Copied PRG data to WASM heap using HEAP8");else if(this.module.HEAP){for(let a=0;a<e.length;a++)this.module.HEAP[r+a]=e[a];console.log("\u2705 Copied PRG data to WASM heap using generic HEAP")}else{console.log("\u274C No WASM heap available - trying alternative approach"),this.callDropFunctionsWithoutMemory(e);return}}catch(a){console.log("\u274C Error copying data to WASM heap:",a),console.log("Trying alternative approach without memory allocation..."),this.callDropFunctionsWithoutMemory(e);return}console.log("PRG header:",e[0],e[1]),console.log("First few bytes of program:",e.slice(0,10)),console.log("Attempting to trigger drag-and-drop functionality using 'h' object"),console.log("PRG data to load:",e),console.log("PRG data length:",e.length),console.log("First 10 bytes:",e.slice(0,10));let l=["__sapp_emsc_begin_drop","__sapp_emsc_drop","__sapp_emsc_end_drop"];if(l.every(a=>typeof t[a]=="function")){console.log("Found complete drop sequence, calling all three functions...");try{t.__sapp_emsc_begin_drop(),console.log("Called __sapp_emsc_begin_drop successfully")}catch(a){console.log("\u274C Error calling __sapp_emsc_begin_drop:",a)}try{t.__sapp_emsc_drop(r,e.length),console.log("Called __sapp_emsc_drop successfully")}catch(a){console.log("\u274C Error calling __sapp_emsc_drop:",a)}try{t.__sapp_emsc_end_drop(),console.log("Called __sapp_emsc_end_drop successfully")}catch(a){console.log("\u274C Error calling __sapp_emsc_end_drop:",a)}}else console.log("\u274C Missing drop functions:",l.filter(a=>typeof t[a]!="function"));if(console.log("=== SIMPLIFIED EXECUTION APPROACH ==="),typeof this.module._main=="function")try{this.module._main(),console.log("\u2705 Calling _main to ensure emulator is running...")}catch(a){console.log("\u274C Error calling _main:",a)}console.log("\u2705 Program loaded and emulator should be running"),console.log("\u2705 Check the VIC-20 screen for output"),console.log("\u2705 Try clicking on the canvas to interact with the emulator"),this.forceDisplayRefresh(),console.log("\u{1F504} About to call verifyAndExecuteLoadedROM..."),this.verifyAndExecuteLoadedROM(e),console.log("\u2705 VIC-20 program loading complete!"),console.log("\u2705 The emulator should now be running with your program"),console.log("\u2705 Check the VIC-20 screen for any output"),console.log("\u2705 You can interact with the emulator by clicking on the canvas"),this.tryDirectMemoryLoading(e),this.debugCompilationOutput(),this.tryManualExecution(e),this.tryDropApproach(e)}debugCompilationOutput(){var e;if(console.log("=== DEBUGGING COMPILATION OUTPUT ==="),typeof window.worker!="undefined"&&(console.log("\u2705 Worker found, checking virtual file system..."),window.worker.store)){console.log("\u2705 Store found, checking files...");let o=Object.keys(window.worker.store.workfs||{});if(console.log("Files in virtual file system:",o),window.worker.store.workfs.main){let t=window.worker.store.workfs.main;console.log("Main file found:",t),console.log("Main file size:",t.data.length),console.log("Main file first 32 bytes:",Array.from(t.data.slice(0,32)).map(n=>n.toString(16).padStart(2,"0")).join(" "))}if(window.worker.store.workfs["main.map"]){let t=window.worker.store.workfs["main.map"];console.log("Map file found:",t),console.log("Map file content:",t.data)}}typeof window.builder!="undefined"&&(console.log("\u2705 Builder found"),console.log("Builder steps:",window.builder.steps)),typeof window.current_output!="undefined"&&(console.log("\u2705 Current output found:",window.current_output),console.log("Current output length:",(e=window.current_output)==null?void 0:e.length),window.current_output&&window.current_output.length>0&&(console.log("Current output first 32 bytes (hex):",Array.from(window.current_output.slice(0,32)).map(o=>o.toString(16).padStart(2,"0")).join(" ")),console.log("Current output first 32 bytes (decimal):",Array.from(window.current_output.slice(0,32)).join(" ")))),typeof window.compparams!="undefined"&&console.log("\u2705 Compilation parameters found:",window.compparams),typeof window.platform!="undefined"&&window.platform.debugSymbols&&console.log("\u2705 Debug symbols found:",window.platform.debugSymbols)}addGlobalDebugFunctions(){window.vic20_debug={loadProgram:e=>this.loadProgram(e),getCanvas:()=>this.getCanvas(),getModule:()=>this.module,getCPUState:()=>this.getCPUState(),readMemory:e=>this.read(e),writeMemory:(e,o)=>this.write(e,o),reset:()=>this.reset(),run:()=>this.run(),stop:()=>this.stop(),generateIframeURL:(e,o=!0)=>{let t="vic20-iframe.html";if(o){let n=String.fromCharCode.apply(null,Array.from(e)),s=btoa(n);return`${t}?program=${encodeURIComponent(s)}`}else{let n=Array.from(e).map(s=>s.toString(16).padStart(2,"0")).join(" ");return`${t}?hex=${encodeURIComponent(n)}`}},openIframeWithCurrentProgram:()=>{var o;let e=(o=window.IDE)==null?void 0:o.getCurrentOutput();if(e&&e instanceof Uint8Array){let t=window.vic20_debug.generateIframeURL(e);window.open(t,"_blank"),console.log("Opened VIC-20 iframe with current program:",t)}else console.error("No compiled program available. Compile first.")}},console.log("\u2705 VIC-20 debug functions added to window.vic20_debug"),console.log("Available functions:"),console.log("  - vic20_debug.loadProgram(data)"),console.log("  - vic20_debug.getCanvas()"),console.log("  - vic20_debug.getModule()"),console.log("  - vic20_debug.getCPUState()"),console.log("  - vic20_debug.readMemory(address)"),console.log("  - vic20_debug.writeMemory(address, value)"),console.log("  - vic20_debug.reset()"),console.log("  - vic20_debug.run()"),console.log("  - vic20_debug.stop()"),console.log("  - vic20_debug.generateIframeURL(programData, useBase64)"),console.log("  - vic20_debug.openIframeWithCurrentProgram()")}loadProgramDirectly(e){if(console.log("=== LOADING PROGRAM DIRECTLY ==="),!this.module){console.log("\u274C No module available");return}try{let o=e[1]<<8|e[0],t=e.slice(2);console.log("Load address:",o.toString(16)),console.log("Program data length:",t.length);for(let s=0;s<t.length;s++){let r=o+s;this.write(r,t[s])}console.log("\u2705 Program loaded directly into VIC-20 memory"),o===4097&&(this.write(43,o&255),this.write(44,o>>8&255),this.write(45,o+t.length&255),this.write(46,o+t.length>>8&255),console.log("\u2705 BASIC pointers set"));let n=window.h;n?(console.log("\u{1F50D} Checking for vic20_reset function..."),typeof n.vic20_reset=="function"?(n.vic20_reset(),console.log("\u2705 VIC-20 reset called")):console.log("\u274C vic20_reset function not found"),console.log("\u{1F50D} Checking for vic20_set_pc function..."),typeof n.vic20_set_pc=="function"?(n.vic20_set_pc(o),console.log("\u2705 PC set to load address")):console.log("\u274C vic20_set_pc function not found"),console.log("\u{1F50D} Trying alternative reset methods..."),typeof n.reset=="function"&&(n.reset(),console.log("\u2705 h.reset() called")),typeof n.vic20_reset_cpu=="function"&&(n.vic20_reset_cpu(),console.log("\u2705 h.vic20_reset_cpu() called")),typeof n.vic20_run=="function"&&(n.vic20_run(),console.log("\u2705 h.vic20_run() called")),console.log("\u{1F50D} Trying to trigger execution via _main..."),typeof n._main=="function"&&(n._main(),console.log("\u2705 h._main() called to trigger execution"))):console.log("\u274C No 'h' object available for execution"),this.forceDisplayRefresh()}catch(o){console.log("\u274C Error in direct loading:",o)}}tryManualExecution(e){if(console.log("=== TRYING MANUAL EXECUTION ==="),!this.module){console.log("\u274C No module available for manual execution");return}try{let o=e[1]<<8|e[0],t=e.slice(2);console.log("Manual execution - Load address:",o.toString(16)),console.log("Manual execution - Program data length:",t.length);for(let n=0;n<t.length;n++){let s=o+n;this.write(s,t[n])}console.log("\u2705 Program loaded directly into VIC-20 memory for manual execution"),o===4097&&(this.write(43,o&255),this.write(44,o>>8&255),this.write(45,o+t.length&255),this.write(46,o+t.length>>8&255),console.log("\u2705 BASIC pointers set for manual execution")),typeof this.module.vic20_reset=="function"&&(this.module.vic20_reset(),console.log("\u2705 VIC-20 reset called for manual execution")),typeof this.module.vic20_set_pc=="function"&&(this.module.vic20_set_pc(o),console.log("\u2705 PC set to load address for manual execution"))}catch(o){console.log("\u274C Error in manual execution:",o)}}tryDirectMemoryLoading(e){if(console.log("=== TRYING DIRECT MEMORY LOADING ==="),!this.module){console.log("\u274C No module available for direct memory loading");return}let o=e[1]<<8|e[0],t=e.slice(2);console.log("Load address:",o.toString(16)),console.log("Program data length:",t.length);try{for(let n=0;n<t.length;n++){let s=o+n;this.write(s,t[n])}console.log("\u2705 Program loaded directly into VIC-20 memory"),o===4097&&(this.write(43,o&255),this.write(44,o>>8&255),this.write(45,o+t.length&255),this.write(46,o+t.length>>8&255),console.log("\u2705 BASIC pointers set for program execution")),typeof this.module.vic20_reset=="function"&&(this.module.vic20_reset(),console.log("\u2705 VIC-20 reset called to start program execution"))}catch(n){console.log("\u274C Error in direct memory loading:",n)}}getCanvas(){return this.canvas}getFPS(){return 60}read(e){return this.module&&this.module.vic20_read_memory?this.module.vic20_read_memory(e):0}write(e,o){this.module&&this.module.vic20_write_memory&&this.module.vic20_write_memory(e,o)}getCPUState(){return{PC:0,SP:0}}saveState(){if(this.module&&this.module.vic20_save_state){let e=this.module.vic20_save_state();return{c:{PC:0,SP:0},b:e}}return{c:{PC:0,SP:0},b:null}}loadState(e){this.module&&this.module.vic20_load_state&&e.b&&this.module.vic20_load_state(e.b)}destroy(){this.running=!1,window.vic20Instance===this&&(window.vic20Instance=null),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.module=null;let e=document.getElementById("vic20-chips-div");e&&(e.style.display="none",console.log("\u2705 Hidden VIC-20 chips div"))}setKeyInput(e,o,t){if(!(e==16||e==17||e==18||e==224)){var n=0,s=0;if(e==37&&(e=8,n=4),e==38&&(e=11,n=1),e==39&&(e=9,n=8),e==40&&(e=10,n=2),e==32&&(n=16),e==65&&(e=65,s=4),e==87&&(e=87,s=1),e==68&&(e=68,s=8),e==83&&(e=83,s=2),e==69&&(s=16),e==113&&(e=241),e==115&&(e=243),e==119&&(e=245),e==121&&(e=247),t&1?(this.joymask0|=n,this.joymask1|=s):t&2&&(this.joymask0&=~n,this.joymask1&=~s),this.module&&typeof this.module.vic20_joystick=="function")this.module.vic20_joystick(this.joymask0,this.joymask1);else if(window.h&&typeof window.h.vic20_joystick=="function")window.h.vic20_joystick(this.joymask0,this.joymask1);else if(window.h&&typeof window.h.__sargs_add_kvp=="function")try{window.h.__sargs_add_kvp("joystick0",this.joymask0.toString()),window.h.__sargs_add_kvp("joystick1",this.joymask1.toString())}catch(r){console.log("\u274C Error setting joystick state:",r)}this.module&&(this.write(37137,this.joymask0),this.write(37153,this.joymask1))}}simulateKeyboardInput(e){console.log("\u{1F3AF} Attempting to simulate keyboard input for:",e);let o=window.h;if(o){let n=Object.keys(o).filter(s=>s.toLowerCase().includes("key")||s.toLowerCase().includes("input")||s.toLowerCase().includes("char")||s.toLowerCase().includes("type")||s.toLowerCase().includes("text")||s.toLowerCase().includes("send")||s.toLowerCase().includes("write"));console.log("\u{1F3AF} Found keyboard functions:",n);for(let s of n)if(typeof o[s]=="function"){console.log(`\u{1F3AF} Trying keyboard function: ${s}`);try{o[s](e),console.log(`\u2705 Successfully called ${s} with text: ${e}`);return}catch(r){console.log(`\u274C Error calling ${s}:`,r)}}if(typeof o.sendText=="function"){console.log("\u{1F3AF} Trying sendText function...");try{o.sendText(e),console.log(`\u2705 Successfully sent text via sendText: ${e}`);return}catch(s){console.log("\u274C Error calling sendText:",s)}}if(typeof o.writeInput=="function"){console.log("\u{1F3AF} Trying writeInput function...");try{o.writeInput(e),console.log(`\u2705 Successfully wrote input: ${e}`);return}catch(s){console.log("\u274C Error calling writeInput:",s)}}}console.log("\u{1F3AF} No keyboard function found, trying individual key simulation with delays...");let t=0;for(let n of e)setTimeout(()=>{let s=n.charCodeAt(0);this.simulateKeyPress(s)},t),t+=50}simulateKeyPress(e){console.log(`\u{1F3AF} Attempting to simulate key press for key code: ${e}`);let o=window.h;if(!o){console.log("\u274C No 'h' object available for key simulation");return}console.log("\u{1F50D} Available functions on h object:",Object.keys(o));let t=["keydown","keypress","keyup","key","input","sendKey","pressKey","keyboard","keyboardInput","keyboardEvent","simulateKey","simulateKeyPress"];for(let n of t)if(typeof o[n]=="function"){console.log(`\u{1F3AF} Trying ${n} function...`);try{o[n](e),console.log(`\u2705 ${n} called successfully with keyCode ${e}`);return}catch(s){console.log(`\u274C ${n} failed:`,s)}}console.log("\u{1F3AF} Trying to create and dispatch keyboard event...");try{let n=new KeyboardEvent("keydown",{keyCode:e,which:e,key:e===112?"F1":e===13?"Enter":String.fromCharCode(e),code:e===112?"F1":e===13?"Enter":`Key${String.fromCharCode(e)}`,bubbles:!0,cancelable:!0});if(o.canvas){o.canvas.dispatchEvent(n),console.log(`\u2705 Keyboard event dispatched on h.canvas for key ${e}`);return}else if(o.xc){o.xc.dispatchEvent(n),console.log(`\u2705 Keyboard event dispatched on h.xc for key ${e}`);return}else if(this.canvas){this.canvas.dispatchEvent(n),console.log(`\u2705 Keyboard event dispatched on this.canvas for key ${e}`);return}}catch(n){console.log("\u274C Error creating/dispatching keyboard event:",n)}console.log(`\u274C No key function found for key ${e} (${String.fromCharCode(e)})`)}verifyProgramLoaded(e){if(console.log("=== VERIFYING PROGRAM LOAD ==="),!window.h){console.log("\u274C No 'h' object available for verification");return}let o=window.h;console.log("=== ANALYZING AVAILABLE FUNCTIONS ===");let t=Object.keys(o);console.log("All available functions:",t);let n=t.filter(l=>l.toLowerCase().includes("run")||l.toLowerCase().includes("exec")||l.toLowerCase().includes("start")||l.toLowerCase().includes("main")||l.toLowerCase().includes("call")||l.toLowerCase().includes("jump"));if(console.log("Potential execution functions:",n),typeof o._main=="function"){console.log("Found _main function, trying to call it...");try{o._main(),console.log("\u2705 Successfully called _main function")}catch(l){console.log("\u274C Error calling _main function:",l)}}let s=["vic20_read_memory","read_memory","memory_read","get_memory","vic20_memory_read","read_byte","get_byte"],r=null;for(let l of s)if(typeof o[l]=="function"){r=o[l],console.log(`Found memory read function: ${l}`);break}if(r){let l=[4097,4608,4096,4609];for(let i of l)try{let a=r(i);console.log(`Memory at 0x${i.toString(16).toUpperCase()}: 0x${a.toString(16).toUpperCase()} (${a})`)}catch(a){console.log(`Error reading memory at 0x${i.toString(16).toUpperCase()}:`,a)}if(e.length>=2){let i=e[0]|e[1]<<8;console.log(`Checking memory starting at load address: 0x${i.toString(16).toUpperCase()}`);for(let a=0;a<Math.min(10,e.length-2);a++)try{let d=i+a,u=e[a+2],g=r(d);console.log(`${u===g?"\u2705":"\u274C"} Memory[0x${d.toString(16).toUpperCase()}]: expected 0x${u.toString(16).toUpperCase()}, got 0x${g.toString(16).toUpperCase()}`)}catch(d){console.log(`Error reading memory at offset ${a}:`,d)}}}else{console.log("\u274C No memory read function found");let l=["vic20_get_state","get_state","get_program_state","get_loaded_program","vic20_program_info","program_info","get_file_info"];for(let i of l)if(typeof o[i]=="function")try{let a=o[i]();console.log(`Program state from ${i}:`,a)}catch(a){console.log(`Error calling ${i}:`,a)}}}forceDisplayRefresh(){if(console.log("\u{1F504} Forcing VIC-20 display refresh..."),this.module){typeof this.module.requestAnimationFrame=="function"&&(console.log("\u2705 Using module.requestAnimationFrame for display refresh"),this.module.requestAnimationFrame(()=>{console.log("\u2705 Display refresh triggered via requestAnimationFrame")}));let e=["refresh","redraw","update","render","display"];for(let o of e)if(typeof this.module[o]=="function"){console.log(`\u2705 Calling module.${o}() for display refresh`);try{this.module[o]()}catch(t){console.log(`\u274C Error calling ${o}:`,t)}}if(typeof this.module._main=="function"){console.log("\u2705 Calling _main again to trigger frame update");try{this.module._main()}catch(o){console.log("\u274C Error calling _main for display refresh:",o)}}}setTimeout(()=>{if(this.canvas){let e=this.canvas.getContext("2d");e&&(e.fillStyle="green",e.fillRect(this.canvas.width-20,10,10,10),e.fillStyle="white",e.font="12px monospace",e.fillText("LOADED",this.canvas.width-80,20),console.log("\u2705 Visual indicator drawn on canvas"))}},500),console.log("\u2705 Display refresh attempts completed")}verifyAndExecuteLoadedROM(e){console.log("\u{1F504} DISABLED: verifyAndExecuteLoadedROM to prevent crashes"),console.log("\u{1F504} Skipping program verification and execution for safety")}triggerProgramExecution(){console.log("\u{1F504} DISABLED: triggerProgramExecution to prevent crashes"),console.log("\u{1F504} Skipping all execution function calls for safety")}callDropFunctionsWithoutMemory(e){console.log("\u{1F504} DISABLED: callDropFunctionsWithoutMemory to prevent crashes"),console.log("\u{1F504} Skipping all drop function calls for safety")}simulateFileReading(e){var a;console.log("\u{1F3AF} === SIMULATING FILE READING (DISABLED FOR SAFETY) ==="),console.log("\u{1F504} Skipping emulator state check to prevent crashes");let o=new Blob([e],{type:"application/octet-stream"}),t=new File([o],"program.prg",{type:"application/octet-stream"});console.log("\u{1F4C1} Created File object:",t.name,t.size,"bytes"),this.module&&this.module.h&&(this.module.h.dd=t,console.log("\u{1F4C1} Stored file in h.dd"));let n=null,s=(a=this.module)==null?void 0:a.h;if(window.t&&window.t instanceof Uint8Array?(n=window.t,console.log("\u2705 Found HEAPU8 via window.t")):window.r&&window.r instanceof Uint8Array?(n=window.r,console.log("\u2705 Found HEAPU8 via window.r")):(s==null?void 0:s.HEAPU8)?(n=s.HEAPU8,console.log("\u2705 Found HEAPU8 via h.HEAPU8")):(s==null?void 0:s.HEAP8)?(n=new Uint8Array(s.HEAP8.buffer),console.log("\u2705 Found HEAPU8 via h.HEAP8 conversion")):(s==null?void 0:s.HEAP)&&(n=new Uint8Array(s.HEAP.buffer),console.log("\u2705 Found HEAPU8 via h.HEAP conversion")),!n){console.error("\u274C No WASM heap available for file reading simulation");return}let r=e[0]|e[1]<<8;console.log(`\u{1F4CD} Load address from PRG header: 0x${r.toString(16).padStart(4,"0")} (${r})`);let l=e.slice(2);console.log(`\u{1F4E6} Program data size: ${l.length} bytes`),console.log("\u{1F50D} DEBUG: Memory contents before loading:");let i=[4096,4097,4120,4608];for(let d of i)try{let u=n[d];console.log(`  - 0x${d.toString(16).padStart(4,"0")}: 0x${u.toString(16).padStart(2,"0")} (before)`)}catch(u){console.log(`  - 0x${d.toString(16).padStart(4,"0")}: <error> (${u})`)}try{n.set(l,r),console.log(`\u2705 Successfully copied ${l.length} bytes to address 0x${r.toString(16).padStart(4,"0")}`)}catch(d){console.error("\u274C Error copying data to WASM heap:",d);return}console.log("\u{1F50D} DEBUG: Memory contents after loading:");for(let d=0;d<Math.min(16,l.length);d++){let u=r+d;try{let g=n[u],m=l[d],y=g===m?"\u2705":"\u274C";console.log(`  - 0x${u.toString(16).padStart(4,"0")}: 0x${g.toString(16).padStart(2,"0")} (expected: 0x${m.toString(16).padStart(2,"0")}) ${y}`)}catch(g){console.log(`  - 0x${u.toString(16).padStart(4,"0")}: <error> (${g})`)}}console.log("\u{1F504} Data copied successfully - skipping drop function calls to avoid conflicts"),setTimeout(()=>{console.log("\u{1F3AF} Triggering execution with key presses..."),this.simulateKeyPress(13)},200),setTimeout(()=>{this.simulateKeyPress(112)},300),setTimeout(()=>{this.simulateKeyPress(114)},400),setTimeout(()=>{this.triggerProgramExecution()},500)}debugMemoryAfterLoading(){console.log("\u{1F50D} DEBUG: Checking memory after loading...");try{let e=window.h;if(!e){console.log("\u274C No 'h' object available for memory check");return}let o=[4096,4097,4120,4608,8192,16384,24576,32768,36864,49152,57344];console.log("\u{1F50D} DEBUG: Memory contents at key addresses:");for(let n of o)try{let s=null;window.t&&typeof window.t[n]!="undefined"?(s=window.t[n],console.log(`  - 0x${n.toString(16).padStart(4,"0")}: 0x${s.toString(16).padStart(2,"0")} (global t)`)):window.r&&typeof window.r[n]!="undefined"?(s=window.r[n],console.log(`  - 0x${n.toString(16).padStart(4,"0")}: 0x${s.toString(16).padStart(2,"0")} (global r)`)):e.HEAPU8&&typeof e.HEAPU8[n]!="undefined"?(s=e.HEAPU8[n],console.log(`  - 0x${n.toString(16).padStart(4,"0")}: 0x${s.toString(16).padStart(2,"0")} (HEAPU8)`)):e.HEAP8&&typeof e.HEAP8[n]!="undefined"?(s=e.HEAP8[n],console.log(`  - 0x${n.toString(16).padStart(4,"0")}: 0x${s.toString(16).padStart(2,"0")} (HEAP8)`)):e.HEAP&&typeof e.HEAP[n]!="undefined"?(s=e.HEAP[n],console.log(`  - 0x${n.toString(16).padStart(4,"0")}: 0x${s.toString(16).padStart(2,"0")} (HEAP)`)):console.log(`  - 0x${n.toString(16).padStart(4,"0")}: <no access> (no heap available)`)}catch(s){console.log(`  - 0x${n.toString(16).padStart(4,"0")}: <error> (${s})`)}console.log("\u{1F50D} DEBUG: Looking for memory reading functions...");let t=Object.keys(e).filter(n=>typeof e[n]=="function"&&(n.toLowerCase().includes("read")||n.toLowerCase().includes("memory")||n.toLowerCase().includes("peek")||n.toLowerCase().includes("get")));if(console.log("  - Available memory functions:",t),t.length>0){let n=t[0];console.log(`\u{1F50D} DEBUG: Testing memory reading with ${n}...`);try{let s=[4096,4097,4098,4099,4100,4101];for(let r of s)try{let l=e[n](r);console.log(`  - ${n}(0x${r.toString(16).padStart(4,"0")}): ${l}`)}catch(l){console.log(`  - ${n}(0x${r.toString(16).padStart(4,"0")}): <error> (${l})`)}}catch(s){console.log(`  - Error testing ${n}:`,s)}}}catch(e){console.log("\u274C Error during memory debugging:",e)}}checkAndResetEmulatorState(){console.log("\u{1F50D} DEBUG: Checking emulator state before loading...");try{let e=window.h;if(!e){console.log("\u274C No 'h' object available for state check");return}console.log("\u{1F50D} DEBUG: Current emulator state:"),console.log("  - calledRun:",e.calledRun),console.log("  - running:",this.running),console.log("  - programLoaded:",this.programLoaded);let o=Object.keys(e).filter(t=>typeof e[t]=="function"&&(t.toLowerCase().includes("reset")||t.toLowerCase().includes("init")||t.toLowerCase().includes("clear")||t.toLowerCase().includes("boot")||t.toLowerCase().includes("start")));if(console.log("\u{1F50D} DEBUG: Available reset/init functions:",o),o.length>0){console.log("\u{1F504} Attempting to reset emulator state...");for(let t of o)try{console.log(`\u{1F3AF} Trying to call ${t}...`),e[t](),console.log(`\u2705 Successfully called ${t}()`),console.log("\u{1F504} Skipping setTimeout to prevent crashes");return}catch(n){console.log(`\u274C Error calling ${t}():`,n)}}if(typeof e._main=="function"){console.log("\u{1F504} Calling _main to ensure emulator is running...");try{e._main(),console.log("\u2705 Called _main successfully")}catch(t){console.log("\u274C Error calling _main:",t)}}if(console.log("\u{1F504} Attempting to clear existing program data..."),window.t)try{console.log("\u{1F504} Skipping memory clearing to prevent crashes")}catch(t){console.log("\u274C Error clearing program area:",t)}}catch(e){console.log("\u274C Error during emulator state check:",e)}}tryDropApproach(e){console.log("\u{1F504} Trying drop approach as fallback...");try{let o=window.h;if(!o){console.log("\u274C No 'h' object available");return}let t=new File([e],"program.prg",{type:"application/octet-stream",lastModified:Date.now()}),n=new DataTransfer;n.items.add(t);let s=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:n}),r=null;if(o.xc)r=o.xc,console.log("\u2705 Found canvas through h.xc:",r);else if(o.canvas)r=o.canvas,console.log("\u2705 Found canvas through h.canvas:",r);else{console.log("\u274C No canvas found on h object");return}console.log("\u{1F3AF} Dispatching drop event on canvas:",r);let l=r.dispatchEvent(s);console.log(`\u2705 Drop event dispatched successfully: ${l}`),setTimeout(()=>{console.log("\u{1F504} Drop event should have been processed by now"),console.log("\u{1F3AF} Checking if program is running..."),console.log("\u{1F3AF} Checking calledRun status:",o.calledRun);for(let i=0;i<3;i++){try{typeof o._main=="function"&&(o._main(),console.log(`\u2705 _main called successfully (attempt ${i+1})`))}catch(a){console.log(`\u274C Error calling _main (attempt ${i+1}):`,a)}i<2&&setTimeout(()=>{},100)}},300)}catch(o){console.log("\u274C Error during drop approach:",o)}}addCanvasDragAndDropListeners(){let e=this.canvas;if(!e){let o=window.h;o&&o.canvas?(e=o.canvas,console.log("\u{1F3AF} Using emulator canvas for drag-and-drop listeners")):o&&o.xc?(e=o.xc,console.log("\u{1F3AF} Using emulator xc for drag-and-drop listeners")):(e=document.getElementById("canvas"),console.log("\u{1F3AF} Using document canvas for drag-and-drop listeners"))}if(!e){console.log("\u274C No canvas available for drag-and-drop listeners");return}console.log("\u{1F3AF} Adding drag-and-drop event listeners to canvas for manual file loading...");try{e.addEventListener("dragover",o=>{o.preventDefault(),o.stopPropagation(),console.log("\u{1F3AF} Drag over detected on canvas")}),e.addEventListener("drop",o=>{var n;if(o.preventDefault(),o.stopPropagation(),console.log("\u{1F3AF} Manual drop event detected on canvas"),this.isLoadingProgram){console.log("\u26A0\uFE0F Program already loading, ignoring drop event to prevent infinite loop");return}let t=(n=o.dataTransfer)==null?void 0:n.files;if(t&&t.length>0){let s=t[0];console.log("\u{1F3AF} Manual file dropped:",s.name,s.size,"bytes");let r=new FileReader;r.onload=l=>{var i;if(((i=l.target)==null?void 0:i.result)instanceof ArrayBuffer){let a=new Uint8Array(l.target.result);console.log("\u{1F3AF} Manual file data loaded:",a.length,"bytes"),console.log("\u{1F3AF} First 16 bytes:",Array.from(a.slice(0,16))),this.loadProgram(a)}},r.readAsArrayBuffer(s)}}),console.log("\u2705 Manual drag-and-drop listeners added to canvas")}catch(o){console.log("\u274C Error adding drag-and-drop listeners:",o)}}captureDragAndDropData(){console.log("\u{1F50D} DEBUG: Setting up drag-and-drop capture...");try{let e=window.h;if(!e){console.log("\u274C No 'h' object available");return}let o=e.__sapp_emsc_begin_drop,t=e.__sapp_emsc_drop,n=e.__sapp_emsc_end_drop;e.__sapp_emsc_begin_drop=function(...r){return console.log("\u{1F50D} CAPTURED: __sapp_emsc_begin_drop called with:",r),o.apply(this,r)},e.__sapp_emsc_drop=function(...r){return console.log("\u{1F50D} CAPTURED: __sapp_emsc_drop called with:",r),t.apply(this,r)},e.__sapp_emsc_end_drop=function(...r){return console.log("\u{1F50D} CAPTURED: __sapp_emsc_end_drop called with:",r),n.apply(this,r)};let s=e.dd;Object.defineProperty(e,"dd",{get:function(){return s},set:function(r){console.log("\u{1F50D} CAPTURED: h.dd set to:",r),r&&r.length>0&&(console.log("\u{1F50D} CAPTURED: First file in h.dd:",r[0]),console.log("\u{1F50D} CAPTURED: File size:",r[0].size),console.log("\u{1F50D} CAPTURED: File name:",r[0].name)),s=r}}),console.log("\u2705 Drag-and-drop capture set up. Now try dragging and dropping a file to see the captured data.")}catch(e){console.log("\u274C Error setting up drag-and-drop capture:",e)}}addSimpleFocusProtection(){!this.canvas||console.log("\u2705 Simple focus protection added - no global overrides")}addClickToFocusFunctionality(){!this.canvas||(console.log("\u{1F3AF} Adding click-to-focus functionality to VIC-20 canvas"),this.canvas.tabIndex=0,this.canvas.style.outline="none",this.canvas.addEventListener("click",e=>{var o;e.preventDefault(),e.stopPropagation(),this.emulatorFocused||(this.emulatorFocused=!0,(o=this.canvas)==null||o.focus(),this.canvas.style.border="2px solid #4CAF50",this.canvas.style.cursor="default",console.log("\u{1F3AF} VIC-20 emulator focused - keyboard input enabled"))}),document.addEventListener("click",e=>{this.canvas&&!this.canvas.contains(e.target)&&this.emulatorFocused&&(this.emulatorFocused=!1,this.canvas.style.border="1px solid #333",this.canvas.style.cursor="pointer",console.log("\u{1F3AF} VIC-20 emulator unfocused - keyboard input disabled"))}),this.canvas.addEventListener("keydown",e=>{!this.emulatorFocused||(console.log(`\u{1F3AF} Key pressed in VIC-20 emulator: ${e.key} (keyCode: ${e.keyCode})`),this.forwardKeyEventToEmulator(e))}),this.canvas.addEventListener("keyup",e=>{!this.emulatorFocused||(console.log(`\u{1F3AF} Key released in VIC-20 emulator: ${e.key} (keyCode: ${e.keyCode})`),this.forwardKeyUpEventToEmulator(e))}),console.log("\u2705 Click-to-focus functionality added to VIC-20 canvas"))}forwardKeyEventToEmulator(e){let o=window.h;if(o){if(typeof o._=="function")try{o._(this.canvas,e.keyCode,2,0),console.log("\u{1F3AF} Sent keydown to VIC-20 via _ function with keyCode:",e.keyCode)}catch(t){console.log("\u274C Error sending keydown:",t)}if(typeof o.setKeyInput=="function")try{o.setKeyInput(e.keyCode,e.keyCode,1),console.log("\u{1F3AF} Sent keydown to VIC-20 via setKeyInput with keyCode:",e.keyCode)}catch(t){console.log("\u274C Error sending keydown via setKeyInput:",t)}}}forwardKeyUpEventToEmulator(e){let o=window.h;if(o){if(typeof o.Z=="function")try{o.Z(this.canvas,e.keyCode,3,0),console.log("\u{1F3AF} Sent keyup to VIC-20 via Z function with keyCode:",e.keyCode)}catch(t){console.log("\u274C Error sending keyup:",t)}if(typeof o.setKeyInput=="function")try{o.setKeyInput(e.keyCode,e.keyCode,2),console.log("\u{1F3AF} Sent keyup to VIC-20 via setKeyInput with keyCode:",e.keyCode)}catch(t){console.log("\u274C Error sending keyup via setKeyInput:",t)}}}};var v=[{id:"hello.bas",name:"Hello World (BASIC)",category:"BASIC Tutorial"},{id:"control.bas",name:"Control Codes Demo (BASIC)"},{id:"labels.bas",name:"Label Demo (BASIC)"},{id:"guess.bas",name:"Number Guessing (BASIC)"},{id:"hello.c",name:"Hello World",category:"C"},{id:"siegegame.c",name:"Siege Game"},{id:"skeleton.cc65",name:"C/CC65 Boilerplate"}],w={main:[{name:"RAM",start:0,size:4096,type:"ram"},{name:"Screen RAM",start:4096,size:1024,type:"ram"},{name:"Color RAM",start:37888,size:1024,type:"io"},{name:"Character ROM",start:32768,size:4096,type:"rom"},{name:"BASIC ROM",start:49152,size:8192,type:"rom"},{name:"KERNAL ROM",start:57344,size:8192,type:"rom"},{name:"VIC I/O",start:36864,size:1024,type:"io"},{name:"VIA 1",start:37136,size:16,type:"io"},{name:"VIA 2",start:37152,size:16,type:"io"}]},p=class{constructor(e){this.running=!1;this.timer=null;this.lastLoadedProgram=null;this.mainElement=e,this.machine=new f}async start(){console.log("VIC20ChipsPlatform start() called - EMULATOR DISABLED FOR TESTING"),this.mainElement.innerHTML='<iframe id="vic20-iframe" src="vic20-iframe.html" style="width: 100%; height: 500px; border: none;" tabindex="-1"></iframe>';let e=document.getElementById("vic20-iframe");e&&(e.setAttribute("tabindex","-1"),e.addEventListener("focus",o=>{o.stopPropagation()},!0)),console.log("VIC20ChipsPlatform: iframe created, setting up with auto-compilation"),setTimeout(()=>{this.setupIframeWithAutoCompilation()},1e3),this.setupCompilationListener(),this.updateControlButtons()}setupCompilationListener(){let e=window.setCompileOutput;e&&(window.setCompileOutput=o=>{e(o),o&&o.output&&!o.errors&&(console.log("VIC20ChipsPlatform: Compilation detected, reloading iframe"),setTimeout(()=>{this.setupIframeWithAutoCompilation()},500))})}nextFrame(){this.running&&this.machine.advanceFrame(()=>!1)}pause(){console.log("VIC20ChipsPlatform pause() called");let e=document.getElementById("vic20-iframe");e&&e.contentWindow&&(e.contentWindow.postMessage({type:"pause"},"*"),console.log("VIC20ChipsPlatform: Sent pause command to iframe")),this.running=!1,this.timer&&this.timer.stop()}resume(){console.log("VIC20ChipsPlatform resume() called");let e=document.getElementById("vic20-iframe");e&&e.contentWindow&&(e.contentWindow.postMessage({type:"resume"},"*"),console.log("VIC20ChipsPlatform: Sent resume command to iframe")),this.running=!0,this.timer&&this.timer.start()}loadROM(e,o){console.log("VIC20ChipsPlatform loadROM called with title:",e,"and",o.length,"bytes"),this.lastLoadedProgram={title:e,rom:o};var t=document.getElementById("vic20-iframe");if(t&&t.contentWindow)if(o.length>1e3){console.log("VIC20ChipsPlatform: Large program detected, using postMessage instead of URL");let n="vic20-iframe.html?t="+Date.now();t.src=n;let s=()=>{console.log("VIC20ChipsPlatform: iframe loaded, sending program via postMessage"),t.contentWindow.postMessage({type:"compiled_program",program:o,autoLoad:!0},"*"),t.removeEventListener("load",s)};t.addEventListener("load",s)}else{let n=window.vic20_debug;if(n&&n.generateIframeURL){let s=n.generateIframeURL(o);if(s instanceof Promise)s.then(r=>{if(console.log("VIC20ChipsPlatform: Generated iframe URL:",r),r){let l="&t="+Date.now(),i=r+l;console.log("VIC20ChipsPlatform: Loading fresh URL with cache buster:",i);let a=()=>{console.log("VIC20ChipsPlatform: iframe loaded, calling checkForProgramInURL"),t.contentWindow.checkForProgramInURL&&t.contentWindow.checkForProgramInURL(),t.removeEventListener("load",a)};t.addEventListener("load",a),t.contentWindow.location=i}else console.error("VIC20ChipsPlatform: generateIframeURL returned null")}).catch(r=>{console.error("VIC20ChipsPlatform: Error generating iframe URL:",r)});else{let r=s;if(console.log("VIC20ChipsPlatform: Generated iframe URL:",r),r){let l="&t="+Date.now(),i=r+l;console.log("VIC20ChipsPlatform: Loading fresh URL with cache buster:",i);let a=()=>{console.log("VIC20ChipsPlatform: iframe loaded, calling checkForProgramInURL"),t.contentWindow.checkForProgramInURL&&t.contentWindow.checkForProgramInURL(),t.removeEventListener("load",a)};t.addEventListener("load",a),t.contentWindow.location=i}else console.error("VIC20ChipsPlatform: generateIframeURL returned null")}}else console.error("VIC20ChipsPlatform: vic20_debug.generateIframeURL not available")}else console.error("VIC20ChipsPlatform: iframe not found or contentWindow not available");this.machine?this.machine.loadProgram(o):console.error("VIC20ChipsPlatform: machine is null!")}setupIframeWithAutoCompilation(){console.log("VIC20ChipsPlatform: Setting up iframe with auto-compilation");var e=document.getElementById("vic20-iframe");if(!e||!e.contentWindow){console.error("VIC20ChipsPlatform: iframe not found or contentWindow not available");return}let o=window.vic20_debug;if(!o||!o.openIframeWithCurrentProgram){console.error("VIC20ChipsPlatform: vic20_debug not available");return}let t=o.openIframeWithCurrentProgram();if(console.log("VIC20ChipsPlatform: Initial iframe URL check:",t),t){console.log("VIC20ChipsPlatform: Found compiled program, loading iframe");let n="&t="+Date.now(),s=t+n;console.log("VIC20ChipsPlatform: Loading fresh URL with cache buster:",s),this.loadIframeWithProgram(s)}else console.log("VIC20ChipsPlatform: No compiled program found, triggering compilation"),this.triggerCompilationAndReload()}loadIframeWithProgram(e){var o=document.getElementById("vic20-iframe");if(!o||!o.contentWindow)return;let t=()=>{console.log("VIC20ChipsPlatform: iframe loaded, calling checkForProgramInURL"),o.contentWindow.checkForProgramInURL&&o.contentWindow.checkForProgramInURL(),o.removeEventListener("load",t)};o.addEventListener("load",t),o.contentWindow.location=e}triggerCompilationAndReload(){var t,n;console.log("VIC20ChipsPlatform: Triggering compilation...");let e=window.worker;if(!e){console.error("VIC20ChipsPlatform: Global worker not found");return}let o=e.onmessage;e.onmessage=s=>{o&&o.call(e,s),s.data&&s.data.output&&(console.log("VIC20ChipsPlatform: Compilation completed, reloading iframe"),setTimeout(()=>{let r=window.vic20_debug;if(r&&r.openIframeWithCurrentProgram){let l=r.openIframeWithCurrentProgram();if(l){let i="&t="+Date.now(),a=l+i;console.log("VIC20ChipsPlatform: Loading fresh URL with cache buster:",a),this.loadIframeWithProgram(a)}}e.onmessage=o},1e3))},e.postMessage?e.postMessage({type:"build",files:((n=(t=window.IDE)==null?void 0:t.getCurrentProject())==null?void 0:n.getFiles())||{}}):(console.error("VIC20ChipsPlatform: Worker postMessage not available"),e.onmessage=o)}getPresets(){return v}getMemoryMap(){return w}getDefaultExtension(){return".c"}getROMExtension(e){if(e&&e.length>=2){let o=e[1]<<8|e[0];if(o>=4096&&o<=65535)return".prg"}return".bin"}readAddress(e){return this.machine.read(e)}writeAddress(e,o){this.machine.write(e,o)}getCPUState(){return this.machine.getCPUState()}saveState(){return this.machine.saveState()}loadState(e){this.machine.loadState(e)}reset(){console.log("VIC20ChipsPlatform reset() called");let e=document.getElementById("vic20-iframe");if(e){let o=e.src.split("?")[0],t="?t="+Date.now();if(this.lastLoadedProgram&&this.lastLoadedProgram.rom.length<=1e3){let n=window.vic20_debug;if(n&&n.generateIframeURL){let s=n.generateIframeURL(this.lastLoadedProgram.rom);if(s instanceof Promise)s.then(r=>{r?(e.src=r+"&t="+Date.now(),console.log("VIC20ChipsPlatform: Reloaded iframe with program URL")):(e.src=o+t,console.log("VIC20ChipsPlatform: Reloaded iframe (fallback)"))});else{let r=s;r?(e.src=r+"&t="+Date.now(),console.log("VIC20ChipsPlatform: Reloaded iframe with program URL")):(e.src=o+t,console.log("VIC20ChipsPlatform: Reloaded iframe (fallback)"))}}else e.src=e.src+(e.src.includes("?")?"&":"?")+"t="+Date.now(),console.log("VIC20ChipsPlatform: Reloaded iframe (fallback - no generateIframeURL)")}else e.src=e.src+(e.src.includes("?")?"&":"?")+"t="+Date.now(),console.log("VIC20ChipsPlatform: Reloaded iframe")}this.machine&&this.machine.reset()}updateControlButtons(){let e=document.getElementById("dbg_reset"),o=document.getElementById("dbg_pause"),t=document.getElementById("dbg_go");e&&(e.style.display="inline-block",console.log("VIC20ChipsPlatform: Reset button visible")),o&&(o.style.display="inline-block",console.log("VIC20ChipsPlatform: Pause button visible")),t&&(t.style.display="inline-block",console.log("VIC20ChipsPlatform: Resume button visible"))}setKeyInput(e,o,t){this.machine.setKeyInput(e,o,t)}loadControlsState(e){this.machine.loadControlsState(e)}saveControlsState(){return this.machine.saveControlsState()}getFPS(){return this.machine.getFPS()}showHelp(){return"https://8bitworkshop.com/docs/platforms/cbm/index.html#vic-20"}isStable(){return!0}isRunning(){return this.running}getToolForFilename(e){return e.toLowerCase().endsWith(".bas")?"c64basic":e.endsWith(".c")?"cc65":e.endsWith(".dasm")?"dasm":e.endsWith(".acme")?"acme":e.endsWith(".wiz")?"wiz":"cc65"}};h.vic20=p;var I=p;export{I as default};
//# sourceMappingURL=vic20-DKR72FO2.js.map
