import{D as C}from"./chunk-LJINFNAP.js";import{H as S}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";var A=[{id:"hello.bas",name:"Hello World (BASIC)",category:"BASIC"}],F=class{constructor(n){this.iframe=null;this.currentModel="48k";this.pauseResumeSupported=!0;this.blobUrls=[];this.originalBinary=null;this.originalFilename=null;this.mainElement=n,window.addEventListener("message",t=>{t.data&&t.data.type==="emulator_capabilities"&&(console.log("ZXSpectrumPlatform: Received emulator capabilities:",t.data.capabilities),t.data.capabilities&&typeof t.data.capabilities.pause=="boolean"&&(this.pauseResumeSupported=t.data.capabilities.pause),this.updateControlButtons())})}async start(){console.log("ZXSpectrumPlatform start() called"),this.iframe=document.createElement("iframe"),this.iframe.id="zxspectrum-iframe",this.iframe.style.width="100%",this.iframe.style.height="600px",this.iframe.style.border="1px solid #ccc",this.iframe.style.backgroundColor="#000",this.iframe.setAttribute("tabindex","-1"),this.iframe.addEventListener("focus",r=>{r.stopPropagation()},!0),this.iframe.addEventListener("click",r=>{r.stopPropagation()},!0),this.mainElement.innerHTML="",this.mainElement.appendChild(this.iframe);let t=new URLSearchParams(window.location.search).get("model")||"48k";this.currentModel=t==="128k"?"128k":"48k";let e=`?t=${Date.now()}`,i=`&model=${encodeURIComponent(this.currentModel)}`;this.iframe.src=`zxspectrum-iframe.html${e}${i}`,console.log("ZXSpectrumPlatform: iframe created and qaop loading, model:",this.currentModel),this.setupCompilationListener(),this.updateControlButtons()}stop(){console.log("ZXSpectrumPlatform stop() called")}reset(){console.log("ZXSpectrumPlatform reset() called"),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"reset"},"*"),console.log("ZXSpectrumPlatform: Sent reset command to iframe"))}isRunning(){return this.iframe!==null}getToolForFilename(n){let t=n.toLowerCase();return t.endsWith(".bas")?"zxbasic":t.endsWith(".c")||t.endsWith(".h")?"z88dk":C(n)}getDefaultExtension(){return".bas"}getPresets(){return A}pause(){if(!this.pauseResumeSupported){console.log("ZXSpectrumPlatform: Pause not supported");return}console.log("ZXSpectrumPlatform pause() called"),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"pause",pause:!0},"*"),console.log("ZXSpectrumPlatform: Sent pause command to iframe"))}resume(){if(!this.pauseResumeSupported){console.log("ZXSpectrumPlatform: Resume not supported");return}console.log("ZXSpectrumPlatform resume() called"),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"pause",pause:!1},"*"),console.log("ZXSpectrumPlatform: Sent resume command to iframe"))}loadROM(n,t){var p,h,l,g,u,w,P,x,b;if(console.log("ZXSpectrumPlatform loadROM called with title:",n,"rom type:",typeof t,"rom length:",t instanceof Uint8Array?t.length:"N/A"),!this.iframe){console.error("ZXSpectrumPlatform: iframe not ready");return}if(t instanceof Uint8Array){let o=t.length;for(let s=t.length-1;s>=0;s--)if(t[s]!==0){o=s+1;break}o<t.length?(console.log(`ZXSpectrumPlatform: Trimming binary from ${t.length} to ${o} bytes (removed ${t.length-o} trailing zeros)`),this.originalBinary=t.slice(0,o)):this.originalBinary=new Uint8Array(t),console.log("ZXSpectrumPlatform: Stored original binary for download:",this.originalBinary.length,"bytes")}else this.originalBinary=null;let e=(p=window.IDE)==null?void 0:p.getCurrentMainFilename;if(e)this.originalFilename=e();else{let o=(h=window.IDE)==null?void 0:h.current_project;o&&o.mainPath?this.originalFilename=o.mainPath:this.originalFilename=n}let i;if(t&&typeof t=="object"&&!(t instanceof Uint8Array)){console.log("ZXSpectrumPlatform: Detected BASIC AST, getting source file");let o=null;if(e&&(o=e()),!o){let c=(l=window.IDE)==null?void 0:l.current_project;c&&c.mainPath&&(o=c.mainPath)}if(!o){let c=(g=window.IDE)==null?void 0:g.getCurrentProject;if(c){let y=c();y&&y.mainPath&&(o=y.mainPath)}}!o&&n&&(n.includes(".")||n.length<50)&&(o=n),o||(console.warn("ZXSpectrumPlatform: Could not get current filename. Title was:",n),o=n);let s=null;if(this.sourceFileFetch&&o){let c=this.sourceFileFetch(o);c&&typeof c=="string"&&(s=c)}if(!s){let c=(u=window.IDE)==null?void 0:u.current_project;c&&c.filedata&&o&&(s=c.filedata[o])}if(!s){let c=(w=window.IDE)==null?void 0:w.getCurrentProject;if(c){let y=c();y&&y.filedata&&o&&(s=y.filedata[o])}}if(s&&typeof s=="string")i=new TextEncoder().encode(s),console.log("ZXSpectrumPlatform: Using source file text from",o+",",i.length,"bytes");else{console.error("ZXSpectrumPlatform: Could not find source file for",o,"- tried sourceFileFetch and project.filedata");return}}else if(t instanceof Uint8Array)this.originalBinary&&this.originalBinary.length<t.length?(i=this.originalBinary,console.log("ZXSpectrumPlatform: Using trimmed binary data,",i.length,"bytes (original was",t.length,"bytes)")):(i=t,console.log("ZXSpectrumPlatform: Using binary data,",i.length,"bytes"));else{console.error("ZXSpectrumPlatform: Unexpected rom type:",typeof t);return}let r=null;if(e&&(r=e()),!r){let o=(P=window.IDE)==null?void 0:P.current_project;o&&o.mainPath&&(r=o.mainPath)}let a="application/x.zx.tap";if(i.length>0){if(i[0]===19)a="application/x.zx.tap",console.log("ZXSpectrumPlatform: TAP file detected (likely from z88dk), using as-is");else if(i.length>30&&i[0]===3&&i[1]===0)a="application/x.zx.z80";else if(i.length>27&&i[0]===63)a="application/x.zx.sna";else if(r&&(r.endsWith(".c")||r.endsWith(".C"))){console.log("ZXSpectrumPlatform: C program binary detected (not TAP), wrapping in CODE block");let o=((x=r.split("/").pop())==null?void 0:x.replace(/\.[^.]*$/,""))||"PROGRAM";i=this.createCodeTAPFile(i,o,32768),a="application/x.zx.tap"}else if(i.length>1024){let o=r&&((b=r.split("/").pop())==null?void 0:b.replace(/\.[^.]*$/,""))||"PROGRAM";i=this.createCodeTAPFile(i,o,32768),a="application/x.zx.tap"}}let m;if(i.length>65536){let o=[];for(let s=0;s<i.length;s+=8192){let c=i.slice(s,Math.min(s+8192,i.length));o.push(String.fromCharCode(...c))}m=btoa(o.join(""))}else m=btoa(String.fromCharCode(...i));let d=`data:${a};base64,${m}`;console.log("ZXSpectrumPlatform: Created data URL with content type:",a),console.log("ZXSpectrumPlatform: Data URL length:",d.length,"bytes (original:",i.length,"bytes)");let f=()=>{var o;if(this.iframe&&this.iframe.contentWindow){let s=r;if(!s&&e&&(s=e()),!s){let c=(o=window.IDE)==null?void 0:o.current_project;c&&c.mainPath&&(s=c.mainPath)}console.log("ZXSpectrumPlatform: Sending load command, filename:",s,"contentType:",a),this.iframe.contentWindow.postMessage({cmd:"load",url:d,contentType:a,data:Array.from(i),filename:s},"*"),console.log("ZXSpectrumPlatform: Sent load command to iframe with data URL and content type:",a)}else console.warn("ZXSpectrumPlatform: Iframe not ready, retrying..."),setTimeout(f,100)};setTimeout(f,100)}getROMExtension(n){var i,r;if(n&&n.length>0&&n[0]===19)return".tap";if(n&&n.length>30&&n[0]===3&&n[1]===0)return".z80";let t=null,e=(i=window.IDE)==null?void 0:i.getCurrentMainFilename;if(e&&(t=e()),!t){let a=(r=window.IDE)==null?void 0:r.current_project;a&&a.mainPath&&(t=a.mainPath)}return t&&(t.endsWith(".c")||t.endsWith(".C"))?".z80":".tap"}createCodeTAPFile(n,t,e){var g;let i=((g=t.split("/").pop())==null?void 0:g.replace(/\.[^.]*$/,""))||"PROGRAM",r=new Uint8Array(10);r.fill(32);for(let u=0;u<Math.min(i.length,10);u++)r[u]=i.toUpperCase().charCodeAt(u);let a=n.length,m=new Uint8Array(17);m[0]=3,m.set(r,1),m[11]=a&255,m[12]=a>>8&255,m[13]=e&255,m[14]=e>>8&255,m[15]=128,m[16]=0;let d=0;for(let u=0;u<17;u++)d^=m[u];let f=new Uint8Array(1+2+17+1);f[0]=19,f[1]=17,f[2]=0,f.set(m,3),f[3+17]=d;let p=new Uint8Array(1+2+a+1);p[0]=255,p[1]=a&255,p[2]=a>>8&255,p.set(n,3);let h=255;h^=a&255,h^=a>>8&255;for(let u=0;u<a;u++)h^=n[u];p[3+a]=h;let l=new Uint8Array(f.length+p.length);return l.set(f,0),l.set(p,f.length),l}getFileType(n){let t=n.toLowerCase();return t.endsWith(".tap")?"tap":t.endsWith(".z80")?"z80":t.endsWith(".sna")?"sna":t.endsWith(".rom")?"rom":t.endsWith(".scr")?"scr":"tap"}setupCompilationListener(){let n=window.setCompileOutput;n&&(window.setCompileOutput=t=>{n(t),t&&t.output&&!t.errors&&console.log("ZXSpectrumPlatform: Compilation detected, reloading program")})}updateControlButtons(){let n=document.querySelector('[data-action="pause"]'),t=document.querySelector('[data-action="resume"]');n&&(n.style.display=this.pauseResumeSupported?"":"none"),t&&(t.style.display=this.pauseResumeSupported?"":"none")}getDownloadFile(){if(this.originalBinary){console.log("ZXSpectrumPlatform: getDownloadFile() called, returning original binary:",this.originalBinary.length,"bytes");let n=".bin";if(this.originalFilename){let e=this.originalFilename.toLowerCase();e.endsWith(".bas")?n=".tap":e.endsWith(".c")?n=".bin":n=this.getROMExtension(this.originalBinary)}else n=this.getROMExtension(this.originalBinary);let t=new Blob([this.originalBinary],{type:"application/octet-stream"});return{extension:n,blob:t}}console.log("ZXSpectrumPlatform: getDownloadFile() called, but no original binary available")}loadState(n){console.log("ZXSpectrumPlatform: loadState not yet implemented")}saveState(){return console.log("ZXSpectrumPlatform: saveState not yet implemented"),null}createZ80Snapshot(n,t){let e=new Uint8Array(30);e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=255,e[10]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=0,e[16]=0,e[17]=0,e[18]=0,e[19]=0,e[20]=0,e[21]=0,e[22]=0,e[23]=58,e[24]=92,e[25]=0,e[26]=0,e[27]=0,e[28]=0,e[29]=0,e[27]=1,e[28]=1,e[29]=1;let i=new Uint8Array(23);i[0]=t&255,i[1]=t>>8&255;let r=new Uint8Array(25);r[0]=23&255,r[1]=23>>8&255,r.set(i,2);let a=new Uint8Array(49152);for(let l=0;l<6912;l++)a[l]=0;for(let l=6912;l<7168;l++)a[l]=71;for(let l=7168;l<7424;l++)a[l]=0;let m=t-16384;m>=0&&m+n.length<=a.length?a.set(n,m):console.warn(`ZXSpectrumPlatform: Code doesn't fit in RAM at address 0x${t.toString(16)}`);let d=[];for(let l=0;l<3;l++){let g=l*16384,u=g+16384,w=a.slice(g,u),P=w.length,x=new Uint8Array(2+P);x[0]=P&255,x[1]=P>>8&255,x.set(w,2),d.push(x)}let f=e.length+r.length;for(let l of d)f+=l.length;let p=new Uint8Array(f);p.set(e,0),p.set(r,e.length);let h=e.length+r.length;for(let l of d)p.set(l,h),h+=l.length;return console.log(`ZXSpectrumPlatform: Created Z80 snapshot: ${p.length} bytes (header: ${e.length}, blocks: ${d.map(l=>l.length).join(", ")})`),p}compressZ80RAM(n){let t=[],e=0;for(;e<n.length;){let i=n[e];if(i===237){e+1<n.length&&n[e+1]===237?(t.push(237,237,0),e++):t.push(237,237,0),e++;continue}let r=1;for(;e+r<n.length&&n[e+r]===i&&r<255;)r++;if(r>=4)t.push(237,237,r,i),e+=r;else{for(let a=0;a<r;a++)t.push(n[e+a]);e+=r}}return new Uint8Array(t)}};S.zxspectrum=F;var D=F;export{F as ZXSpectrumPlatform,D as default};
//# sourceMappingURL=zxspectrum-LQ2C2FVV.js.map
