import{H as f}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";var u=[{id:"hello.bas",name:"Hello World (BASIC)",category:"BASIC Tutorial"},{id:"colors.bas",name:"Color Demo (BASIC)"},{id:"graphics.bas",name:"Graphics Demo (BASIC)"},{id:"keyboard.bas",name:"Keyboard Demo (BASIC)"},{id:"game.bas",name:"Simple Game (BASIC)"}],m=class{constructor(t){this.iframe=null;this.emulatorReady=!1;this.lastLoadedProgram=null;this.isLoadingProgram=!1;this.mainElement=t,window.addEventListener("message",e=>{e.data&&e.data.type==="apple2e_ready"?(console.log("Apple2EPlatform: Emulator ready"),this.emulatorReady=!0,setTimeout(()=>{console.log("Apple2EPlatform: Emulator fully ready, can accept ROM loads")},200)):e.data&&e.data.type==="apple2e_error"&&(console.error("Apple2EPlatform: Emulator error:",e.data.error),this.emulatorReady=!1)})}getName(){return"Apple IIe"}getDescription(){return"Apple IIe - 6502-based personal computer"}async init(){console.log("Apple2EPlatform init() called")}start(){console.log("Apple2EPlatform start() called"),this.iframe=document.createElement("iframe"),this.iframe.id="apple2e-iframe",this.iframe.style.width="100%",this.iframe.style.height="600px",this.iframe.style.border="1px solid #ccc",this.iframe.style.backgroundColor="#000",this.iframe.setAttribute("tabindex","0"),this.iframe.setAttribute("allow","pointer-events"),console.log("Apple2EPlatform: Iframe will handle its own events"),this.iframe.addEventListener("focus",e=>{e.stopPropagation()},!0),this.iframe.addEventListener("click",e=>{e.stopPropagation()},!0),this.mainElement.innerHTML="",this.mainElement.appendChild(this.iframe),this.mainElement.style.pointerEvents="auto",this.mainElement.style.userSelect="none",this.iframe.style.pointerEvents="auto",this.iframe.style.border="1px solid #ccc",console.log("Apple2EPlatform: Iframe created, clicks should pass through to iframe"),this.iframe.src="apple2e-iframe.html",console.log("Apple2EPlatform: iframe created and loading");let t=setInterval(()=>{this.emulatorReady&&this.iframe&&this.iframe.contentWindow&&(clearInterval(t),console.log("Apple2EPlatform: Auto-resetting emulator on start for clean BASIC prompt"),this.reset())},100);setTimeout(()=>clearInterval(t),1e4)}stop(){console.log("Apple2EPlatform stop() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"stop"},"*")}reset(){console.log("Apple2EPlatform reset() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"reset"},"*")}isRunning(){return this.emulatorReady}getToolForFilename(t){return t.toLowerCase().endsWith(".bas"),"applesoftbasic"}getDefaultExtension(){return".bas"}getPresets(){return u}pause(){console.log("Apple2EPlatform pause() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"stop"},"*")}break(){console.log("Apple2EPlatform break() called (Ctrl+C / BRK)"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"break"},"*")}resume(){console.log("Apple2EPlatform resume() called"),this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage({type:"run"},"*");let t=this.getApple2API();t&&t.apple2&&!t.apple2.isRunning()&&t.apple2.run()}getApple2API(){if(!this.iframe||!this.iframe.contentWindow)return console.warn("Apple2EPlatform: iframe not available"),null;try{let t=this.iframe.contentWindow;return!t.apple2&&!t.APPLE2_API?(console.warn("Apple2EPlatform: apple2 API not available in iframe yet"),null):{get apple2(){var e;return t.apple2||((e=t.APPLE2_API)==null?void 0:e.apple2)},getIO:()=>{var o;let e=t.apple2||((o=t.APPLE2_API)==null?void 0:o.apple2);if(!e)return console.error("Apple2EPlatform: Cannot getIO - emulator not available"),null;let r=e.getIO();return r?(console.log("Apple2EPlatform: getIO() returned:",{hasSetKeyBuffer:typeof r.setKeyBuffer=="function",hasKeyDown:typeof r.keyDown=="function",methods:Object.keys(r).filter(a=>typeof r[a]=="function")}),r):(console.error("Apple2EPlatform: getIO() returned null"),null)},getCPU:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);return e?e.getCPU():null},setAcceleration:e=>{let r=t.APPLE2_API;r&&r.setAcceleration?r.setAcceleration(e):console.error("Apple2EPlatform: setAcceleration not available")},getAcceleration:()=>{let e=t.APPLE2_API;return e&&e.getAcceleration?e.getAcceleration():!1},reset:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);return e?(console.log("Apple2EPlatform: Resetting emulator (enters BASIC)..."),e.reset(),setTimeout(()=>{e.isRunning()||(console.log("Apple2EPlatform: Starting emulator after reset"),e.run()),console.log("Apple2EPlatform: Reset complete, BASIC prompt should be ready")},100),!0):(console.error("Apple2EPlatform: Cannot reset - emulator not available"),!1)},run:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);e&&e.run()},stop:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);e&&e.stop()},isRunning:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);return e?e.isRunning():!1},type:e=>{var i;let r=t.apple2||((i=t.APPLE2_API)==null?void 0:i.apple2);if(!r)return console.error("Apple2EPlatform: Cannot type - emulator not available"),console.log("Available in iframe:",{apple2:!!t.apple2,APPLE2_API:!!t.APPLE2_API}),!1;console.log("Apple2EPlatform: Typing text:",e.substring(0,50)),console.log("Apple2EPlatform: Emulator running?",r.isRunning());let o=r.getIO();if(!o)return console.error("Apple2EPlatform: Cannot type - getIO() returned null"),!1;if(!o.setKeyBuffer)return console.error("Apple2EPlatform: Cannot type - io.setKeyBuffer is not a function"),console.log("IO object:",Object.keys(o)),!1;console.log("Apple2EPlatform: Resetting emulator to enter BASIC..."),r.reset(),r.isRunning()||(console.log("Apple2EPlatform: Starting emulator after reset..."),r.run()),console.log("Apple2EPlatform: Waiting for BASIC prompt..."),setTimeout(()=>{a(o,e)},1200);function a(c,p){console.log("Apple2EPlatform: Sending text:",JSON.stringify(p.substring(0,80)));try{let s=t.document.querySelector("#screen");s&&s.focus&&(s.focus(),console.log("Apple2EPlatform: Focused canvas in iframe for keyboard input"))}catch(n){console.warn("Apple2EPlatform: Could not focus canvas (cross-origin?):",n)}let l=p;/^\d+\s/.test(p.trim())&&(l=p.replace(/\r\n/g,"\r").replace(/\n/g,"\r"),l.startsWith("\r")||(l="\r"+l),l.endsWith("\r")||(l+="\r"),l+="RUN\r",console.log("Apple2EPlatform: Formatted BASIC program:",JSON.stringify(l.substring(0,100)))),setTimeout(()=>{try{c.setKeyBuffer(l),console.log("Apple2EPlatform: \u2705 setKeyBuffer called with formatted text"),console.log("Apple2EPlatform: Program sent to emulator"),setTimeout(()=>{var s;let n=t.apple2||((s=t.APPLE2_API)==null?void 0:s.apple2);n&&(console.log("Apple2EPlatform: Resetting emulator after program sent (for clean state)..."),n.reset(),n.isRunning()||n.run(),console.log("Apple2EPlatform: Reset complete, ready for next program"),setTimeout(()=>{this.lastLoadedProgram=null},500))},500)}catch(n){console.error("Apple2EPlatform: setKeyBuffer failed:",n)}},100)}return!0},getVideoModes:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);return e?e.getVideoModes():null},getStats:()=>{var r;let e=t.apple2||((r=t.APPLE2_API)==null?void 0:r.apple2);return e?e.getStats():null},break:()=>{var o;let e=t.apple2||((o=t.APPLE2_API)==null?void 0:o.apple2);if(!e)return console.error("Apple2EPlatform: Cannot break - emulator not available"),!1;if(this.iframe&&this.iframe.contentWindow)return console.log("Apple2EPlatform: Sending break command to iframe (will handle focus)"),this.iframe.contentWindow.postMessage({type:"break"},"*"),!0;let r=e.getIO();if(!r)return console.error("Apple2EPlatform: Cannot break - getIO() returned null"),!1;console.log("Apple2EPlatform: Sending BRK (Ctrl+C) to interrupt program...");try{return r.keyDown(3),setTimeout(()=>{r.keyUp&&r.keyUp()},50),console.log("Apple2EPlatform: \u2705 BRK sent"),!0}catch(a){return console.error("Apple2EPlatform: Error sending BRK:",a),!1}}}}catch(t){return console.error("Apple2EPlatform: Error accessing iframe API:",t),null}}loadROM(t,e){if(console.log("Apple2EPlatform loadROM() called",{title:t,romLength:e==null?void 0:e.length}),!e||e.length===0){console.warn("Apple2EPlatform: No ROM data provided");return}let o=new TextDecoder().decode(e).substring(0,50);if(this.isLoadingProgram){console.warn("Apple2EPlatform: Already loading a program, ignoring duplicate request");return}if(this.lastLoadedProgram===o){console.warn("Apple2EPlatform: Same program already loaded, ignoring duplicate request");return}if(this.isLoadingProgram=!0,this.lastLoadedProgram=o,this.iframe&&this.iframe.contentWindow){let a=()=>{if(!this.iframe||!this.iframe.contentWindow){console.error("Apple2EPlatform: iframe lost during wait");return}if(!this.iframe.contentWindow.apple2&&!this.emulatorReady){console.log("Apple2EPlatform: Emulator not ready yet, waiting..."),setTimeout(a,100);return}console.log("Apple2EPlatform: Emulator ready, sending program"),this.sendROMToEmulator(e)};if(this.emulatorReady)console.log("Apple2EPlatform: Emulator ready flag set, verifying..."),setTimeout(a,100);else{console.log("Apple2EPlatform: Emulator not ready yet, waiting...");let i=setInterval(()=>{this.emulatorReady&&this.iframe&&this.iframe.contentWindow&&(clearInterval(i),a())},100);setTimeout(()=>{clearInterval(i),this.emulatorReady?a():console.error("Apple2EPlatform: Timeout waiting for emulator to be ready")},1e4)}}}sendROMToEmulator(t){if(!this.iframe||!this.iframe.contentWindow){console.error("Apple2EPlatform: Cannot send ROM - iframe not available"),this.isLoadingProgram=!1;return}let e=new TextDecoder().decode(t);console.log("Apple2EPlatform: Sending program to iframe:",e.substring(0,50)),this.iframe.contentWindow.postMessage({type:"load_basic",data:{program:e}},"*"),setTimeout(()=>{this.isLoadingProgram=!1},2e3)}getROMExtension(t){return".bas"}readAddress(t){return 0}writeAddress(t,e){}getMemoryMap(){return{main:[{name:"Zero Page RAM",start:0,size:256,type:"ram"},{name:"Line Input RAM",start:512,size:256,type:"ram"},{name:"Text/Lores Page 1",start:1024,size:1024,type:"ram"},{name:"Hires Page 1",start:8192,size:8192,type:"ram"},{name:"Hires Page 2",start:16384,size:8192,type:"ram"},{name:"I/O",start:49152,size:4096,type:"io"},{name:"ROM",start:53248,size:12288,type:"rom"}]}}showHelp(){return"https://github.com/whscullin/apple2js#readme"}};f.apple2e=m;var P=m;export{m as Apple2EPlatform,P as default};
//# sourceMappingURL=apple2e-KIOBA4IE.js.map
