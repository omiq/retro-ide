import{D as b}from"./chunk-LJINFNAP.js";import{H as C}from"./chunk-KXQZZRQB.js";import"./chunk-WAARL7ET.js";var E=[{id:"hello.bas",name:"Hello World (BASIC)",category:"BASIC"}],S=class{constructor(n){this.iframe=null;this.currentModel="48k";this.pauseResumeSupported=!0;this.blobUrls=[];this.mainElement=n,window.addEventListener("message",t=>{t.data&&t.data.type==="emulator_capabilities"&&(console.log("ZXSpectrumPlatform: Received emulator capabilities:",t.data.capabilities),t.data.capabilities&&typeof t.data.capabilities.pause=="boolean"&&(this.pauseResumeSupported=t.data.capabilities.pause),this.updateControlButtons())})}async start(){console.log("ZXSpectrumPlatform start() called"),this.iframe=document.createElement("iframe"),this.iframe.id="zxspectrum-iframe",this.iframe.style.width="100%",this.iframe.style.height="600px",this.iframe.style.border="1px solid #ccc",this.iframe.style.backgroundColor="#000",this.iframe.setAttribute("tabindex","-1"),this.iframe.addEventListener("focus",t=>{t.stopPropagation()},!0),this.iframe.addEventListener("click",t=>{t.stopPropagation()},!0),this.mainElement.innerHTML="",this.mainElement.appendChild(this.iframe);let n=`?t=${Date.now()}`;this.iframe.src=`zxspectrum-iframe.html${n}`,console.log("ZXSpectrumPlatform: iframe created and qaop loading"),this.setupCompilationListener(),this.updateControlButtons()}stop(){console.log("ZXSpectrumPlatform stop() called")}reset(){console.log("ZXSpectrumPlatform reset() called"),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"reset"},"*"),console.log("ZXSpectrumPlatform: Sent reset command to iframe"))}isRunning(){return this.iframe!==null}getToolForFilename(n){return n.toLowerCase().endsWith(".bas")?"zxbasic":b(n)}getDefaultExtension(){return".bas"}getPresets(){return E}pause(){if(!this.pauseResumeSupported){console.log("ZXSpectrumPlatform: Pause not supported");return}console.log("ZXSpectrumPlatform pause() called"),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"pause",pause:!0},"*"),console.log("ZXSpectrumPlatform: Sent pause command to iframe"))}resume(){if(!this.pauseResumeSupported){console.log("ZXSpectrumPlatform: Resume not supported");return}console.log("ZXSpectrumPlatform resume() called"),this.iframe&&this.iframe.contentWindow&&(this.iframe.contentWindow.postMessage({cmd:"pause",pause:!1},"*"),console.log("ZXSpectrumPlatform: Sent resume command to iframe"))}loadROM(n,t){var u,h,r,x,m,w,y,F;if(console.log("ZXSpectrumPlatform loadROM called with title:",n,"rom type:",typeof t),!this.iframe){console.error("ZXSpectrumPlatform: iframe not ready");return}let e;if(t&&typeof t=="object"&&!(t instanceof Uint8Array)){console.log("ZXSpectrumPlatform: Detected BASIC AST, getting source file");let a=null,g=(u=window.IDE)==null?void 0:u.getCurrentMainFilename;if(g&&(a=g()),!a){let s=(h=window.IDE)==null?void 0:h.current_project;s&&s.mainPath&&(a=s.mainPath)}if(!a){let s=(r=window.IDE)==null?void 0:r.getCurrentProject;if(s){let P=s();P&&P.mainPath&&(a=P.mainPath)}}!a&&n&&(n.includes(".")||n.length<50)&&(a=n),a||(console.warn("ZXSpectrumPlatform: Could not get current filename. Title was:",n),a=n);let p=null;if(this.sourceFileFetch&&a){let s=this.sourceFileFetch(a);s&&typeof s=="string"&&(p=s)}if(!p){let s=(x=window.IDE)==null?void 0:x.current_project;s&&s.filedata&&a&&(p=s.filedata[a])}if(!p){let s=(m=window.IDE)==null?void 0:m.getCurrentProject;if(s){let P=s();P&&P.filedata&&a&&(p=P.filedata[a])}}if(p&&typeof p=="string")e=new TextEncoder().encode(p),console.log("ZXSpectrumPlatform: Using source file text from",a+",",e.length,"bytes");else{console.error("ZXSpectrumPlatform: Could not find source file for",a,"- tried sourceFileFetch and project.filedata");return}}else if(t instanceof Uint8Array)e=t,console.log("ZXSpectrumPlatform: Using binary data,",e.length,"bytes");else{console.error("ZXSpectrumPlatform: Unexpected rom type:",typeof t);return}let l=null,i=(w=window.IDE)==null?void 0:w.getCurrentMainFilename;if(i&&(l=i()),!l){let a=(y=window.IDE)==null?void 0:y.current_project;a&&a.mainPath&&(l=a.mainPath)}let o="application/x.zx.tap";if(e.length>0){if(e[0]===19)o="application/x.zx.tap";else if(e.length>30&&e[0]===3&&e[1]===0)o="application/x.zx.z80";else if(e.length>27&&e[0]===63)o="application/x.zx.sna";else if(l&&(l.endsWith(".c")||l.endsWith(".C")))e=this.createZ80Snapshot(e,32768),o="application/x.zx.z80";else if(e.length>1024){let a=l&&((F=l.split("/").pop())==null?void 0:F.replace(/\.[^.]*$/,""))||"PROGRAM";e=this.createCodeTAPFile(e,a,32768),o="application/x.zx.tap"}}let c;if(e.length>65536){let a=[];for(let g=0;g<e.length;g+=8192){let p=e.slice(g,Math.min(g+8192,e.length));a.push(String.fromCharCode(...p))}c=btoa(a.join(""))}else c=btoa(String.fromCharCode(...e));let d=`data:${o};base64,${c}`;console.log("ZXSpectrumPlatform: Created data URL with content type:",o),console.log("ZXSpectrumPlatform: Data URL length:",d.length,"bytes (original:",e.length,"bytes)");let f=()=>{var a,g;if(this.iframe&&this.iframe.contentWindow){let p=l;if(!p){let s=(a=window.IDE)==null?void 0:a.getCurrentMainFilename;s&&(p=s())}if(!p){let s=(g=window.IDE)==null?void 0:g.current_project;s&&s.mainPath&&(p=s.mainPath)}this.iframe.contentWindow.postMessage({cmd:"load",url:d,contentType:o,data:Array.from(e),filename:p},"*"),console.log("ZXSpectrumPlatform: Sent load command to iframe with data URL and content type:",o)}else console.warn("ZXSpectrumPlatform: Iframe not ready, retrying..."),setTimeout(f,100)};setTimeout(f,100)}getROMExtension(n){var l,i;if(n&&n.length>0&&n[0]===19)return".tap";if(n&&n.length>30&&n[0]===3&&n[1]===0)return".z80";let t=null,e=(l=window.IDE)==null?void 0:l.getCurrentMainFilename;if(e&&(t=e()),!t){let o=(i=window.IDE)==null?void 0:i.current_project;o&&o.mainPath&&(t=o.mainPath)}return t&&(t.endsWith(".c")||t.endsWith(".C"))?".z80":".tap"}createCodeTAPFile(n,t,e){var x;let l=((x=t.split("/").pop())==null?void 0:x.replace(/\.[^.]*$/,""))||"PROGRAM",i=new Uint8Array(10);i.fill(32);for(let m=0;m<Math.min(l.length,10);m++)i[m]=l.toUpperCase().charCodeAt(m);let o=n.length,c=new Uint8Array(17);c[0]=3,c.set(i,1),c[11]=o&255,c[12]=o>>8&255,c[13]=e&255,c[14]=e>>8&255,c[15]=128,c[16]=0;let d=0;for(let m=0;m<17;m++)d^=c[m];let f=new Uint8Array(1+2+17+1);f[0]=19,f[1]=17,f[2]=0,f.set(c,3),f[3+17]=d;let u=new Uint8Array(1+2+o+1);u[0]=255,u[1]=o&255,u[2]=o>>8&255,u.set(n,3);let h=255;h^=o&255,h^=o>>8&255;for(let m=0;m<o;m++)h^=n[m];u[3+o]=h;let r=new Uint8Array(f.length+u.length);return r.set(f,0),r.set(u,f.length),r}getFileType(n){let t=n.toLowerCase();return t.endsWith(".tap")?"tap":t.endsWith(".z80")?"z80":t.endsWith(".sna")?"sna":t.endsWith(".rom")?"rom":t.endsWith(".scr")?"scr":"tap"}setupCompilationListener(){let n=window.setCompileOutput;n&&(window.setCompileOutput=t=>{n(t),t&&t.output&&!t.errors&&console.log("ZXSpectrumPlatform: Compilation detected, reloading program")})}updateControlButtons(){let n=document.querySelector('[data-action="pause"]'),t=document.querySelector('[data-action="resume"]');n&&(n.style.display=this.pauseResumeSupported?"":"none"),t&&(t.style.display=this.pauseResumeSupported?"":"none")}loadState(n){console.log("ZXSpectrumPlatform: loadState not yet implemented")}saveState(){return console.log("ZXSpectrumPlatform: saveState not yet implemented"),null}createZ80Snapshot(n,t){let e=new Uint8Array(30);e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=255,e[9]=255,e[10]=0,e[11]=0,e[12]=32,e[13]=0,e[14]=0,e[15]=0,e[16]=0,e[17]=0,e[18]=0,e[19]=0,e[20]=0,e[21]=0,e[22]=0,e[23]=0,e[24]=0,e[25]=0,e[26]=0,e[27]=0,e[28]=0,e[29]=0,e[27]=1,e[28]=1,e[29]=1;let l=new Uint8Array(23);l[0]=t&255,l[1]=t>>8&255;let i=new Uint8Array(25);i[0]=23&255,i[1]=23>>8&255,i.set(l,2);let o=new Uint8Array(49152);for(let r=0;r<6912;r++)o[r]=0;for(let r=6912;r<7168;r++)o[r]=71;for(let r=7168;r<7424;r++)o[r]=0;let c=t-16384;c>=0&&c+n.length<=o.length?o.set(n,c):console.warn(`ZXSpectrumPlatform: Code doesn't fit in RAM at address 0x${t.toString(16)}`);let d=[];for(let r=0;r<3;r++){let x=r*16384,m=x+16384,w=o.slice(x,m),y=this.compressZ80RAM(w),F=new Uint8Array(2+y.length);F[0]=y.length&255,F[1]=y.length>>8&255,F.set(y,2),d.push(F)}let f=e.length+i.length;for(let r of d)f+=r.length;let u=new Uint8Array(f);u.set(e,0),u.set(i,e.length);let h=e.length+i.length;for(let r of d)u.set(r,h),h+=r.length;return console.log(`ZXSpectrumPlatform: Created Z80 snapshot: ${u.length} bytes (header: ${e.length}, blocks: ${d.map(r=>r.length).join(", ")})`),u}compressZ80RAM(n){let t=[],e=0;for(;e<n.length;){let l=n[e];if(l===237){e+1<n.length&&n[e+1]===237?(t.push(237,237,0),e++):t.push(237,237,0),e++;continue}let i=1;for(;e+i<n.length&&n[e+i]===l&&i<255;)i++;if(i>=4)t.push(237,237,i,l),e+=i;else{for(let o=0;o<i;o++)t.push(n[e+o]);e+=i}}return new Uint8Array(t)}};C.zxspectrum=S;var D=S;export{S as ZXSpectrumPlatform,D as default};
//# sourceMappingURL=zxspectrum-ZDALLGOF.js.map
