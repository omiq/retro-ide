import{b as w,c as E}from"./chunk-YGHXCPB2.js";import{B as y,H as m,l as u,m as g,v as p,x as v}from"./chunk-KXQZZRQB.js";import{e as S}from"./chunk-WAARL7ET.js";var h=S(E()),s,n,l,k=function(e){if(!e||e.length==0)return{};for(var r={},o=0;o<e.length;++o){var t=e[o].split("=",2);t.length==1?r[t[0]]="":r[t[0]]=decodeURIComponent(t[1].replace(/\+/g," "))}return r}(window.location.search.substr(1).split("&"));function x(){typeof window.onerror=="object"&&(window.onerror=function(e,r,o,t,a){var i=e+" "+r+"  "+o+":"+t+", "+a;$.get("/error?msg="+encodeURIComponent(i),"text")})}function M(){var e=!1;document.addEventListener("visibilitychange",function(r){document.visibilityState=="hidden"&&n.isRunning()?(n.pause(),e=!0):document.visibilityState=="visible"&&e&&(n.resume(),e=!1)}),$(window).on("focus",function(){e&&(n.resume(),e=!1)}),$(window).on("blur",function(){n.isRunning()&&(n.pause(),e=!0)})}async function R(e,r){if(!r){alert("No ROM found.");return}console.log(r.length+" bytes"),await n.loadROM(e,r),n.resume()}function b(){var e=document.getElementById("canvas");if(e)return $(e);var r=document.getElementById("c64-chips-screen");if(r){var o=r.querySelector("canvas");if(o)return $(o)}var t=document.getElementById("vic20-chips-screen");if(t){var a=t.querySelector("canvas");if(a)return $(a)}var i=document.getElementById("javatari-screen");if(i){var f=i.querySelector("canvas");if(f)return $(f)}var c=document.getElementById("emuscreen");if(c){var d=c.querySelector("canvas");if(d)return $(d)}return $("#emulator").find("canvas")}function P(e,r,o){y("gif.js/dist/gif.js").then(()=>{var t=b()[0];if(!t){alert("Could not find canvas element to record video!");return}var a=0;t.style&&t.style.transform&&(t.style.transform.indexOf("rotate(-90deg)")>=0?a=-1:t.style.transform.indexOf("rotate(90deg)")>=0&&(a=1));var i=new GIF({workerScript:"gif.js/dist/gif.worker.js",workers:4,quality:10,rotate:a});i.on("finished",function(d){console.log("finished encoding GIF"),o(d)}),e=e||100+(Math.random()*256&3),r=r||100+(Math.random()*256&15);var f=0;console.log("Recording video",t);var c=()=>{f++>r?(console.log("Rendering video"),i.render()):(i.addFrame(t,{delay:e,copy:!0}),setTimeout(c,e))};c()})}async function C(e){if(!m[s])throw Error("Invalid platform '"+s+"'.");n=new m[s]($("#emuscreen")[0]),await n.start(),e.rec&&b().on("focus",()=>{n.resume()});var r=e.n||"Game",o,t=e.url,a=e.r;if(t)return console.log(t),p(t,c=>{R(r,c)},"arraybuffer"),!0;if(a){var i=g(atob(a)),f=new u().decode(i);o=new Uint8Array(f)}return M(),R(r,o),!0}async function I(e){if(e.data&&(e=e.data),s=e.p,!s)throw new Error("No platform variable!");try{var r=await w(v(s));console.log("starting platform",s),await C(e)}catch(o){console.log(o),alert('Platform "'+s+'" not supported.')}}function B(){x(),k.p&&I(k)}window.addEventListener("message",j,!1);function j(e){if(e.data){var r=e.data.cmd;if(r=="start"&&!n)I(e);else if(r=="reset")n.reset(),l.reset();else if(r=="getReplay"){var o={frameCount:l.frameCount,checkpoints:l.checkpoints,framerecs:l.framerecs,checkpointInterval:l.checkpointInterval,maxCheckpoints:l.maxCheckpoints};e.source.postMessage({ack:r,replay:o},e.origin)}else if(r=="watchState"){var t=new Function("platform","state",e.data.fn);l.callbackNewCheckpoint=a=>{e.source.postMessage({ack:r,state:t(n,a)},e.origin)}}else r=="recordVideo"?P(e.data.intervalMsec,e.data.maxFrames,function(a){e.data.filename&&(0,h.saveAs)(a,e.data.filename),e.source.postMessage({ack:r,gif:a},e.origin)}):console.log("Unknown data.cmd: "+r)}}self===top&&(document.body.style.backgroundColor="#555");B();export{n as platform,s as platform_id,B as startEmbed,l as stateRecorder};
//# sourceMappingURL=embedui.js.map
