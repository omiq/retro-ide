Polymer("tss",{ready:function(){var e={},t=function(e,t){this.lastLevel="",this.reverse=t,this.print=function(e){};if(e==undefined){if(typeof window=="undefined"||window.console!=undefined)this.print=function(e){console.log(e)}}else if(e!=null){this.frameDiv=document.getElementById(e);if(this.frameDiv==undefined)return;this.framePre=document.createElement("pre"),this.frameDiv.appendChild(this.framePre),this.print=function(e){window.console!=undefined&&console.log(e);var t;if(e instanceof Object){t=document.createElement("pre");var n=e.toString(),r=document.createTextNode(n);t.appendChild(r);var i="";for(var s in e)i+=s+":"+e[s]+"; \n";t.setAttribute("title",i)}else t=document.createTextNode(e+"\n");this.reverse&&this.framePre.firstChild?this.framePre.insertBefore(t,this.framePre.firstChild):this.framePre.appendChild(t)}}};t.log=new t,t.setLog=function(e){t.log=e},t.getLog=function(){return t.log},t.prototype.fatal=function(e){this.LastLevel!="FATAL"&&(this.LastLevel="FATAL",this.print("*FATAL*")),this.print(e)},t.prototype.error=function(e){this.LastLevel!="ERROR"&&(this.LastLevel="ERROR",this.print("*ERROR*")),this.print(e)},t.prototype.warn=function(e){this.LastLevel!="WARN"&&(this.LastLevel="WARN",this.print("*WARN*")),this.print(e)},t.prototype.info=function(e){this.LastLevel!="INFO"&&(this.LastLevel="INFO",this.print("*INFO*")),this.print(e)},e.Log=t;var n=function(e){this.bufferSize=4096,e!==undefined&&(this.bufferSize=e),this.channel=null,this.initialized=!0,this.firstAudioEvent=null,this.sampleRate=44100;if(window.webkitAudioContext||window.AudioContext){t.getLog().info("AudioLooper: detect Web Audio API"),this.audioContext=new webkitAudioContext||new AudioContext;if(this.audioContext==null){t.getLog().fatal("AudioLooper: could not create AudioContext"),this.initialized=!1;return}this.sampleRate=this.audioContext.sampleRate,t.getLog().info("AudioLooper: sample rate is "+this.sampleRate),this.bufferSource=this.audioContext.createBufferSource(),this.jsNode=this.audioContext.createScriptProcessor(this.bufferSize,2,2),this.jsNode.onaudioprocess=function(e){this.onAudioProcess(e)}.bind(this),this.bufferSource.noteOn&&this.bufferSource.noteOn(0),this.bufferSource.connect(this.jsNode),this.jsNode.connect(this.audioContext.destination);return}if(window.Audio){t.getLog().info("AudioLooper: detect Audio Data API"),this.audio=new Audio;if(this.audio==null||this.audio["mozSetup"]==undefined){t.getLog().fatal("AudioLooper: could not use Audio Data API"),this.initialized=!1;return}this.audioChannel=2,this.audioFrequency=44100,this.audio.mozSetup(this.audioChannel,this.audioFrequency),this.bufferId=0,this.bufferPage=4,this.bufferWritten=0,this.buffer=new Array(this.bufferPage);var n=this.bufferSize*this.audioChannel;for(var r=0;r<this.bufferPage;r++)this.buffer[r]=new Float32Array(n),this.bufferWritten+=this.audio.mozWriteAudio(this.buffer[r]);this.audio.owner=this;var i=this.bufferSize*1e3/44100/2;setInterval(function(e){e.onAudioInterval()},i,this);return}t.getLog().error("AudioLooper: no known Audio API are available"),this.initialized=!1};n.prototype.getSampleRate=function(){return this.sampleRate},n.prototype.setChannel=function(e){null!=e&&(e.setBufferLength(this.bufferSize*2),e.setSampleRate(this.sampleRate)),this.channel=e},n.prototype.onAudioProcess=function(e){null==this.firstAudioEvent&&(this.firstAudioEvent=!0,t.getLog().info(e));var n=e.outputBuffer.getChannelData(0),r=e.outputBuffer.getChannelData(1),i;if(null==this.channel){for(i=0;i<this.bufferSize;i++)n[i]=0,r[i]=0;return}this.channel.generate(this.bufferSize*2);var s=this.channel.getBuffer();for(i=0;i<this.bufferSize;i++)n[i]=s[i*2+0]/32768,r[i]=s[i*2+1]/32768},n.prototype.onAudioInterval=function(){null==this.firstAudioEvent&&(this.firstAudioEvent=!0,t.getLog().info("onAudioInterval"),t.getLog().info(this));var e=this.audio.mozCurrentSampleOffset(),n=this.bufferSize*this.audioChannel,r=e%(n*this.bufferPage),i=~~(r/n);if(this.bufferId==i&&this.bufferWritten!=e)return;var s=this.buffer[this.bufferId];this.bufferId=(this.bufferId+1)%this.bufferPage;var o;if(null==this.channel)for(o=0;o<this.bufferSize;o++)s[o*2+0]=0,s[o*2+1]=0;else{this.channel.generate(this.bufferSize*this.audioChannel);var u=this.channel.getBuffer();for(o=0;o<this.bufferSize;o++)s[o*2+0]=u[o*2+0]/32768,s[o*2+1]=u[o*2+1]/32768}this.bufferWritten+=this.audio.mozWriteAudio(s)},n.prototype.isActive=function(){return this.audioContext&&this.audioContext["currentTime"]==0?!1:!0},n.prototype.activate=function(){if(this.isActive())return;this.bufferSource.noteOn(0)};var r=function(){this.zL=0,this.zR=0,this.zzL=0,this.zzR=0,this.a0=1,this.a1=0,this.a2=0,this.b0=1,this.b1=0,this.b2=0,this.inBuffer=null,this.outBuffer=null,this.bufferLength=0,this.channel=null,this.sampleRate=o.DEFAULT_SAMPLE_FREQUENCY};r.TYPE_LPF="LPF",r.TYPE_HPF="HPF",r.TYPE_BPF="BPF",r.TYPE_BEF="BEF",r.TYPE_APF="APF",r.TYPE_PEQ="PEQ",r.TYPE_LOS="LOS",r.TYPE_HIS="HIS",r.TYPE_BPF_TYPE1=r.TYPE_BPF,r.TYPE_BPF_TYPE2="BPF2",r.TYPE_NOTCH=r.TYPE_BEF,r.TYPE_EQ=r.TYPE_PEQ,r.TYPE_PEAKING_EQ=r.TYPE_PEQ,r.TYPE_LOW_SHELF=r.TYPE_LOS,r.TYPE_HIGH_SHELF=r.TYPE_HIS,r.prototype.setBufferLength=function(e){this.outBuffer=new Int32Array(e),this.bufferLength=e,null!=this.channel&&(this.channel.setBufferLength(e),this.inBuffer=this.channel.getBuffer())},r.prototype.setSampleRate=function(e){this.sampleRate=e,this.channel&&this.channel.setSampleRate(this.sampleRate)},r.prototype.getBuffer=function(){return this.outBuffer},r.prototype.setChannel=function(e){0!=this.bufferLength&&null!=e&&(e.setBufferLength(this.bufferLength),e.setSampleRate(this.sampleRate),this.inBuffer=e.getBuffer()),this.channel=e},r.prototype.setDirectParameter=function(e,t,n,r,i,s){this.a0=1,this.a1=t/e,this.a2=n/e,this.b0=r/e,this.b1=i/e,this.b2=s/e},r.prototype.setParameter=function(e,n,i,s){var o=2*Math.PI*n/this.sampleRate,u=Math.cos(o),a=Math.sin(o),f=a/2/i;if(r.TYPE_LPF==e){var l=1-u,c=l/2;this.setDirectParameter(1+f,-2*u,1-f,c,l,c)}else if(r.TYPE_HPF==e){var l=1+u,c=l/2;this.setDirectParameter(1+f,-2*u,1-f,c,-l,c)}else if(r.TYPE_BPF_TYPE1==e){var l=a/2;this.setDirectParameter(1+f,-2*u,1-f,l,0,-l)}else if(r.TYPE_BPF_TYPE2==e){var l=f;this.setDirectParameter(1+f,-2*u,1-f,l,0,-l)}else if(r.TYPE_BEF==e){var h=-2*u;this.setDirectParameter(1+f,h,1-f,1,h,1)}else if(r.TYPE_APF==e){var p=1+f,d=-2*u,v=1-f;this.setDirectParameter(p,d,v,v,d,p)}else if(r.TYPE_PEQ==e){var h=Math.pow(10,s/40),m=f/h,c=f*h,d=-2*u;this.setDirectParameter(1+m,d,1-m,1+c,d,1-c)}else if(r.TYPE_LOS==e){var h=Math.pow(10,s/40),g=h+1,y=h-1,b=2*Math.sqrt(h)*f,p=g+y*u+b,d=-2*(y+g*u),v=g+y*u-b,w=h*(g-y*u+b),E=2*h*(y-g*u),S=h*(g-y*u-b);this.setDirectParameter(p,d,v,w,E,S)}else if(r.TYPE_HIS==e){var h=Math.pow(10,s/40),g=h+1,y=h-1,b=2*Math.sqrt(h)*f,p=g-y*u+b,d=2*(y-g*u),v=g-y*u-b,w=h*(g+y*u+b),E=-2*h*(y+g*u),S=h*(g+y*u-b);this.setDirectParameter(p,d,v,w,E,S)}else t.getLog().error("unknown filter type: "+e)},r.prototype.magnitudeResponse=function(e){var t=2*Math.PI*e/this.sampleRate,n=Math.cos(t),r=Math.cos(2*t),i=Math.sin(t),s=Math.sin(2*t),o={r:this.b0+this.b1*n+this.b2*r,i:0-this.b1*i-this.b2*s},u={r:this.a0+this.a1*n+this.a2*r,i:0-this.a1*i-this.a2*s},a=o.r*u.r+o.i*u.i,f=u.r*u.r+u.i*u.i;return a/f},r.prototype.generate=function(e){if(null==this.channel){for(var t=0;t<e;t++)this.outBuffer[t]=0;return}this.channel.generate(e);for(var t=0;t<e;t+=2){var n=this.inBuffer[t+0]-this.a1*this.zL-this.a2*this.zzL,r=this.inBuffer[t+1]-this.a1*this.zR-this.a2*this.zzR;this.outBuffer[t+0]=this.b0*n+this.b1*this.zL+this.b2*this.zzL,this.outBuffer[t+1]=this.b0*r+this.b1*this.zR+this.b2*this.zzR,this.zzL=this.zL,this.zzR=this.zR,this.zL=n,this.zR=r}};var i=function(){this.endian=i.BIG_ENDIAN};i.BIG_ENDIAN=0,i.LITTLE_ENDIAN=1,i.readI32BE=function(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]},i.readU32BE=function(e,t){var n=i.readI32BE(e,t);return n<0?4294967296+n:n},i.readI32LE=function(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24},i.readU32LE=function(e,t){var n=i.readI32LE(e,t);return n<0?4294967296+n:n},i.stringLength=function(e,t){var n=0;for(var r=t;r<e.byteLength;r++){if(0==e[t])break;n++}return n},i.prototype.setDefaultEndian=function(e){this.endian=e},i.prototype.readI32=function(e,t){return this.endian==i.BIG_ENDIAN?i.readI32BE(e,t):i.readI32LE(e,t)},i.prototype.readU32=function(e,t){return this.endian==i.BIG_ENDIAN?i.readU32BE(e,t):i.readU32LE(e,t)};var s=function(){this.type=s.TYPE_NO_CONVERSION,this.inFrequency=44100,this.outFrequency=44100,this.inBuffer=null,this.outBuffer=null,this.bufferLength=0,this.channel=null,this.converter=null,this.filter=null};s.TYPE_NO_CONVERSION=0,s.TYPE_UP_SAMPLING=1,s.TYPE_DOWN_SAMPLING=2,s.prototype.setBufferLength=function(e){this.outBuffer=new Int32Array(e),this.bufferLength=e,this._reconstruct()},s.prototype.setSampleRate=function(e){},s.prototype.getBuffer=function(){return this.outBuffer},s.prototype.setChannel=function(e){this.channel=e,this._reconstruct()},s.prototype.setInputFrequency=function(e){this.inFrequency=e,this._reconstruct()},s.prototype.setOutputFrequency=function(e){this.outFrequency=e,this._reconstruct()},s.prototype.generate=function(e){if(this.outBuffer===null)return;var t;if(this.channel===null||this.inBuffer==null){for(t=0;t<e;++t)this.outBuffer[t]=0;return}this.type==s.TYPE_NO_CONVERSION?this.channel.generate(e):this.type==s.TYPE_UP_SAMPLING?this.filter.generate(e):this.converter.generate(e);for(t=0;t<e;++t)this.outBuffer[t]=this.inBuffer[t]},s.prototype._reconstruct=function(){this.inFrequency==this.outFrequency?(this.type=s.TYPE_NO_CONVERSION,this.converter=null,this.filter=null,this.channel&&this.bufferLength!==0?(this.channel.setBufferLength(this.bufferLength),this.inBuffer=this.channel.getBuffer()):this.inBuffer=null):this.inFrequency<this.outFrequency?(this.type=s.TYPE_UP_SAMPLING,this.filter=new r,this.filter.setParameter(r.TYPE_LPF,this.inFrequency/2*.9,.9,20),this.converter=new s.ConversionChannel,this.converter.setInputFrequency(this.inFrequency),this.converter.setOutputFrequency(this.outFrequency),this.filter.setChannel(this.converter),this.bufferLength!==0?(this.filter.setBufferLength(this.bufferLength),this.inBuffer=this.filter.getBuffer()):this.inBuffer=null,this.channel!==null&&this.converter.setChannel(this.channel)):(this.type=s.TYPE_DOWN_SAMPLING,this.converter=new s.ConversionChannel,this.converter.setInputFrequency(this.inFrequency),this.converter.setOutputFrequency(this.outFrequency),this.bufferLength!=0?(this.converter.setBufferLength(this.bufferLength),this.inBuffer=this.converter.getBuffer()):this.inBuffer=null,this.channel!=null&&this.converter.setChannel(this.channel),this.filter=null)},s.ConversionChannel=function(){this.count=0,this.inFrequency=44100,this.outFrequency=44100,this.inBuffer=null,this.outBuffer=null,this.bufferLength=0,this.channel=null,this.inOffset=0,this.lastL=0,this.lastR=0},s.ConversionChannel.prototype.setBufferLength=function(e){this.outBuffer=new Int32Array(e),this.bufferLength=e,null!==this.channel&&(this.channel.setBufferLength(e),this.inBuffer=this.channel.getBuffer())},s.ConversionChannel.prototype.getBuffer=function(){return this.outBuffer},s.ConversionChannel.prototype.setChannel=function(e){0!==this.bufferLength&&null!==e&&(e.setBufferLength(this.bufferLength),this.inBuffer=e.getBuffer()),this.channel=e},s.ConversionChannel.prototype.setInputFrequency=function(e){this.inFrequency=e},s.ConversionChannel.prototype.setOutputFrequency=function(e){this.outFrequency=e},s.ConversionChannel.prototype.generate=function(e){var t;if(null===this.channel){for(t=0;t<e;++t)this.outBuffer[t]=0;return}if(this.inFrequency==this.outFrequency){this.channel.generate(e);for(t=0;t<e;++t)this.outBuffer[t]=this.inBuffer[t]}else if(this.inFrequency<this.outFrequency){var n=e>>1;this.lastL===undefined&&n++;var r=this.count+this.inFrequency*n,i=r/this.outFrequency,s=i<<1,o=this.lastL!==undefined?-2:0;this.channel.generate(s);for(t=0;t<e;t+=2)this.count>=0?(o<0?(this.outBuffer[t+0]=this.lastL,this.outBuffer[t+1]=this.lastR):(this.outBuffer[t+0]=this.inBuffer[o+0],this.outBuffer[t+1]=this.inBuffer[o+1]),o+=2,this.count-=this.outFrequency):(this.outBuffer[t+0]=0,this.outBuffer[t+1]=0),this.count+=this.inFrequency;o<s?(this.lastL=this.inBuffer[o+0],this.lastR=this.inBuffer[o+1]):(this.lastL=undefined,this.lastR=undefined)}else for(t=0;t<e;t+=2){while(this.count<0)this.inOffset+=2,this.count+=this.outFrequency;while(this.inOffset>=this.bufferLength)this.channel.generate(e),this.inOffset-=this.bufferLength;this.outBuffer[t+0]=this.inBuffer[this.inOffset+0],this.outBuffer[t+1]=this.inBuffer[this.inOffset+1],this.inOffset+=2,this.inOffset==this.bufferLength&&(this.inOffset=0),this.count-=this.inFrequency-this.outFrequency}};var o=function(){this.channels=new Array,this.buffers=null,this.buffer=null,this.bufferLength=0,this.player=null,this.intervalMsec=0,this.intervalLength=0,this.intervalRestLength=0,this.volume=o.DEFAULT_VOLUME,this.sampleRate=o.DEFAULT_SAMPLE_FREQUENCY};o.DEFAULT_SAMPLE_FREQUENCY=44100,o.MAX_WAVE_VALUE=32767,o.MIN_WAVE_VALUE=-32767,o.MSEC_PER_SEC=1e3,o.DEFAULT_VOLUME=8,o.prototype.reconstructBuffers=function(){var e=new Array(this.channels.length);for(var t=0;t<this.channels.length;t++)e[t]=this.channels[t].getBuffer();this.buffers=e},o.prototype.setVolume=function(e){this.volume=e},o.prototype.addChannel=function(e){var t=this.channels.push(e);return e.setSampleRate(this.sampleRate),0!=this.bufferLength&&(e.setBufferLength(this.bufferLength),this.reconstructBuffers()),t},o.prototype.removeChannel=function(e){for(var t=0;t<this.channels.length;t++)if(e==this.channels[t])return this.buffers=null,this.channels.splice(t,1),this.reconstructBuffers(),!0;return!1},o.prototype.clearChannel=function(){this.buffers=null,this.channels=new Array,this.reconstructBuffers()},o.prototype.setPlayer=function(e){this.player=e},o.prototype.setPlayerInterval=function(e){this.intervalMsec=e,this.intervalLength=2*this.sampleRate*e/o.MSEC_PER_SEC,this.intervalLength&=-2,this.intervalRestLength=this.intervalLength},o.prototype._generate=function(e,t){var n=this.channels.length,r;for(r=0;r<n;r++)this.channels[r].generate(t);for(var i=0;i<t;i++){var s=0;for(r=0;r<n;r++)s+=this.buffers[r][i];s*=this.volume,s>o.MAX_WAVE_VALUE?s=o.MAX_WAVE_VALUE:s<o.MIN_WAVE_VALUE&&(s=o.MIN_WAVE_VALUE),this.buffer[e+i]=s}},o.prototype.setBufferLength=function(e){this.buffers=null,this.buffer=new Int32Array(e),this.bufferLength=e;for(var t=0;t<this.channels.length;t++)this.channels[t].setBufferLength(e);this.reconstructBuffers()},o.prototype.setSampleRate=function(e){this.sampleRate=e;for(var t=0;t<this.channels.length;t++)this.channels[t].setSampleRate(e);this.setPlayerInterval(this.intervalMsec)},o.prototype.getBuffer=function(){return this.buffer},o.prototype.generate=function(e){if(null==this.buffers)return;if(null==this.player||0==this.intervalLength)this._generate(0,e);else{var t=e,n=0;while(t>this.intervalRestLength)this._generate(n,this.intervalRestLength),t-=this.intervalRestLength,n+=this.intervalRestLength,this.intervalRestLength=this.intervalLength,this.player.updateDevice();0!=t&&(this._generate(n,t),this.intervalRestLength-=t)}};var u=function(){this.events=[]};u.EVENT_TYPE_MIDI=0,u._NOTE_FREQUENCY_TABLE=[],u._PANPOT_TABLE=[],u._MIDI_EVENT_SYSEX=240,u._MIDI_EVENT_MTC_QUOTER_FRAME_MESSAGE=241,u._MIDI_EVENT_SONG_POSITION_POINTER=242,u._MIDI_EVENT_SONG_SELECT=243,u._MIDI_EVENT_TUNE_REQUEST=246,u._MIDI_EVENT_EOX=247,u._MIDI_EVENT_TIMING_CLOCK=248,u._MIDI_EVENT_START=250,u._MIDI_EVENT_CONTINUE=251,u._MIDI_EVENT_STOP=252,u._MIDI_EVENT_ACTIVE_SENCING=254,u._MIDI_EVENT_SYSTEM_RESET=255,u._MIDI_EVENT_SYSTEM_LENGTH=[-1,2,3,2,-1,-1,1,1],function(){var e;for(e=0;e<128;++e)u._NOTE_FREQUENCY_TABLE[e]=440*Math.pow(2,(e-69)/12);u._PANPOT_TABLE[0]=1;for(e=1;e<128;++e){var t=(e-1)*Math.PI/2/126;u._PANPOT_TABLE[e]=Math.cos(t)}u._PANPOT_TABLE[128]=0}(),u.createEvent=function(e){return{type:u.EVENT_TYPE_MIDI,midiData:e}},u.getFrequencyForNote=function(e){return u._NOTE_FREQUENCY_TABLE[e]},u.getFrequencyForNoteWithBend=function(e,t){return u._NOTE_FREQUENCY_TABLE[e]*Math.pow(2,t/8192/6)},u.getVolumeForPanpot=function(e){return{l:u._PANPOT_TABLE[e],r:u._PANPOT_TABLE[128-e]}},u.prototype.setBufferLength=function(e){},u.prototype.setSampleRate=function(e){},u.prototype.processEvents=function(e){for(var n=0;n<e.midiData.length;n++){if(e.midiData[n]<0||255<e.midiData[n])t.getLog().warn("MIDI: midiData["+n+"] is out of range, "+e.midiData[n]),e.midiData[n]&=255;e.midiData[n]>=248?u._MIDI_EVENT_SYSTEM_RESET==e.midiData[n]?this.processSystemReset():this.processSystemRealtimeMessage([e.midiData[n]]):this.events.push(e.midiData[n])}for(var r=0;0!=this.events.length;r++){var i=this.events[0],s=i>>4,o=i&15;switch(s){case 8:if(this.events.length<3)return r;this.processNoteOff(o,this.events[1],this.events[2]),this.events.splice(0,3);break;case 9:if(this.events.length<3)return r;0==this.events[2]?this.processNoteOff(o,this.events[1],this.events[2]):this.processNoteOn(o,this.events[1],this.events[2]),this.events.splice(0,3);break;case 10:if(this.events.length<3)return r;this.processKeyPressure(o,this.events[1],this.events[2]),this.events.splice(0,3);break;case 11:if(this.events.length<3)return r;this.processControlChange(o,this.events[1],this.events[2]),this.events.splice(0,3);break;case 12:if(this.events.length<2)return r;this.processProgramChange(o,this.events[1]),this.events.splice(0,2);break;case 13:if(this.events.length<2)return r;this.processChannelPressure(o,this.events[1]),this.events.splice(0,2);break;case 14:if(this.events.length<3)return r;var a=this.events[1]<<7|this.events[2];a>8191&&(a-=16384),this.processPitchBend(o,a),this.events.splice(0,3);break;case 15:if(u._MIDI_EVENT_SYSEX==i){for(var f=1;f<this.events.length;f++)if(u._MIDI_EVENT_EOX==this.events[f])break;if(f==this.events.length)return r;this.processSystemExclusive(this.events.splice(0,f+1))}else if(i<248){var l=u._MIDI_EVENT_SYSTEM_LENGTH[i&7];l<0&&(t.getLog().warn("MIDI: unknown system message "+i.toString(16)),l=1);if(this.events.length<l)return r;var c=this.events.splice(0,l);this.processSystemCommonMessage(c)}else t.getLog().error("MIDI: unexpected realtime event")}}},u.prototype.processNoteOff=function(e,t,n){},u.prototype.processNoteOn=function(e,t,n){},u.prototype.processKeyPressure=function(e,t,n){},u.prototype.processControlChange=function(e,t,n){},u.prototype.processProgramChange=function(e,t){},u.prototype.processChannelPressure=function(e,t){},u.prototype.processPitchBend=function(e,t){},u.prototype.processSystemExclusive=function(e){},u.prototype.processSystemCommonMessage=function(e){},u.prototype.processSystemRealtimeMessage=function(e){},u.prototype.processSystemReset=function(){},u.prototype.processMetaData=function(e){};var a=function(){this.clock=a.CLOCK_3_58MHZ,this.mode=a.MODE_UNSIGNED,this.device=a.DEVICE_AY_3_8910,this.activeRegister=0,this.volumeTable=a._VOLUME_TABLE[a.DEVICE_AY_3_8910],this.baseStep=0,this.buffer=null,this.register=new Int32Array(a._REGISTERS),this.volume=new Int32Array(a._CHANNELS),this.envelope=new Array(a._CHANNELS),this.active=new Array(a._CHANNELS),this.seed=a._DEFAULT_AY_SEED,this.stepTone=new Int32Array(a._CHANNELS),this.countTone=new Int32Array(a._CHANNELS),this.mixerTone=new Array(a._CHANNELS),this.stepNoise=0,this.countNoise=0,this.mixerNoise=new Array(a._CHANNELS),this.feedback=!1,this.volumeNoise=0,this.sampleRate=o.DEFAULT_SAMPLE_FREQUENCY,this.setClock(a.CLOCK_3_58MHZ),this.setMode(a.MODE_UNSIGNED),this.setDevice(a.DEVICE_AY_3_8910)};a.CLOCK_4MHZ=4e6,a.CLOCK_3_58MHZ=3579545,a.MODE_UNSIGNED=0,a.MODE_SIGNED=1,a.DEVICE_PSG=0,a.DEVICE_SSG=1,a.DEVICE_AY_3_8910=0,a.DEVICE_YM_2149=1,a.DEVICE_SN76489=2,a.REGISTER_AY_CH_A_TP_LOW=0,a.REGISTER_AY_CH_A_TP_HIGH=1,a.REGISTER_AY_CH_B_TP_LOW=2,a.REGISTER_AY_CH_B_TP_HIGH=3,a.REGISTER_AY_CH_C_TP_LOW=4,a.REGISTER_AY_CH_C_TP_HIGH=5,a.REGISTER_AY_NOISE_TP=6,a.REGISTER_AY_MIXER=7,a.REGISTER_AY_CH_A_VOLUME=8,a.REGISTER_AY_CH_B_VOLUME=9,a.REGISTER_AY_CH_C_VOLUME=10,a.REGISTER_AY_EP_LOW=11,a.REGISTER_AY_EP_HIGH=12,a.REGISTER_AY_EP_CONTROL=13,a.REGISTER_AY_IO_A=14,a.REGISTER_AY_IO_B=15,a.REGISTER_SN_CH_A_TP=8,a.REGISTER_SN_CH_A_VOLUME=9,a.REGISTER_SN_CH_B_TP=10,a.REGISTER_SN_CH_B_VOLUME=11,a.REGISTER_SN_CH_C_TP=12,a.REGISTER_SN_CH_C_VOLUME=13,a.REGISTER_SN_NOISE_CONTROL=14,a.REGISTER_SN_NOISE_VOLUME=15,a.REGISTER_SN_CH_A_TP_HIGH=0,a.REGISTER_SN_CH_B_TP_HIGH=2,a.REGISTER_SN_CH_C_TP_HIGH=4,a._DEFAULT_AY_CH_A_TP_LOW=85,a._DEFAULT_AY_CH_A_TP_HIGH=0,a._DEFAULT_AY_CH_B_TP_LOW=0,a._DEFAULT_AY_CH_B_TP_HIGH=0,a._DEFAULT_AY_CH_C_TP_LOW=0,a._DEFAULT_AY_CH_C_TP_HIGH=0,a._DEFAULT_AY_NOISE_TP=0,a._DEFAULT_AY_MIXER=184,a._DEFAULT_AY_CH_A_VOLUME=0,a._DEFAULT_AY_CH_B_VOLUME=0,a._DEFAULT_AY_CH_C_VOLUME=0,a._DEFAULT_AY_EP_LOW=11,a._DEFAULT_AY_EP_HIGH=0,a._DEFAULT_AY_EP_CONTROL=0,a._DEFAULT_SN_CH_A_TP=0,a._DEFAULT_SN_CH_A_VOLUME=15,a._DEFAULT_SN_CH_B_TP=0,a._DEFAULT_SN_CH_B_VOLUME=15,a._DEFAULT_SN_CH_C_TP=0,a._DEFAULT_SN_CH_C_VOLUME=15,a._DEFAULT_SN_NOISE_CONTROL=224,a._DEFAULT_SN_NOISE_VOLUME=255,a._DEFAULT_SN_CH_A_TP_HIGH=0,a._DEFAULT_SN_CH_B_TP_HIGH=0,a._DEFAULT_SN_CH_C_TP_HIGH=0,a._REGISTERS=16,a._CHANNELS=3,a._REGISTER_MIN_VALUE=0,a._REGISTER_MAX_VALUE=255,a._BITS_PER_BYTE=8,a._NOISE_TP_MASK=31,a._MIXER_CH_A_TONE=1,a._MIXER_CH_A_NOISE=8,a._MIXER_CH_B_TONE=2,a._MIXER_CH_B_NOISE=16,a._MIXER_CH_C_TONE=4,a._MIXER_CH_C_NOISE=32,a._VOLUME_MASK=15,a._ENVELOPE_MASK=16,a._CH_A=0,a._CH_B=1,a._CH_C=2,a._CLOCK_BIAS=16e3,a._STEP_BIAS=18,a._VOLUME_BIAS=3,a._DEFAULT_AY_SEED=-1,a._DEFAULT_SN_SEED=-32768,a._UPDATE_SEED_MASK=9,a._UPDATE_SEED_RSHIFT=3,a._UPDATE_SEED_LSHIFT=15,a._SHORT_MASK=65535,a._HALF_MASK=15,a._HALF_SHIFT=4,a._BYTE_MSB_MASK=128,a._ADDRESS_MASK=7,a._VALUE_MASK=63,a._LOWER_TWO_BITS_MASK=3,a._VOLUME_TABLE=new Array(3),a._VOLUME_TABLE[a.DEVICE_AY_3_8910]=new Int32Array([0,1,1,2,2,3,3,4,5,6,7,9,11,13,15,18,22,26,31,37,45,53,63,76,90,106,127,151,180,214,255,255]),a._VOLUME_TABLE[a.DEVICE_YM_2149]=new Int32Array([0,1,1,2,2,3,3,4,5,6,7,9,11,13,15,18,22,26,31,37,45,53,63,76,90,106,127,151,180,214,255,255]),a._VOLUME_TABLE[a.DEVICE_SN76489]=new Int32Array([255,203,161,128,101,80,64,51,40,32,25,20,16,12,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),a._NOISE_TP_TABLE=new Int32Array([128,256,512,0]),a.prototype.setClock=function(e){this.clock=e,this.baseStep=a._CLOCK_BIAS*this.clock/this.sampleRate,this.baseStep=~~this.baseStep},a.prototype.setMode=function(e){this.mode=e},a.prototype.setRegisterSN=function(e,t,n){this.writeRegisterSN(0,e<<a._HALF_SHIFT|t),(e==a.REGISTER_SN_CH_A_TP||e==a.REGISTER_SN_CH_B_TP||e==a.REGISTER_SN_CH_C_TP)&&this.writeRegisterSN(0,n)},a.prototype.initRegisterSN=function(){this.setRegisterSN(a.REGISTER_SN_CH_A_TP,a._DEFAULT_SN_CH_A_TP,a._DEFAULT_SN_CH_A_TP_HIGH),this.setRegisterSN(a.REGISTER_SN_CH_A_VOLUME,a._DEFAULT_SN_CH_A_VOLUME,0),this.setRegisterSN(a.REGISTER_SN_CH_B_TP,a._DEFAULT_SN_CH_B_TP,a._DEFAULT_SN_CH_B_TP_HIGH),this.setRegisterSN(a.REGISTER_SN_CH_B_VOLUME,a._DEFAULT_SN_CH_B_VOLUME,0),this.setRegisterSN(a.REGISTER_SN_CH_C_TP,a._DEFAULT_SN_CH_C_TP,a._DEFAULT_SN_CH_C_TP_HIGH),this.setRegisterSN(a.REGISTER_SN_CH_C_VOLUME,a._DEFAULT_SN_CH_C_VOLUME,0),this.setRegisterSN(a.REGISTER_SN_NOISE_CONTROL,a._DEFAULT_SN_NOISE_CONTROL,0),this.setRegisterSN(a.REGISTER_SN_NOISE_VOLUME,a._DEFAULT_SN_NOISE_VOLUME,0),this.activeRegister=0,this.seed=a._DEFAULT_SN_SEED},a.prototype.initRegisterAY=function(){this.writeRegister(a.REGISTER_AY_CH_A_TP_HIGH,a._DEFAULT_AY_CH_A_TP_HIGH),this.writeRegister(a.REGISTER_AY_CH_A_TP_LOW,a._DEFAULT_AY_CH_A_TP_LOW),this.writeRegister(a.REGISTER_AY_CH_B_TP_HIGH,a._DEFAULT_AY_CH_B_TP_HIGH),this.writeRegister(a.REGISTER_AY_CH_B_TP_LOW,a._DEFAULT_AY_CH_B_TP_LOW),this.writeRegister(a.REGISTER_AY_CH_C_TP_HIGH,a._DEFAULT_AY_CH_C_TP_HIGH),this.writeRegister(a.REGISTER_AY_CH_C_TP_LOW,a._DEFAULT_AY_CH_C_TP_LOW),this.writeRegister(a.REGISTER_AY_NOISE_TP,a._DEFAULT_AY_NOISE_TP),this.writeRegister(a.REGISTER_AY_MIXER,a._DEFAULT_AY_MIXER),this.writeRegister(a.REGISTER_AY_CH_A_VOLUME,a._DEFAULT_AY_CH_A_VOLUME),this.writeRegister(a.REGISTER_AY_CH_B_VOLUME,a._DEFAULT_AY_CH_B_VOLUME),this.writeRegister(a.REGISTER_AY_CH_C_VOLUME,a._DEFAULT_AY_CH_C_VOLUME),this.writeRegister(a.REGISTER_AY_EP_LOW,a._DEFAULT_AY_EP_LOW),this.writeRegister(a.REGISTER_AY_EP_HIGH,a._DEFAULT_AY_EP_HIGH),this.writeRegister(a.REGISTER_AY_EP_CONTROL,a._DEFAULT_AY_EP_CONTROL),this.seed=a._DEFAULT_AY_SEED},a.prototype.setDevice=function(e){this.device=e,this.volumeTable=a._VOLUME_TABLE[e];for(var t=0;t<a._CHANNELS;t++)this.active[t]=!0,this.countTone[t]=0;this.device==a.DEVICE_SN76489?this.initRegisterSN():this.initRegisterAY()},a.prototype.setBufferLength=function(e){this.buffer=new Int32Array(e)},a.prototype.setSampleRate=function(e){this.sampleRate=e,this.setClock(this.clock)},a.prototype.getBuffer=function(){return this.buffer},a.prototype.generateSN=function(e){var t;0==this.stepNoise?t=this.stepTone[a._CH_C]:t=this.stepNoise;for(var n=0;n<e;n+=2){var r=0;for(var i=0;i<a._CHANNELS;i++)this.countTone[i]+=this.baseStep,this.countTone[i]>this.stepTone[i]&&(this.countTone[i]-=this.stepTone[i],this.active[i]=!this.active[i]),this.active[i]?r+=this.volume[i]:this.mode==a.MODE_SIGNED&&(r-=this.volume[i]);this.countNoise+=this.baseStep;if(this.countNoise>t)if(this.feedback){var s=this.seed&a._UPDATE_SEED_MASK;s^=s>>>a._UPDATE_SEED_RSHIFT,this.seed=(this.seed&a._SHORT_MASK)>>1,this.seed|=s<<a._UPDATE_SEED_LSHIFT&a._SHORT_MASK}else this.seed=(this.seed&a._SHORT_MASK)>>1,this.seed|=this.seed<<a._UPDATE_SEED_LSHIFT&a._SHORT_MASK;0!=(this.seed&1)?r+=this.volumeNoise:this.mode==a.MODE_SIGNED&&(r-=this.volumeNoise),this.buffer[n+0]=r,this.buffer[n+1]=r}},a.prototype.generateAY=function(e){for(var t=0;t<e;t+=2){this.countNoise+=this.baseStep;if(this.countNoise>this.stepNoise){var n=this.seed&a._UPDATE_SEED_MASK;n^=n>>>a._UPDATE_SEED_RSHIFT,this.seed=(this.seed&a._SHORT_MASK)>>1,this.seed|=n<<a._UPDATE_SEED_LSHIFT&a._SHORT_MASK,this.countNoise-=this.stepNoise}var r=0,i=0!=(this.seed&1);for(var s=0;s<a._CHANNELS;s++)this.countTone[s]+=this.baseStep,this.countTone[s]>this.stepTone[s]&&(this.countTone[s]-=this.stepTone[s],this.active[s]=!this.active[s]),this.mixerTone[s]&&this.active[s]||this.mixerNoise[s]&&i?r+=this.volume[s]:this.mixerTone[s]&&this.mixerNoise[s]&&this.mode==a.MODE_SIGNED&&(r-=this.volume[s]);this.buffer[t+0]=r,this.buffer[t+1]=r}},a.prototype.generate=function(e){this.device==a.DEVICE_SN76489?this.generateSN(e):this.generateAY(e)},a.prototype.writeRegisterSN=function(e,t){var n=0;0!=(t&a._BYTE_MSB_MASK)?(n=t>>a._HALF_SHIFT,this.register[n]=t&a._HALF_MASK,this.activeRegister=n&a._ADDRESS_MASK):(n=this.activeRegister,this.register[n]=t&a._VALUE_MASK);switch(n){case a.REGISTER_SN_CH_A_TP:case a.REGISTER_SN_CH_A_TP_HIGH:this.stepTone[a._CH_A]=(this.register[a.REGISTER_SN_CH_A_TP_HIGH]<<a._HALF_SHIFT|this.register[a.REGISTER_SN_CH_A_TP])<<a._STEP_BIAS;break;case a.REGISTER_SN_CH_A_VOLUME:this.volume[a._CH_A]=this.volumeTable[this.register[n]]<<a._VOLUME_BIAS;break;case a.REGISTER_SN_CH_B_TP:case a.REGISTER_SN_CH_B_TP_HIGH:this.stepTone[a._CH_B]=(this.register[a.REGISTER_SN_CH_B_TP_HIGH]<<a._HALF_SHIFT|this.register[a.REGISTER_SN_CH_B_TP])<<a._STEP_BIAS;break;case a.REGISTER_SN_CH_B_VOLUME:this.volume[a._CH_B]=this.volumeTable[this.register[n]]<<a._VOLUME_BIAS;break;case a.REGISTER_SN_CH_C_TP:case a.REGISTER_SN_CH_C_TP_HIGH:this.stepTone[a._CH_C]=(this.register[a.REGISTER_SN_CH_C_TP_HIGH]<<a._HALF_SHIFT|this.register[a.REGISTER_SN_CH_C_TP])<<a._STEP_BIAS;break;case a.REGISTER_SN_CH_C_VOLUME:this.volume[a._CH_C]=this.volumeTable[this.register[n]]<<a._VOLUME_BIAS;break;case a.REGISTER_SN_NOISE_CONTROL:this.stepNoise=a._NOISE_TP_TABLE[t&a._LOWER_TWO_BITS_MASK]<<a._STEP_BIAS,this.feedback=1==t>>2;break;case a.REGISTER_SN_NOISE_VOLUME:this.volumeNoise=this.volumeTable[this.register[n]];break;default:}},a.prototype.writeRegisterAY=function(e,t){if(e>a._REGISTERS||t<a._REGISTER_MIN_VALUE||a._REGISTER_MAX_VALUE<t)throw new RangeError("Undefined register: "+e);this.register[e]=t;switch(e){case a.REGISTER_AY_CH_A_TP_LOW:case a.REGISTER_AY_CH_A_TP_HIGH:this.stepTone[a._CH_A]=(this.register[a.REGISTER_AY_CH_A_TP_HIGH]<<a._BITS_PER_BYTE|this.register[a.REGISTER_AY_CH_A_TP_LOW])<<a._STEP_BIAS;break;case a.REGISTER_AY_CH_B_TP_LOW:case a.REGISTER_AY_CH_B_TP_HIGH:this.stepTone[a._CH_B]=(this.register[a.REGISTER_AY_CH_B_TP_HIGH]<<a._BITS_PER_BYTE|this.register[a.REGISTER_AY_CH_B_TP_LOW])<<a._STEP_BIAS;break;case a.REGISTER_AY_CH_C_TP_LOW:case a.REGISTER_AY_CH_C_TP_HIGH:this.stepTone[a._CH_C]=(this.register[a.REGISTER_AY_CH_C_TP_HIGH]<<a._BITS_PER_BYTE|this.register[a.REGISTER_AY_CH_C_TP_LOW])<<a._STEP_BIAS;break;case a.REGISTER_AY_NOISE_TP:this.stepNoise=(t&a._NOISE_TP_MASK)<<1<<a._STEP_BIAS+1,this.stepNoise<this.baseStep&&(this.stepNoise=this.baseStep);break;case a.REGISTER_AY_MIXER:this.mixerTone[a._CH_A]=0==(t&a._MIXER_CH_A_TONE),this.mixerTone[a._CH_B]=0==(t&a._MIXER_CH_B_TONE),this.mixerTone[a._CH_C]=0==(t&a._MIXER_CH_C_TONE),this.mixerNoise[a._CH_A]=0==(t&a._MIXER_CH_A_NOISE),this.mixerNoise[a._CH_B]=0==(t&a._MIXER_CH_B_NOISE),this.mixerNoise[a._CH_C]=0==(t&a._MIXER_CH_C_NOISE);break;case a.REGISTER_AY_CH_A_VOLUME:this.volume[a._CH_A]=this.volumeTable[(t&a._VOLUME_MASK)<<1]<<a._VOLUME_BIAS,this.envelope[a._CH_A]=0!=(t&a._ENVELOPE_MASK);break;case a.REGISTER_AY_CH_B_VOLUME:this.volume[a._CH_B]=this.volumeTable[(t&a._VOLUME_MASK)<<1]<<a._VOLUME_BIAS,this.envelope[a._CH_B]=0!=(t&a._ENVELOPE_MASK);break;case a.REGISTER_AY_CH_C_VOLUME:this.volume[a._CH_C]=this.volumeTable[(t&a._VOLUME_MASK)<<1]<<a._VOLUME_BIAS,this.envelope[a._CH_C]=0!=(t&a._ENVELOPE_MASK);break;case a.REGISTER_AY_EP_LOW:break;case a.REGISTER_AY_EP_HIGH:break;case a.REGISTER_AY_EP_CONTROL:break;case a.REGISTER_AY_IO_A:break;case a.REGISTER_AY_IO_B:break;default:}},a.prototype.writeRegister=function(e,t){this.device==a.DEVICE_SN76489?this.writeRegisterSN(e,t):this.writeRegisterAY(e,t)},a.prototype.readRegister=function(e){if(e>a._REGISTERS)throw new RangeError("Undefined register: "+e);return this.register[e]};var f=function(){this.buffer=null,this.count=f._COUNT_CYCLE,this.voices=[],this.activeVoices=0,this.searchingVoice=0,this.noteMaps=[];for(var e=0;e<f._MAX_VOICE;e++)this.voices[e]=new f.Voice;for(var t=0;t<f._MAX_CHANNEL;t++)this.noteMaps[t]=new Array(128);this.sampleRate=o.DEFAULT_SAMPLE_FREQUENCY,this.processSystemReset()};f.prototype=new u,f.prototype.constructor=f,f._MAX_CHANNEL=16,f._MAX_VOICE=64,f._OFF=-1,f._COUNT_CYCLE=2048,f.prototype._generate=function(e,t){for(var n=e;n<=t;n++)this.buffer[n]=0;for(var r=0;r<f._MAX_VOICE;r++)this.voices[r].generate(this.buffer,e,t)},f.prototype._findVoice=function(){var e=0;if(f._MAX_VOICE==this.activeVoices){e=this.searchingVoice++;var n=this.voices[e].getChannel(),r=this.voices[e].getNote();this.voices[e].keyOff(),this.noteMaps[n][r]=f._OFF,this.activeVoices--,t.getLog.info("SimpleMIDI: voice overflow, force to key-off; ch = "+n+", note = "+r+", voice = "+e)}else for(var i=0;i<f._MAX_VOICE;i++){e=this.searchingVoice+i,e>=f._MAX_VOICE&&(e-=f._MAX_VOICE);if(!this.voices[e].isActive()){this.searchingVoice=e+1;break}}return this.searchingVoice>=f._MAX_VOICE&&(this.searchingVoice-=f._MAX_VOICE),e},f.prototype.setBufferLength=function(e){this.buffer=new Int32Array(e)},f.prototype.setSampleRate=function(e){this.sampleRate=e},f.prototype.getBuffer=function(){return this.buffer},f.prototype.generate=function(e){for(var t=0;e>0;){if(!(this.count<=e)){this._generate(t,t+e-1),this.count-=e;break}this._generate(t,t+this.count-1),t+=this.count,e-=this.count,this.count=f._COUNT_CYCLE;for(var n=0;n<f._MAX_VOICE;n++){if(this.voices[n].isActive())continue;var r=this.voices[n].velocity>>3;0!=r?this.voices[n].velocity-=r:this.voices[n].velocity-=0}}},f.prototype.processNoteOff=function(e,t,n){var r=this.noteMaps[e][t];if(f._OFF==r)return;this.noteMaps[e][t]=f._OFF,this.voices[r].keyOff(),this.activeVoices--},f.prototype.processNoteOn=function(e,t,n){var r=this.noteMaps[e][t];f._OFF==r&&(r=this._findVoice(),this.noteMaps[e][t]=r,this.activeVoices++),this.voices[r].keyOn(e,t,n)},f.prototype.processSystemReset=function(){for(var e=0;e<f._MAX_VOICE;e++)this.voices[e].keyOff();for(var t=0;t<f._MAX_CHANNEL;t++)for(var n=0;n<128;n++)this.noteMaps[t][n]=f._OFF;this.activeVoices=0,this.searchingVoice=0},f.Voice=function(){this.phase=0,this.frequency=440,this.velocity=0,this.channel=-1,this.note=-1,this.active=!1},f.Voice.prototype.getChannel=function(){return this.channel},f.Voice.prototype.getNote=function(){return this.note},f.Voice.prototype.isActive=function(){return this.active},f.Voice.prototype.keyOn=function(e,t,n){this.channel=e,this.note=t,this.frequency=u.getFrequencyForNote(t),this.velocity=n<<5,this.phase=0
,this.active=!0},f.Voice.prototype.keyOff=function(){this.channel=-1,this.note=-1,this.velocity>>=1,this.active=!1},f.Voice.prototype.generate=function(e,t,n){if(0==this.velocity)return;for(var r=t;r<=n;r+=2)this.phase+=this.frequency*2,this.phase>this.sampleRate&&(this.phase-=this.sampleRate,this.velocity=-this.velocity),e[r+0]+=this.velocity,e[r+1]+=this.velocity};var l=function(e){this.buffer=null,this.freq=e,this.phase=0,this.data=l.DEFAULT_VOLUME,this.sampleRate=o.DEFAULT_SAMPLE_FREQUENCY};l.DEFAULT_VOLUME=1024,l.prototype.setBufferLength=function(e){this.buffer=new Int32Array(e)},l.prototype.setSampleRate=function(e){this.sampleRate=e},l.prototype.getBuffer=function(){return this.buffer},l.prototype.generate=function(e){for(var n=0;n<e;n+=2)this.phase+=this.freq*2,this.phase>this.sampleRate&&(this.phase-=this.sampleRate,this.data=-this.data),this.buffer[n+0]=this.data,this.buffer[n+1]=this.data;null==this.firstGenerateCallback&&(this.firstGenerateCallback=!0,t.getLog().info("SimpleSlaveChannel: "+this.freq+"Hz"),t.getLog().info(this))};var c=function(){this.masterChannel=null,this.defaultDevice=new u,this.devices=[],this.tracks=[],this.numberOfTracks=0,this.usecTempo=1e6,this.timeUnit=480,this.error=!1,this.handleFalcomStyleInfiniteLoop=!0};c.TRACK_DEFAULT=-1,c._SMF_CHUNK_HEADER="M".charCodeAt(0)<<24|"T".charCodeAt(0)<<16|"h".charCodeAt(0)<<8|"d".charCodeAt(0),c._SMF_CHUNK_TRACK="M".charCodeAt(0)<<24|"T".charCodeAt(0)<<16|"r".charCodeAt(0)<<8|"k".charCodeAt(0),c._SMF_FORMAT_0=0,c._SMF_FORMAT_1=1,c._SMF_EVENT_SYSEX=240,c._SMF_EVENT_META=255,c._SMF_META_SEQUENCE_NUMBER=0,c._SMF_META_TEXT=1,c._SMF_META_COPYRIGHT=2,c._SMF_META_TRACK_NAME=3,c._SMF_META_INSTRUMENT_NAME=4,c._SMF_META_LYLIC=5,c._SMF_META_MARKER=6,c._SMF_META_CUE_POINT=7,c._SMF_META_CHANNEL_PREFIX=32,c._SMF_META_END_OF_TRACK=47,c._SMF_META_SET_TEMPO=81,c._SMF_META_SMPTE_OFFSET=84,c._SMF_META_TIME_SIGNATURE=88,c._SMF_META_KEY_SIGNATURE=89,c.prototype._sendEvent=function(e,t){var n=this.devices[e];n||(n=this.defaultDevice);if(!n)return;var r=u.createEvent(t);n.processEvents(r)},c.prototype._readUint16=function(e){return this.input[e]<<8|this.input[e+1]},c.prototype._readUint32=function(e){var t=this.input[e]<<24|this.input[e+1]<<16|this.input[e+2]<<8|this.input[e+3];return t<0?4294967296+t:t},c.prototype._readUint=function(e,t){var n=0,r=e.byteLength,i=!1;for(var s=t;s<r;s++){var o=e[s];if(o<128){n+=o,i=!0,s++;break}n+=o&127,n<<=7}return{value:n,length:s-t,success:i}},c.prototype._readChunkHeader=function(e){var n=this._readUint32(e),r=this._readUint32(e+4);return c._SMF_CHUNK_HEADER==n?t.getLog().info("SMF: MThd (header chunk)"):c._SMF_CHUNK_TRACK==n?t.getLog().info("SMF: MTrk (track chunk)"):t.getLog().warn("SMF: "+String.fromCharCode(e)+String.fromCharCode(e+1)+String.fromCharCode(e+2)+String.fromCharCode(e+3)+" (unknown)"),t.getLog().info("SMF: length: "+r),{type:n,length:r}},c.prototype._updateTimer=function(){var e=this.usecTempo/1e3/this.timeUnit;t.getLog().info("SMF: set timer interval as "+e),this.masterChannel.setPlayerInterval(e)},c.prototype.setMasterChannel=function(e){if(!e){this.masterChannel=null;return}e.clearChannel(),this.defaultDevice&&e.addChannel(this.defaultDevice);for(var t=0;t<this.devices.length;t++){if(!this.devices[t])continue;e.addChannel(this.devices[t])}e.setPlayer(this),this.masterChannel=e},c.prototype.setDevice=function(e,t){c.TRACK_DEFAULT==e?(this.masterChannel&&(this.defaultDevice&&this.masterChannel.removeChannel(this.defaultDevice),t&&this.masterChannel.addChannel(t)),this.defaultDevice=t):(this.masterChannel&&(this.devices[e]&&this.masterChannel.removeChannel(this.devices[e]),t&&this.masterChannel.addChannel(t)),this.devices[e]=t)},c.prototype.updateDevice=function(){if(this.error)return;for(var e=0;e<this.numberOfTracks;e++){var n=this.tracks[e];if(!n.active)continue;n.count--;if(0!=n.count)continue;var r=n.data.byteLength;do{if(n.offset==r){t.getLog().error("SMF: event not found"),this.error=!0;break}var i=n.data[n.offset];i>=128?n.lastEvent=i:(i=n.lastEvent,n.offset--);var s=3;192<=i&&i<224&&(s=2);if(n.offset+s>r){t.getLog().error("SMF: invalid event data at "+n.offset),this.error=!0;break}if(c._SMF_EVENT_SYSEX==i){n.offset++,s=1+n.data[n.offset];if(n.offset+s>r){t.getLog().error("SMF: invalid sysex data"),this.error=!0;break}}else if(c._SMF_EVENT_META==i){var o=n.data[n.offset+1];s=3+n.data[n.offset+2];if(n.offset+s>r){t.getLog().error("SMF: invalid meta data"),this.error=!0;break}if(c._SMF_META_TRACK_NAME==o)try{var u=m.createFromUint8Array(n.data.subarray(n.offset+3,n.offset+s));t.getLog().info("SMF: track name; "+u.toString())}catch(a){t.getLog().warn("SMF: track name is not UTF-8 text")}else if(c._SMF_META_MARKER==o){try{var f=m.createFromUint8Array(n.data.subarray(n.offset+3,n.offset+s));t.getLog().info("SMF: marker; "+f.toString())}catch(a){t.getLog().warn("SMF: marker is not UTF-8 text")}if(this.handleFalcomStyleInfiniteLoop&&1==n.data[n.offset+2]){var l=n.data[n.offset+3];if(65==l)n.loopOffset=n.offset,t.getLog().info("SMF: marker A handled as infinite loop start in falcom style");else if(66==l){n.offset=n.loopOffset,t.getLog().info("SMF: marker B handled as infinite loop end in falcom style");continue}}}else if(c._SMF_META_SET_TEMPO==o){this.usecTempo=n.data[n.offset+3]<<16|n.data[n.offset+4]<<8|n.data[n.offset+5];var h=~~(6e7/this.usecTempo);t.getLog().info("SMF: tempo "+h),this._updateTimer()}else t.getLog().info("SMF: meta type "+o)}else{if(240==(i&240)){t.getLog().error("SMF: unsupported system common message "+i.toString(16)),this.error=!0;break}if(i<128){t.getLog().warn("SMF: skip invalid data "+i.toString(16)),n.offset++;continue}}if(c._SMF_EVENT_META!=i){var p=new Uint8Array(s);p[0]=i;for(var d=1;d<s;d++)p[d]=n.data[n.offset+d];this._sendEvent(e,p)}n.offset+=s;var v=this._readUint(n.data,n.offset);if(!v.success){0==v.length?(t.getLog().info("SMF: track "+e+" end"),n.active=!1):(t.getLog().error("SMF: invalid delta time"),this.error=!0);break}n.count=v.value,n.offset+=v.length}while(0==n.count)}},c.prototype.play=function(e){this.input=new Uint8Array(e);var n=this.input.byteLength;t.getLog().info("SMF: load "+n+" Bytes");var r=0,i=!1,s=0;for(var o=0;o<n;o+=r){var u=this._readChunkHeader(o);o+=8;if(c._SMF_CHUNK_HEADER==u.type){if(i)return t.getLog().error("SMF: header chunks appear twice"),!1;i=!0;var a=this._readUint16(o);this.numberOfTracks=this._readUint16(o+2),this.timeUnit=this._readUint16(o+4),6!=u.length&&t.getLog().warn("SMF: invalid chunk header length: "+u.length),t.getLog().info("SMF: format "+a),t.getLog().info("SMF: tracks "+this.numberOfTracks),t.getLog().info("SMF: time unit "+this.timeUnit),c._SMF_FORMAT_0==a&&1!=this.numberOfTracks&&(t.getLog().warn("SMF: invalid track number in format 0"),this.numberOfTracks=1)}else if(c._SMF_CHUNK_TRACK==u.type){t.getLog().info("SMF: track chunk "+s);if(s>=this.numberOfTracks)return t.getLog().error("SMF: too many tracks"),!1;var f=this.input.subarray(o,o+u.length),l=this._readUint(f,0);if(!l.success)return t.getLog().error("SMF: track "+s+" has invalid data"),!1;t.getLog().info("SMF: track "+s+" initial "+"delta time "+l.value),this.tracks[s++]={data:f,offset:l.length,count:l.value+1,lastEvent:0,loopOffset:0,active:!0}}o+=u.length}if(i){if(!this.masterChannel)return t.getLog().error("SMF: master channel is not set"),!1;this._updateTimer()}return this.error=!i,i},c.prototype.stop=function(){this.error=!0};var h=function(e){this.player=null,this.timer=undefined,this.interval=0,this.now=Date.now(),this.useInterval=e==h.MODE_INTERVAL,this.useAnimationFrame=e==h.MODE_ANIMATION_FRAME,this.useTimerWorker=e==h.MODE_TIMER_WORKER,this.useAnimationFrame&&window.webkitRequestAnimationFrame(this.animationCallback.bind(this)),this.useTimerWorker&&(this.timer=new Worker("TimerWorker.js"),this.timer.onmessage=this.callback.bind(this))};h.MODE_INTERVAL=0,h.MODE_ANIMATION_FRAME=1,h.MODE_TIMER_WORKER=2,h.MODE_DEFAULT=h.MODE_TIMER_WORKER,h.prototype.addChannel=function(e){},h.prototype.removeChannel=function(e){},h.prototype.clearChannel=function(){},h.prototype.setPlayer=function(e){this.player=e},h.prototype.setPlayerInterval=function(e){this.interval=e,this.useInterval&&(this.timer&&clearInterval(this.timer),this.timer=setInterval(this.callback.bind(this),e)),this.useTimerWorker&&this.timer.postMessage(e)},h.prototype.callback=function(){Date.now()-this.now>1e3&&(this.now=Date.now());if(this.interval!=0&&this.player)do this.player.updateDevice(),this.now+=this.interval;while(this.now<Date.now())},h.prototype.animationCallback=function(){this.callback(),window.webkitRequestAnimationFrame(this.animationCallback.bind(this))};var p=function(){this.sampleRate=o.DEFAULT_SAMPLE_FREQUENCY,this.buffer=null,this.fmBuffer=[null,null,null,null],this.player=null,this.module=[],this.midi=new Array(p.MAX_MIDI_PORT);for(var e=0;e<p.MAX_MIDI_PORT;++e)this.midi[e]=new p.MIDI;this.timer=[{enable:!1,timer:0,count:0,base:0,self:null,callback:null},{enable:!1,timer:0,count:0,base:0,self:null,callback:null}],this.maxChannel=0,this.wave=[]};p.MAX_MIDI_PORT=4,p.MODULE_CHANNEL_L=0,p.MODULE_CHANNEL_R=1,p.MODULE_CHANNEL_C=2,p.FM_OUT_MODE_OFF=0,p.FM_OUT_MODE_NEW=1,p.FM_OUT_MODE_ADD=2,p._RND_TABLE=new Int8Array(4096),p._SIN_TABLE=new Int8Array(256),function(){var e;for(e=0;e<4096;e++){var t=~~(Math.random()*2147483647)>>8&255;t>=128&&(t-=256),p._RND_TABLE[e]=t}for(e=0;e<256;e++)p._SIN_TABLE[e]=~~(Math.sin(Math.PI*e/128)*64+.5)}(),p.prototype.setBufferLength=function(e){this.buffer=new Int32Array(e);for(var t=0;t<4;t++)this.fmBuffer[t]=new Int32Array(e);for(var n=0;n<p.MAX_MIDI_PORT;++n)this.midi[n]&&this.midi[n].setBufferLength(e)},p.prototype.setSampleRate=function(e){this.sampleRate=e;for(var t=0;t<2;++t){var n=this.timer[t].base*e/44100|0;this.timer[t].timer=n,this.timer[t].count=n}},p.prototype.getBuffer=function(){return this.buffer},p.prototype.setPlayer=function(e){this.player=e},p.prototype.generate=function(e){var t=0;while(t<e){var n=e-t>>2,r;for(r=0;r<2;r++)this.timer[r].enable&&this.timer[r].count<n&&(n=this.timer[r].count);var i=n<<2;this._generateInternal(t,i),t+=i;for(r=0;r<2;r++){if(!this.timer[r].enable)continue;this.timer[r].count-=n;if(0!=this.timer[r].count)continue;this.timer[r].count=this.timer[r].timer,this.timer[r].callback.apply(this.timer[r].self)}}},p.prototype.reset=function(){for(var e=0;e<p.MAX_MIDI_PORT;++e)this.midi[e].device&&this.midi[e].device.processSystemReset()},p.prototype.setVirtualDevices=function(e){for(var t=0;t<p.MAX_MIDI_PORT;++t)this.midi[t].setDevice(e[t])},p.prototype._CheckId=function(e){if(typeof e=="undefined"||e>this.maxChannel)throw new RangeError("TSC: Invalid module channel: "+e)},p.prototype.setMaxChannel=function(e){this.maxChannel=e;for(var t=0;t<e;t++)this.module[t]=new p.Module(this,t)},p.prototype.setWave=function(e,n){t.getLog().info("TSC: Set wave table "+e),t.getLog().info(n),this.wave[e]=n},p.prototype.setTimerCallback=function(e,t,n,r){if(e>2)return;if(null!=r&&t<=0)return;var i=t*this.sampleRate/44100|0;this.timer[e]={enable:null!=r,timer:i,count:i,base:t,self:n,callback:r}},p.prototype.setModuleFrequency=function(e,t){this._CheckId(e),this.module[e].frequency=t},p.prototype.setModuleVolume=function(e,n,r){this._CheckId(e),n==p.MODULE_CHANNEL_L?this.module[e].volume.l=r:n==p.MODULE_CHANNEL_R?this.module[e].volume.r=r:n==p.MODULE_CHANNEL_C?this.module[e].volume.c=r:t.getLog().error("TSC: Invalid volume channel: "+n)},p.prototype.getModuleVolume=function(e,t){this._CheckId(e);if(t==p.MODULE_CHANNEL_L)return this.module[e].volume.l;if(t==p.MODULE_CHANNEL_R)return this.module[e].volume.r;throw new RangeError("TSC: Invalid volume channel: "+e)},p.prototype.setModuleType=function(e,n){this._CheckId(e),this.module[e].setType(n),p.Module.TYPE_SCC==n&&(this.wave[0]||t.getLog().warn("TSC: wave table 0 not found"))},p.prototype.getModuleType=function(e){return this._CheckId(e),this.module[e].type},p.prototype.setModulePort=function(e,t,n){this._CheckId(e);var r=this.getModuleType(e);if(p.Module.TYPE_MIDI!=r)return;this.derefMidi(this.module[e].mid),this.addrefMidi(t),this.module[e].mid=t,this.module[e].mch=n},p.prototype.setModuleVoice=function(e,n){this._CheckId(e);var r=this.getModuleType(e);if(p.Module.TYPE_SCC==r)this.wave[n]||t.getLog().warn("TSC: wave table "+n+" not found");else if(p.Module.TYPE_MIDI==r){var i=this.midi[this.module[e].mid].device;i&&i.processProgramChange(this.module[e].mch,n)}this.module[e].voice=n},p.prototype.setModuleFmInPipe=function(e,t,n){this._CheckId(e),this.module[e].setFmInPipe(t,n)},p.prototype.setModuleFmOutPipe=function(e,t,n){this._CheckId(e),this.module[e].setFmOutPipe(t,n)},p.prototype.setModulePhase=function(e,t){this._CheckId(e),this.module[e].phase=t},p.prototype.keyOn=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(p.Module.TYPE_MIDI!=n)return;this.module[e].note=t;var r=this.midi[this.module[e].mid].device;r&&r.processNoteOn(this.module[e].mch,t,this.module[e].volume.c>>1)},p.prototype.keyOff=function(e){this._CheckId(e);var t=this.getModuleType(e);if(p.Module.TYPE_MIDI!=t)return;var n=this.midi[this.module[e].mid].device;n&&n.processNoteOff(this.module[e].mch,this.module[e].note,0)},p.prototype.pitchBend=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(p.Module.TYPE_MIDI!=n)return;var r=this.midi[this.module[e].mid].device;r&&r.processPitchBend(this.module[e].mch,t)},p.prototype.panpot=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(p.Module.TYPE_MIDI!=n)return;var r=this.midi[this.module[e].mid].device;r&&r.processControlChange(this.module[e].mch,10,t)},p.prototype._generateInternal=function(e,t){var n=this.buffer.subarray(e,e+t),r=[this.fmBuffer[0].subarray(e,e+t),this.fmBuffer[1].subarray(e,e+t),this.fmBuffer[2].subarray(e,e+t),this.fmBuffer[3].subarray(e,e+t)];for(var i=0;i<t;i++)n[i]=0;for(var s=0;s<this.maxChannel;s++)this.module[s].generate(n,r);for(var o=0;o<p.MAX_MIDI_PORT;++o){if(!this.midi[o].device||this.midi[o].reference==0)continue;this.midi[o].device.generate(t);var u=this.midi[o].inBuffer;for(var a=0;a<t;++a)n[a]+=u[a]}},p.prototype.addrefMidi=function(e){if(p.MAX_MIDI_PORT<=e)return;this.midi[e].reference++},p.prototype.derefMidi=function(e){if(p.MAX_MIDI_PORT<=e)return;this.midi[e].reference--},p.Module=function(e,t){this.id=t,this.channel=e,this.volume={l:0,r:0,c:0},this.frequency=0,this.fm={inRate:0,inPipe:0,outMode:0,outPipe:0},this.multiple=1,this.note=0,this.setType(p.Module.TYPE_PSG)},p.Module.TYPE_INVALID=-1,p.Module.TYPE_PSG=0,p.Module.TYPE_FC=1,p.Module.TYPE_NOISE=2,p.Module.TYPE_SIN=3,p.Module.TYPE_SCC=4,p.Module.TYPE_OSC=5,p.Module.TYPE_GB_SQUARE=13,p.Module.TYPE_GB_WAVE=14,p.Module.TYPE_MIDI=15,p.Module.prototype.setType=function(e){this.type==p.Module.TYPE_MIDI&&this.channel.derefMidi(this.mid),this.type=e,this.count=0,this.phase=0,this.voice=0,this.mid=0,this.mch=0;switch(e){case p.Module.TYPE_PSG:this.generate=this.generatePsg;break;case p.Module.TYPE_FC:this.generate=this.generateFc,this.voice=3;break;case p.Module.TYPE_NOISE:this.generate=this.generateNoise;break;case p.Module.TYPE_SCC:this.generate=this.generateScc;break;case p.Module.TYPE_SIN:this.generate=this.generateSin;break;case p.Module.TYPE_MIDI:this.generate=this.generateNothing,this.channel.addrefMidi(this.mid);break;default:t.getLog().warn("TSC: unknown device type "+e),this.generate=this.generateNothing}},p.Module.prototype.setFmInPipe=function(e,t){this.fm.inRate=e,this.fm.inPipe=t},p.Module.prototype.setFmOutPipe=function(e,t){this.fm.outMode=e,this.fm.outPipe=t},p.Module.prototype.generatePsg=function(e,t){var n=this.volume.l<<4,r=this.volume.r<<4,i=e.length,s=this.frequency*2*this.multiple,o=this.count,u=this.phase;0==u&&(n=-n,r=-r);for(var a=0;a<i;a+=2){e[a+0]+=n,e[a+1]+=r,o+=s;while(o>this.channel.sampleRate)n=-n,r=-r,o-=this.channel.sampleRate,u++,u&=1}this.count=o,this.phase=u},p.Module.prototype.generateFc=function(e,t){var n=this.volume.l<<4,r=this.volume.r<<4,i=e.length,s=this.frequency*8*this.multiple,o=this.count,u=this.phase,a=this.voice;u<a&&(n=-n,r=-r);for(var f=0;f<i;f+=2){e[f+0]+=n,e[f+1]+=r,o+=s;while(o>this.channel.sampleRate){o-=this.channel.sampleRate,u++,u&=7;if(u==0||u==a)n=-n,r=-r}}this.count=o,this.phase=u},p.Module.prototype.generateNoise=function(e,t){var n=this.volume.l>>2,r=this.volume.r>>2,i=e.length,s=this.frequency*this.multiple,o=this.count,u=this.phase;for(var a=0;a<i;a+=2){var f=p._RND_TABLE[u];e[a+0]+=f*n,e[a+1]+=f*r,o+=s;while(o>0)u++,u&=4095,o-=880}this.count=o,this.phase=u},p.Module.prototype.generateScc=function(e,t){var n=this.channel.wave[this.voice];if(!n)return;var r=e;p.FM_OUT_MODE_OFF!=this.fm.outMode&&(r=t[this.fm.outPipe]);var i=this.volume.l>>2,s=this.volume.r>>2,o=e.length,u=this.frequency*32*this.multiple,a=this.count,f=this.phase,l;if(0==this.fm.inRate)if(p.FM_OUT_MODE_NEW==this.fm.outMode)for(l=0;l<o;l+=2){r[l+0]=n[f]*i,r[l+1]=n[f]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}else for(l=0;l<o;l+=2){r[l+0]+=n[f]*i,r[l+1]+=n[f]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}else{var c=t[this.fm.inPipe],h=this.fm.inRate<<3,d,v;if(p.FM_OUT_MODE_NEW==this.fm.outMode)for(l=0;l<o;l+=2){d=f+(c[l+0]>>h)&31,v=f+(c[l+1]>>h)&31,r[l+0]=n[d]*i,r[l+1]=n[v]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}else for(l=0;l<o;l+=2){d=f+(c[l+0]>>h)&31,v=f+(c[l+1]>>h)&31,r[l+0]+=n[d]*i,r[l+1]+=n[v]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}}this.count=a,this.phase=f},p.Module.prototype.generateSin=function(e,t){var n=e;p.FM_OUT_MODE_OFF!=this.fm.outMode&&(n=t[this.fm.outPipe]);var r=this.volume.l>>1,i=this.volume.r>>1,s=e.length,o=this.frequency*256*this.multiple,u=this.count,a=this.phase,f;if(0==this.fm.inRate)if(p.FM_OUT_MODE_NEW==this.fm.outMode)for(f=0;f<s;f+=2){n[f+0]=p._SIN_TABLE[a]*r,n[f+1]=p._SIN_TABLE[a]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}else for(f=0;f<s;f+=2){n[f+0]+=p._SIN_TABLE[a]*r,n[f+1]+=p._SIN_TABLE[a]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}else{var l=t[this.fm.inPipe],c=this.fm.inRate,h,d;if(p.FM_OUT_MODE_NEW==this.fm.outMode)for(f=0;f<s;f+=2){h=a+(l[f+0]>>c)&255,d=a+(l[f+1]>>c)&255,n[f+0]=p._SIN_TABLE[h]*r,n[f+1]=p._SIN_TABLE[d]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}else for(f=0;f<s;f+=2){h=a+(l[f+0]>>c)&255,d=a+(l[f+1]>>c)&255,n[f+0]+=p._SIN_TABLE[h]*r,n[f+1]+=p._SIN_TABLE[d]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}}this.count=u,this.phase=a},p.Module.prototype.generateNothing=function(e,t){},p.MIDI=function(){this.device=null,this.bufferLength=0,this.inBuffer=null,this.reference=0},p.MIDI.prototype.setDevice=function(e){e&&this.bufferLength!=0&&(e.setBufferLength(length),this.inBuffer=this.device.getBuffer()),this.device=e},p.MIDI.prototype.setBufferLength=function(e){this.bufferLength=e,this.device&&(this.device.setBufferLength(e),this.inBuffer=this.device.getBuffer())};var d=function(){this.device=null,this.input=null,this.header=null,this.channel=null,this.activeChannel=0,this.midi=new Array(d.MAX_MIDI_PORT),this.table=[];for(var e=0;e<256;e++)this.table[e]=new Uint8Array(0)};d.VERSION=.94,d.MAX_MIDI_PORT=p.MAX_MIDI_PORT,d.CMD_LAST_NOTE=127,d.CMD_NOTE_OFF=128,d.CMD_VOLUME_MONO=129,d.CMD_SUSTAIN_MODE=130,d.CMD_DETUNE=131,d.CMD_PORTAMENT=132,d.CMD_VOLUME_LEFT=133,d.CMD_VOLUME_RIGHT=134,d.CMD_PANPOT=135,d.CMD_RELATIVE_VOLUME_UP=136,d.CMD_RELATIVE_VOLUME_DOWN=137,d.CMD_TEMPO=144,d.CMD_FINENESS=145,d.CMD_KEY_ON_PHASE=146,d.CMD_MULTIPLE=147,d.CMD_PITCH_MODULATION_DELAY=160,d.CMD_PITCH_MODULATION_DEPTH=161,d.CMD_PITCH_MODULATION_WIDTH=162,d.CMD_PITCH_MODULATION_HEIGHT=163,d.CMD_PITCH_MODULATION_DELTA=164,d.CMD_AMP_EMVELOPE=184,d.CMD_NOTE_EMVELOPE=200,d.CMD_ENDLESS_LOOP_POINT=224,d.CMD_LOCAL_LOOP_START=225,d.CMD_LOCAL_LOOP_BREAK=226,d.CMD_LOCAL_LOOP_END=227,d.CMD_FREQUENCY_MODE_CHANGE=240,d.CMD_VOLUME_MODE_CHANGE=241,d.CMD_FM_IN=248,d.CMD_FM_OUT=249,d.CMD_CONTROL_CHANGE=251,d.CMD_PORT_CHANGE=252,d.CMD_VOICE_CHANGE=253,d.CMD_MODULE_CHANGE=254,d.CMD_END=255,d._DEFAULT_TIMER_COUNT=368,d._TIMER_AUTOMATION=0,d._TIMER_SEQUENCER=1,d._CH_L=p.MODULE_CHANNEL_L,d._CH_R=p.MODULE_CHANNEL_R,d._CH_C=p.MODULE_CHANNEL_C,d._PAN_L=1,d._PAN_R=2,d._PAN_C=d._PAN_L|d._PAN_R,d._FREQUENCY_TYPE_NORMAL=0,d._FREQUENCY_TYPE_MSX=1,d._FREQUENCY_TYPE_FM=2,d._FREQUENCY_TYPE_GB_SQUARE=3,d._VOLUME_TYPE_NORMAL=0,d._VOLUME_TYPE_FM=1,d._NOTE_FREQUENCY_TABLE=[null,null,null,null],d._NOTE_PARAMETER_TABLE=[null,null,null,null],d._PARAMETER_FREQUENCY_TABLE=[null,null,null,null],d._FM_VOLUME_TABLE=null,d._MSX_PARAMETER_TABLE=[3421,3228,3047,2876,2715,2562,2419,2283,2155,2034,1920,1812,1711,1614,1524,1438,1358,1281,1210,1142,1078,1017,960,906,855,807,762,719,679,641,605,571,539,509,480,453,428,404,381,360,339,320,302,285,269,254,240,227,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,71,67,64,60,57,53,50,48,45,42,40,38,36,34,32,30,28,27,25,24,22,21,20,19,18,17,16,15,14],function(){var e,t=new Uint16Array(128);d._NOTE_FREQUENCY_TABLE[d._FREQUENCY_TYPE_NORMAL]=t;for(e=0;e<128;e++)t[e]=~~(440*Math.pow(2,(e-69)/12)+.5);t=new Uint16Array(128),d._NOTE_FREQUENCY_TABLE[d._FREQUENCY_TYPE_GB_SQUARE]=t;for(e=0;e<128;e++){var n=440*Math.pow(2,(e-69)/12),r=2048-131072/n+.5;r<0&&(r=0),t[e]=r}t=new Uint16Array(128),d._NOTE_PARAMETER_TABLE[d._FREQUENCY_TYPE_MSX]=t;for(e=0;e<12;e++)t[e]=0;for(e=12;e<108;e++)t[e]=d._MSX_PARAMETER_TABLE[e-12];for(e=108;e<128;e++)t[e]=0;t=new Uint16Array(4096),d._PARAMETER_FREQUENCY_TABLE[d._FREQUENCY_TYPE_MSX]=t,t[0]=0;for(e=1;e<4096;e++)t[e]=~~(111860.78125/e/2+.5);t=new Uint16Array(8192),d._PARAMETER_FREQUENCY_TABLE[d._FREQUENCY_TYPE_FM]=t;for(e=0;e<8192;e++){var i=e>>6,s=e&63,o=(i-69+s/64)/12;t[e]=~~(440*Math.pow(2,o)+.5)}t=new Uint8Array(256),d._FM_VOLUME_TABLE=t;for(e=0;e<256;e++)t[e]=~~(255*Math.pow(10,-0.75*(255-e)/2/20)+.5)}(),d.prototype.setMasterChannel=function(e){this.device=new p,this.device.setPlayer(this),this.device.setVirtualDevices(this.midi),e.clearChannel(),e.addChannel(this.device)},d.prototype.setMIDI=function(e,t){return e>=d.MAX_MIDI_PORT?!1:(this.midi[e]=t,this.device&&this.device.setVirtualDevices(this.midi),!0)},d.prototype._readI8=function(e){var t=this.input[e];return t>=128&&(t-=256),t},d.prototype._readU16=function(e){return this.input[e]<<8|this.input[e+1]},d.prototype._readU32=function(e){var t=this.input[e]<<24|this.input[e+1]<<16|this.input[e+2]<<8|this.input[e+3];return t<0?4294967296+t:t},d.prototype._clamp=function(e,t,n){return e<t?t:e>n?n:e},d.prototype._setTable=function(e,n){t.getLog().info("TSD: Set envelope table "+e),t.getLog().info(n),this.table[e]=n},d.prototype.play=function(e){try{this.input=new Uint8Array(e);var n=m.createFromUint8Array(this.input);if(!n.containASCII(0,"T'SoundSystem"))return t.getLog().warn("TSD: magic T'SoundSystem not found."),!1;var r={};r.majorVersion=this.input[14],r.minorVersion=this.input[15],r.fullVersion=r.majorVersion+r.minorVersion/100,t.getLog().info("TSD: version = "+r.fullVersion);if(r.fullVersion<=.6||d.VERSION<r.fullVersion)return t.getLog().warn("TSD: unsupported format"),!1;r.titleSize=this._readU16(16),r.title=m.createFromUint8Array(this.input.subarray(18,18+r.titleSize)).toString(),t.getLog().info("TSD: title = "+r.title);var i=18+(r.titleSize+1&-2);r.numOfChannel=this._readU16(i),i+=2,t.getLog().info("TSD: channel = "+r.numOfChannel),this.device.reset(),this.device.setMaxChannel(r.numOfChannel),this.header=r,this.activeChannel=r.numOfChannel;var s=[],o;for(o=0;o<r.numOfChannel;o++){s[o]={id:o,baseOffset:0,size:0,offset:0,loop:{offset:0,count:0},localLoop:[],wait:1,sustain:0,portament:0,detune:0,keyOn:!1,volume:{type:0,l:0,c:0,r:0},pan:d._PAN_C,frequency:{type:0,note:0,param:0,hz:0},tone:0,phase:0,pitchModulation:{enable:!1,base:0,delayCount:0,widthCount:0,deltaCount:0,currentDepth:0,currentHeight:0,currentDiff:0,delay:0,depth:0,width:0,height:0,delta:0},ampEnvelope:{enable:!1,id:0,wait:0,state:0,count:0,volume:{l:0,r:0}},nt:{enable:!1,id:0,wait:0,state:0,count:0}};for(var u=0;u<16;u++)s[o].localLoop[u]={offset:0,count:0,end:0};s[o].baseOffset=this._readU32(i),i+=4,s[o].size=this._readU32(i),i+=4,t.getLog().info("TSD: ch."+(o+1)+" offset = "+s[o].baseOffset+", size = "+s[o].size)}t.getLog().info(s),this.channel=s;var a=this._readU32(i);t.getLog().info("TSD: table offset = "+a),i=a;var f=this._readU16(i);t.getLog().info("TSD: found "+f+" wave table(s)"),i+=2;for(o=0;o<f;o++){if(32!=this.input[i+1])return t.getLog().error("TSD: invalid WAVE size"),!1;this.device.setWave(this.input[i],new Int8Array(e,i+2,32)),i+=34}var l=this._readU16(i);t.getLog().info("TSD: found "+l+" envelope table(s)"),i+=2;for(o=0;o<l;o++){var c=this.input[i+1];this._setTable(this.input[i],new Int8Array(e,i+2,c)),i+=2+c}this.device.setTimerCallback(d._TIMER_AUTOMATION,d._DEFAULT_TIMER_COUNT,this,this._performAutomation),this.device.setTimerCallback(d._TIMER_SEQUENCER,d._DEFAULT_TIMER_COUNT,this,this._performSequencer)}catch(h){return t.getLog().error("TSD: "+h),!1}return!0},d.prototype._performAutomation=function(){for(var e=0;e<this.header.numOfChannel;e++){var t=this.channel[e];t.keyOn||(0!=t.sustain&&this._performSustain(t),0!=t.portament&&this._performPortament(t)),t.pitchModulation.enable&&this._performPitchModulation(t),t.ampEnvelope.enable&&this._performAmpEnvelope(t)}},d.prototype._performSustain=function(e){e.ampEnvelope.volume.l>e.sustain?e.ampEnvelope.volume.l-=e.sustain:e.ampEnvelope.volume.l=0,e.ampEnvelope.volume.r>e.sustain?e.ampEnvelope.volume.r-=e.sustain:e.ampEnvelope.volume.r=0;var t=e.pan;e.pan=d._PAN_C,this._setVolume(e,d._CH_L,e.ampEnvelope.volume.l),this._setVolume(e,d._CH_R,e.ampEnvelope.volume.r),e.pan=t},d.prototype._performPortament=function(e){var t=e.frequency.hz;switch(e.frequency.type){case d._FREQUENCY_TYPE_NORMAL:e.frequency.param+e.portament<1?e.frequency.param=1:e.frequency.param+e.portament>65535?e.frequency.param=65535:e.frequency.param+=e.portament,t=e.frequency.param;break;case d._FREQUENCY_TYPE_MSX:e.frequency.param-e.portament<0?e.frequency.param=0:e.frequency.param-e.portament>4095?e.frequency.param=4095:e.frequency.param-=e.portament,t=d._PARAMETER_FREQUENCY_TABLE[d._FREQUENCY_TYPE_MSX][e.frequency.param];break;case d._FREQUENCY_TYPE_FM:e.frequency.param+e.portament<0?e.frequency.param=0:e.frequency.param+e.portament>8191?e.frequency.param=8191:e.frequency.param+=e.portament,t=d._PARAMETER_FREQUENCY_TABLE[d._FREQUENCY_TYPE_FM][e.frequency.param];break;case d._FREQUENCY_TYPE_GB_SQUARE:}this.device.setModuleFrequency(e.id,t)},d.prototype._performPitchModulation=function(e){var t=e.pitchModulation;if(t.delayCount<t.delay){t.delayCount++;return}if(t.delayCount==t.delay){switch(e.frequency.type){case d._FREQUENCY_TYPE_NORMAL:t.base=e.frequency.hz;break;case d._FREQUENCY_TYPE_MSX:t.base=e.frequency.param;break;case d._FREQUENCY_TYPE_FM:t.base=e.frequency.param;break;case d._FREQUENCY_TYPE_GB_SQUARE:}t.currentDepth=t.depth,t.currentHeight=t.height,t.currentDiff=0,t.widthCount=0,t.deltaCount=0,t.delayCount++;return}if(++t.widthCount!=t.width)return;t.widthCount=0,t.currentDiff+=t.currentHeight;if(t.currentDiff>=t.currentDepth||t.currentDiff<=-t.currentDepth)t.currentHeight=-t.currentHeight,t.deltaCount++,t.deltaCount==t.delta&&(t.deltaCount=0,t.currentDepth++);var n=e.frequency.hz,r;switch(e.frequency.type){case d._FREQUENCY_TYPE_NORMAL:n=t.base+t.currentDiff;break;case d._FREQUENCY_TYPE_MSX:r=t.base+t.currentDiff,r<0?r=0:r>4095&&(r=4095),n=d._PARAMETER_FREQUENCY_TABLE[d._FREQUENCY_TYPE_MSX][r];break;case d._FREQUENCY_TYPE_FM:r=t.base+t.currentDiff,r<0?r=0:r>8191&&(r=8191),n=d._PARAMETER_FREQUENCY_TABLE[d._FREQUENCY_TYPE_FM][r];break;case d._FREQUENCY_TYPE_GB_SQUARE:}this.device.setModuleFrequency(e.id,n)},d.prototype._performAmpEnvelope=function(e){var t=e.ampEnvelope;if(++t.count!=t.wait)return;t.count=0;var n=this.table[t.id][t.state];t.state++,t.state==this.table[t.id].length&&t.state--;var r=t.volume.l+n,i=t.volume.r+n;0!=(e.pan&d._PAN_L)?r=this._clamp(r,0,255):r=0,0!=(e.pan&d._PAN_R)?i=this._clamp(i,0,255):i=0,this._setVolume(e,d._CH_L,r),this._setVolume(e,d._CH_R,i)},d.prototype._performSequencer=function(){for(var e=0;e<this.header.numOfChannel;e++){var n=this.channel[e];if(0==n.wait)continue;if(0!=--n.wait)continue;for(;;){var r=this.input[n.baseOffset+n.offset++],i,s;if(r<=d.CMD_LAST_NOTE){this._noteOn(n,r),n.wait=this.input[n.baseOffset+n.offset++],255==n.wait&&(n.wait=this._readU16(n.baseOffset+n.offset),n.offset+=2);if(0!=n.wait)break}else if(r==d.CMD_NOTE_OFF){this._noteOff(n),n.wait=this.input[n.baseOffset+n.offset++],255==n.wait&&(n.wait=this._readU16(n.baseOffset+n.offset),n.offset+=2);if(0!=n.wait)break}else if(r==d.CMD_VOLUME_MONO)i=this.input[n.baseOffset+n.offset++],n.volume.c=i,n.pan&d._PAN_L&&(n.volume.l=i),n.pan&d._PAN_R&&(n.volume.r=i);else if(r==d.CMD_SUSTAIN_MODE)n.sustain=this.input[n.baseOffset+n.offset++];else if(r==d.CMD_DETUNE)n.detune=this._readI8(n.baseOffset+n.offset),n.offset++,this.device.pitchBend(n.id,n.detune*128);else if(r==d.CMD_PORTAMENT)n.portament=this._readI8(n.baseOffset+n.offset),n.offset++,n.pitchModulation.enable=!1;else if(r==d.CMD_VOLUME_LEFT)n.offset++,t.getLog().info("TSD: volume left");else if(r==d.CMD_VOLUME_RIGHT)n.offset++,t.getLog().info("TSD: volume right");else if(r==d.CMD_PANPOT){n.pan=this.input[n.baseOffset+n.offset++];if(n.pan!=0){var o=n.pan==1?0:n.pan==2?127:64;this.device.panpot(n.id,o)}}else if(r==d.CMD_RELATIVE_VOLUME_UP)n.offset++,t.getLog().info("TSD: volume up");else if(r==d.CMD_RELATIVE_VOLUME_DOWN)n.offset++,t.getLog().info("TSD: volume down");else if(r==d.CMD_TEMPO)i=this._readU16(n.baseOffset+n.offset),n.offset+=2,this._setSequencerFineness(i);else if(r==d.CMD_FINENESS)i=this._readU16(n.baseOffset+n.offset),n.offset+=2,this._setAutomationFineness(i);else if(r==d.CMD_KEY_ON_PHASE)n.offset++,t.getLog().info("TSD: key on phase");else if(r==d.CMD_MULTIPLE)n.offset++,t.getLog().info("TSD: multiple");else if(r==d.CMD_PITCH_MODULATION_DELAY)i=this._readU16(n.baseOffset+n.offset),n.offset+=2,n.pitchModulation.delay=i,n.pitchModulation.enable=0!=i,n.portament=0;else if(r==d.CMD_PITCH_MODULATION_DEPTH)i=this.input[n.baseOffset+n.offset++],n.pitchModulation.depth=i;else if(r==d.CMD_PITCH_MODULATION_WIDTH)i=this.input[n.baseOffset+n.offset++],n.pitchModulation.width=i;else if(r==d.CMD_PITCH_MODULATION_HEIGHT)i=this._readI8(n.baseOffset+n.offset),n.offset++,n.pitchModulation.height=i;else if(r==d.CMD_PITCH_MODULATION_DELTA)i=this.input[n.baseOffset+n.offset++],n.pitchModulation.delta=i;else if(r==d.CMD_AMP_EMVELOPE)i=this.input[n.baseOffset+n.offset++],n.ampEnvelope.id=i,i=this.input[n.baseOffset+n.offset++],n.ampEnvelope.wait=i,n.ampEnvelope.enable=0!=i;else if(r==d.CMD_ENDLESS_LOOP_POINT)n.loop.offset=n.offset;else if(r==d.CMD_LOCAL_LOOP_START)i=this.input[n.baseOffset+n.offset++],n.localLoop[i].count=this.input[n.baseOffset+n.offset++],n.localLoop[i].offset=n.offset;else if(r==d.CMD_LOCAL_LOOP_BREAK)i=this.input[n.baseOffset+n.offset++],n.localLoop[i].count==1&&(n.offset=n.localLoop[i].end);else if(r==d.CMD_LOCAL_LOOP_END)i=this.input[n.baseOffset+n.offset++],n.localLoop[i].end=n.offset,0!=--n.localLoop[i].count&&(n.offset=n.localLoop[i].offset);else if(r==d.CMD_FREQUENCY_MODE_CHANGE)n.frequency.type=this.input[n.baseOffset+n.offset++];else if(r==d.CMD_VOLUME_MODE_CHANGE)n.volume.type=this.input[n.baseOffset+n.offset++];else if(r==d.CMD_FM_IN)i=this.input[n.baseOffset+n.offset++],this._setFmInPipe(n,i>>4,i&15);else if(r==d.CMD_FM_OUT)i=this.input[n.baseOffset+n.offset++],this._setFmOutPipe(n,i>>4,i&15);else if(r==d.CMD_CONTROL_CHANGE)t.getLog().error("TSD: control change is not implemented.");else if(r==d.CMD_PORT_CHANGE)i=this.input[n.baseOffset+n.offset++],s=this.input[n.baseOffset+n.offset++],this._setPort(n,i,s);else if(r==d.CMD_VOICE_CHANGE)i=this.input[n.baseOffset+n.offset++],this._setVoice(n,i);else if(r==d.CMD_MODULE_CHANGE)i=this.input[n.baseOffset+n.offset++],this._setModule(n,i);else{if(r!=d.CMD_END){t.getLog().error("TSD: unsupported cmd "+r.toString(16)),t.getLog().info(this);break}if(0==n.loop.offset){this._noteOff(n),this.activeChannel--;break}n.offset=n.loop.offset,n.loop.count++}}}},d.prototype._noteOn=function(e,t){var n=e.frequency.type,r,i;switch(n){case d._FREQUENCY_TYPE_NORMAL:r=e.detune+d._NOTE_FREQUENCY_TABLE[n][t],i=r;break;case d._FREQUENCY_TYPE_MSX:r=e.detune+d._NOTE_PARAMETER_TABLE[n][t],i=d._PARAMETER_FREQUENCY_TABLE[n][r];break;case d._FREQUENCY_TYPE_FM:r=e.detune+t<<6,i=d._PARAMETER_FREQUENCY_TABLE[n][r];break;case d._FREQUENCY_TYPE_GB_SQUARE:r=e.detune+d._NOTE_FREQUENCY_TABLE[n][t],i=r}this.device.setModuleFrequency(e.id,i),e.frequency.note=t,e.frequency.param=r,e.frequency
.hz=i,this._setVolume(e,d._CH_L,e.volume.l),this._setVolume(e,d._CH_R,e.volume.r),this._setVolume(e,d._CH_C,e.volume.c),e.keyOn&&this.device.keyOff(e.id),e.keyOn=!0,this.device.setModulePhase(e.id,e.phase),this.device.keyOn(e.id,t),e.ampEnvelope.volume.l=e.volume.l,e.ampEnvelope.volume.r=e.volume.r,e.ampEnvelope.state=0,e.ampEnvelope.count=0,e.pitchModulation.delayCount=0},d.prototype._noteOff=function(e){0==e.sustain&&(e.ampEnvelope.enable?(e.ampEnvelope.volume.l=this.device.getModuleVolume(e.id,d._CH_L),e.ampEnvelope.volume.r=this.device.getModuleVolume(e.id,d._CH_R)):(this.device.setModuleVolume(e.id,d._CH_L,0),this.device.setModuleVolume(e.id,d._CH_R,0))),e.keyOn=!1,this.device.keyOff(e.id)},d.prototype._setVolume=function(e,t,n){var r=n;d._CH_L==t&&0==(e.pan&d._PAN_L)?r=0:d._CH_R==t&&0==(e.pan&d._PAN_R)?r=0:d._VOLUME_TYPE_FM==e.volume.type&&(r=d._FM_VOLUME_TABLE[r]),this.device.setModuleVolume(e.id,t,r)},d.prototype._setSequencerFineness=function(e){this.device.setTimerCallback(d._TIMER_SEQUENCER,e,this,this._performSequencer)},d.prototype._setAutomationFineness=function(e){this.device.setTimerCallback(d._TIMER_AUTOMATION,e,this,this._performAutomation)},d.prototype._setFmInPipe=function(e,t,n){var r=t;0!=r&&(r=9-r),this.device.setModuleFmInPipe(e.id,r,n)},d.prototype._setFmOutPipe=function(e,t,n){this.device.setModuleFmOutPipe(e.id,t,n)},d.prototype._setPort=function(e,t,n){this.device.setModulePort(e.id,t,n)},d.prototype._setVoice=function(e,t){this.device.setModuleVoice(e.id,t);if(p.Module.TYPE_SIN!=this.device.getModuleType(e.id))return;var n=t>>4,r=t&15;0!=n?this._setFmInPipe(e,5,n%5-1):this._setFmInPipe(e,0,0),0!=r?this._setFmOutPipe(e,1,r%5-1):this._setFmOutPipe(e,0,0)},d.prototype._setModule=function(e,t){this.device.setModuleType(e.id,t&15),0!=(t&128)?e.frequency.type=t>>7:e.frequency.type=t>>4};var v=function(){this.logMmlCompile=!1,this.source=null,this.directives=[],this.channels=[],this.validWaves=0,this.waves=[],this.validTables=0,this.tables=[],this.tags={title:null,channels:0,fineness:v._DEFAULT_FINENESS},this.modes={hardware:v.HARDWARE_MODE_NORMAL,octave:v.OCTAVE_MODE_NORMAL,volumeRelative:v.VOLUME_RELATIVE_MODE_NORMAL},this.channelData=[]};v.VERSION=.94,v.HARDWARE_MODE_NORMAL=0,v.HARDWARE_MODE_FAMICOM=1,v.HARDWARE_MODE_GAMEBOY=2,v.VOLUME_RANGE_MODE_NORMAL=0,v.VOLUME_RANGE_MODE_UPPER=1,v.VOLUME_RELATIVE_MODE_NORMAL=0,v.VOLUME_RELATIVE_MODE_REVERSE=1,v.OCTAVE_MODE_NORMAL=0,v.OCTAVE_MODE_REVERSE=1,v._DEFAULT_FINENESS=368,v._ALPHABET_COUNT="z".charCodeAt(0)-"a".charCodeAt(0)+1,v._CODE_ESCAPE="\\".charCodeAt(0),v._CODE_SHARP="#".charCodeAt(0),v._CODE_GT=">".charCodeAt(0),v._TONE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11},v._TRIANGLE_TABLE=[0,16,32,48,64,80,96,112,127,112,96,80,64,48,32,16,0,-16,-32,-48,-64,-80,-96,-112,-128,-112,-96,-80,-64,-48,-32,-16],v.CompileError=function(e,t,n){this.line=e,this.offset=t,this.message=n},v.CompileError.prototype.toString=function(){var e=0,t,n,r=this.line.data;for(n=0;n<=this.offset;n++){t=r.at(n);if(0==t||v._CODE_ESCAPE==t)continue;e++}var i=new Uint8Array(e--);for(n=0;n<e;n++)i[n]=32;i[n]="^".charCodeAt(0);var s=m.createFromUint8Array(i).toString();return"TSS: { line: "+this.line.line+", offset: "+this.offset+" } "+this.message+"\n"+r.toString()+"\n"+s},v._toUint8=function(e){if(e<-128||127<e)throw new RangeError("unsupported range");return e<0&&(e=256+e),e&255},v._getBracedParameter=function(e,t){var n=e.data,r=n.byteLength(),i=t+n.countSpaces(t);if(i>=r||"<"!=n.charAt(i))return{begin:i,end:i,parameter:undefined};i++;var s=0,o=0;for(var u=i;u<r;u++){o=n.at(u);if(0==o||v._CODE_ESCAPE==o)continue;if(v._CODE_GT==o)break;s++}var a=i+s-1,f=m.createFromUint8Array(new Uint8Array(s));s=0;for(u=i;u<=a;u++){o=n.at(u);if(0==o||v._CODE_ESCAPE==o)continue;f.setAt(s++,o)}return{begin:i-1,end:a+1,parameter:f}},v._getNumberParameter=function(e,t){var n=e.data,r=t+n.countSpaces(t),i=n.byteLength();if(r>=i)return{begin:r,end:r,parameter:undefined};var s=1;"-"==n.charAt(r)&&(r++,r+=n.countSpaces(r),s=-1);var o=n.numberAt(r);if(o<0)return{begin:r,end:r,parameter:undefined};var u=0;for(var a=r+1;a<i;a++){u=n.at(a);if(0==u||v._CODE_ESCAPE==u)continue;var f=n.numberAt(a);if(f<0)return{begin:r,end:a-1,parameter:s*o};o=o*10+f}return{begin:r,end:a-1,parameter:s*o}},v._getStringParameter=function(e,t){var n=e.data,r=t+n.countSpaces(t),i=n.byteLength(),s=0,o=0;for(var u=r;u<i;u++){o=n.at(u);if(0==o||v._CODE_ESCAPE==o)continue;s++}var a=r+s-1,f=m.createFromUint8Array(new Uint8Array(s));s=0;for(u=r;u<=a;u++){o=n.at(u);if(0==o||v._CODE_ESCAPE==o)continue;f.setAt(s++,o)}return{begin:r,end:a,parameter:f}},v._getTableParameter=function(e,n){var r={lines:e,line:0,offset:n},i=[],s=r.offset,o=r.lines[0].directive,u=v._getNumberParameter(r.lines[r.line],r.offset);if(typeof u.parameter=="undefined")throw new v.CompileError(r.lines[r.line],u.begin,"id number not found in #"+o);var a=u.parameter;if(a<0||255<a)throw new v.CompileError(r.lines[r.line],u.begin,"id "+a+" is out or range 0 to 255 in #"+o);r.offset=u.end+1,v._checkCharacter(r,",","',' not found after id number in #"+o),v._checkCharacter(r,"<","'<' not found in #"+o);for(;;){var f=v._findNextCharacter(r,"incomplete entry in #"+o);if("("==f){r.offset++;var l="number not found after '(' in #"+o;v._findNextCharacter(r,l),u=v._getNumberParameter(r.lines[r.line],r.offset);if(typeof u.parameter=="undefined")throw new v.CompileError(r.lines[r.line],u.begin,l);var c=u.parameter,h="number is out of range -128 to 127 in #"+o;if(c<-128||127<c)throw new v.CompileError(r.lines[r.line],u.begin,h);r.offset=u.end+1,v._checkCharacter(r,",","',' not found after the first number after '(' in #"+o);var p="the second number not found after '(' in #"+o;v._findNextCharacter(r,p),u=v._getNumberParameter(r.lines[r.line],r.offset);if(typeof u.parameter=="undefined")throw new v.CompileError(r.lines[r.line],u.begin,p);var d=u.parameter;if(d<-128||127<d)throw new v.CompileError(r.lines[r.line],u.begin,h);r.offset=u.end+1,v._checkCharacter(r,")","')' not found after the second number in #"+o),v._checkCharacter(r,",","',' not found after '(x,y)' syntax in #"+o);var m="number not found after '(x,y),' syntax in #"+o;v._findNextCharacter(r,m),u=v._getNumberParameter(r.lines[r.line],r.offset);if(typeof u.parameter=="undefined")throw new v.CompileError(r.lines[r.line],u.begin,m);var g=u.parameter;r.offset=u.end+1;var y=[];for(var b=0;b<g;b++){var w=~~(c+(d-c)*b/(g-1));y.push(w),i.push(w)}t.getLog().info("TSS: expanding ("+c+","+d+"),"+g+" to "+y)}else{var E="number not found in #"+o;v._findNextCharacter(r,E),u=v._getNumberParameter(r.lines[r.line],r.offset);if(typeof u.parameter=="undefined")throw new v.CompileError(r.lines[r.line],u.begin,E);if(u.parameter<-128||127<u.parameter)throw new v.CompileError(r.lines[r.line],u.begin,h);r.offset=u.end+1,i.push(u.parameter)}var S="',' or '>' not found in #"+o;f=v._findNextCharacter(r,S);if(","!=f){if(">"==f){r.offset++;break}throw new v.CompileError(r.lines[r.line],r.offset,S)}r.offset++}try{v._findNextCharacter(r,"")}catch(x){return t.getLog().info("TSS: table complete "+i),{begin:s,end:r.offset,parameter:{id:a,table:i}}}throw new v.CompileError(r.lines[r.line],r.offset,"unknown data after table in #"+o)},v._getCharacter=function(e,t,n){var r=e.data,i=t+r.countSpaces(t);return i>=r.byteLength()?-1:n!=r.charAt(i)?-1:i},v._findNextCharacter=function(e,t){var n=e.lines.length;v._checkEnd(e.lines[e.line],e.offset)&&e.line+1<n&&(e.line++,e.offset=0),e.offset+=e.lines[e.line].data.countSpaces(e.offset);if(e.offset==e.lines[e.line].data.byteLength())throw new v.CompileError(e.lines[e.line],e.offset,t);return e.lines[e.line].data.charAt(e.offset)},v._checkCharacter=function(e,t,n){v._findNextCharacter(e,n);var r=v._getCharacter(e.lines[e.line],e.offset,t);if(r<0)throw new v.CompileError(e.lines[e.line],e.offset,n);e.offset=r+1},v._checkEnd=function(e,t){var n=e.data;return t+=n.countSpaces(t),t==n.byteLength()},v._checkChannelDirective=function(e){if(2<e.directive.length||0==e.directive.length)return;var t=m.createFromString(e.directive),n=0,r=0,i;if(2==t.byteLength()){i=t.alphabetIndex(r++);if(i<0)return;n=i*v._ALPHABET_COUNT}i=t.alphabetIndex(r);if(i<0)return;n+=i,e.directive=n},v._checkDirective=function(e){var t=e.data,n=t.byteLength(),r=0;for(var i=0;i<n;i++){r=t.at(i);if(0==r)continue;if(v._CODE_SHARP==r){t.setAt(i++,0);break}e.directive=null;return}for(var s=i;i<n;i++)if(32==t.at(i))break;e.directive=t.slice(s,i).toString();for(var o=s;o<i;o++)t.setAt(o,0);v._checkChannelDirective(e)},v.prototype._setWave=function(e,n){t.getLog().info("TSC: set wave "+e),this.waves[e]||this.validWaves++,this.waves[e]=n},v.prototype._setTable=function(e,n){t.getLog().info("TSC: set table "+e+"; size = "+n.length),this.tables[e]||this.validTables++,this.tables[e]=n},v.prototype._preprocessLine=function(e,t,n){var r={line:e.line,offset:t,count:n,data:null,empty:!0,directive:null,continuation:!1},i=this.source.slice(t,t+n);r.data=i;for(var s=0;s<n;s++){var o=i.charAt(s);if(e.commentNest>0)"\\"==o?i.setAt(s++,0):"{"==o?e.commentNest++:"}"==o&&e.commentNest--,i.setAt(s,0);else if("\\"==o)i.setAt(s++,0),r.empty=!1;else if("{"==o)e.commentNest++,i.setAt(s,0);else if("}"==o){e.commentNest--,i.setAt(s,0);if(e.commentNest<0)throw new v.CompileError(r,s,"'}' appears without '{'")}else"	"==o&&i.setAt(s,32),r.empty=!1}return r.empty||v._checkDirective(r),r},v.prototype._parseLines=function(){var e={line:1,commentNest:0},n=null,r=this.source.byteLength();for(var i=0;i<r;e.line++){var s=this.source.countLine(i),o=this._preprocessLine(e,i,s);if(!o.empty){if(null==o.directive){if(null==n)throw new v.CompileError(o,0,"invalid line without any directive");o.directive=n,o.continuation=!0}else n=o.directive;if(typeof o.directive=="number")undefined==this.channels[o.directive]&&(this.channels[o.directive]=[]),this.channels[o.directive].push(o);else{if("END"==o.directive)break;this.directives.push(o)}}i+=s,i+=this.source.countLineDelimiter(i)}t.getLog().info("TSS: found "+this.directives.length+" directive(s)"),t.getLog().info("TSS: found "+this.channels.length+" channel(s)");for(var u=0;u<this.channels.length;u++){var a=0;undefined!=this.channels[u]&&(a=this.channels[u].length),t.getLog().info("TSS: channel "+(u+1)+" has "+a+" line(s)")}},v.prototype._parseDirectives=function(){for(var e=0;e<this.directives.length;e++){var n=this.directives[e].directive,r=0,i;if("CHANNEL"==n){i=v._getNumberParameter(this.directives[e],0);if(typeof i.parameter=="undefined")throw new v.CompileError(this.directives[e],i.begin,"number not found in #CHANNEL");this.tags.channels=i.parameter,r=i.end+1,t.getLog().info("TSS: CHANNEL> "+this.tags.channels)}else if("FINENESS"==n){i=v._getNumberParameter(this.directives[e],0);if(typeof i.parameter=="undefined")throw new v.CompileError(this.directives[e],i.begin,"number not found in #FINENESS");this.tags.fineness=i.parameter,r=i.end+1,t.getLog().info("TSS: FINENESS> "+this.tags.fineness)}else if("OCTAVE"==n){i=v._getStringParameter(this.directives[e],0);if(!i.parameter)throw new v.CompileError(this.directives[e],i.begin,"syntax error in #PRAGMA");var s=i.parameter.toString();if(s=="NORMAL")this.modes.octave=v.OCTAVE_MODE_NORMAL;else{if(s!="REVERSE")throw new v.CompileError(this.directive[e],i.begin,"invalid argument in #OCTAVE");this.modes.octave=v.OCTAVE_MODE_REVERSE}r=i.end+1}else if("PRAGMA"==n){i=v._getStringParameter(this.directives[e],0);if(!i.parameter)throw new v.CompileError(this.directives[e],i.begin,"syntax error in #PRAGMA");var o=i.parameter.toString();if(o=="FAMICOM")this.modes.hardware=v.HARDWARE_MODE_FAMICOM,this._setWave(0,v._TRIANGLE_TABLE);else{if(o!="GAMEBOY")throw new v.CompileError(this.directives[e],i.begin,"unknown pragma parameter "+o);this.modes.hardware=v.HARDWARE_MODE_GAMEBOY}r=i.end+1,t.getLog().info("TSS: PRAGMA> "+o)}else if("TABLE"==n){var u=[];for(;;e++){u.push(this.directives[e]);if(e+1==this.directives.length)break;if(!this.directives[e+1].continuation)break}i=v._getTableParameter(u,0),this._setTable(i.parameter.id,i.parameter.table),r=i.end}else if("TITLE"==n){i=v._getBracedParameter(this.directives[e],0);if(!i.parameter)throw new v.CompileError(this.directives[e],i.begin,"syntax error in #TITLE");this.tags.title=i.parameter,r=i.end+1,t.getLog().info("TSS: TITLE> "+this.tags.title.toString())}else if("VOLUME"==n){i=v._getStringParameter(this.directives[e],0);if(!i.parameter)throw new v.CompileError(this.directives[e],i.begin,"syntax error in #VOLUME");var a=i.parameter.toString();if(a=="NORMAL")this.modes.volumeRelative=v.VOLUME_RELATIVE_MODE_NORMAL;else{if(a!="REVERSE")throw new v.CompileError(this.directive[e],i.begin,"invalid argument in #VOLUME");this.modes.volumeRelative=v.VOLUME_RELATIVE_MODE_REVERSE}r=i.end+1}else{if("WAV"!=n)throw new v.CompileError(this.directives[e],0,"unknown directive: "+n);var u=[];for(;;e++){u.push(this.directives[e]);if(e+1==this.directives.length)break;if(!this.directives[e+1].continuation)break}i=v._getTableParameter(u,0);if(32!=i.parameter.table.length)throw new v.CompileError(this.directive[e],i.begin,"invalid wave table size "+i.parameter.table.length);this._setWave(i.parameter.id,i.parameter.table),r=i.end}if(!v._checkEnd(this.directives[e],r))throw new v.CompileError(this.directives[e],r,"syntax error after #"+n)}},v.prototype._parseChannels=function(){var e=16,n=function(e,t,n,r){throw new v.CompileError(t.lineObject,t.offset,"command '"+n+"' not implemented")},r=function(e,t,n,r){var i=255;t.mode==v.HARDWARE_MODE_GAMEBOY&&(i=16);var s="(";t.volumeRelativeMode!=v.VOLUME_RELATIVE_MODE_NORMAL&&(s=")");var o=t.currentVolume.r>=0;n==s?(t.currentVolume.l+=1<<t.volumeShift,o&&(t.currentVolume.r+=1<<t.volumeShift)):(t.currentVolume.l-=1<<t.volumeShift,o&&(t.currentVolume.r-=1<<t.volumeShift));if(t.currentVolume.l<0||t.currentVolume.l>i||o&&t.currentVolume.r<0||o&&t.currentVolume.r>i)throw new v.CompileError(t.lineObject,t.offset,"commmand '"+n+"' causes volume range error");o?(t.data.push(d.CMD_VOLUME_LEFT),t.data.push(t.currentVolume.l),t.data.push(d.CMD_VOLUME_RIGHT),t.data.push(t.currentVolume.r)):(t.data.push(d.CMD_VOLUME_MONO),t.data.push(t.currentVolume.l))},i={$:{args:[],callback:function(e,t,n,r){t.data.push(d.CMD_ENDLESS_LOOP_POINT)}},"%":{args:[{def:0,min:0,max:255}],callback:function(e,t,n,r){if(v.HARDWARE_MODE_FAMICOM==t.mode||v.HARDWARE_MODE_GAMEBOY==t.mode)throw new v.CompileError(t.lineObject,t.offset,"'%' is not supported in NES/GameBoy mode");t.data.push(d.CMD_MODULE_CHANGE),t.data.push(r[0])}},"(":{args:[],callback:r},")":{args:[],callback:r},"/":{sequence:":",args:[],callback:function(e,t,n,r){if(t.localLoopId==0)throw new v.CompileError(t.lineObject,t.offset,"'/' found without '/:'");t.data.push(d.CMD_LOCAL_LOOP_BREAK),t.data.push(t.localLoopId-1)}},"/:":{args:[{def:2,min:2,max:255}],callback:function(e,t,n,r){if(t.localLoopId>15)throw new v.CompileError(t.lineObject,t.offset,"local loop is too deep (>16)");t.data.push(d.CMD_LOCAL_LOOP_START),t.data.push(t.localLoopId++),t.data.push(r[0])}},":":{sequence:"/"},":/":{args:[],callback:function(e,t,n,r){if(t.localLoopId==0)throw new v.CompileError(t.lineObject,t.offset,"':/' found without '/:'");t.data.push(d.CMD_LOCAL_LOOP_END),t.data.push(--t.localLoopId)}},"<":{args:[],callback:function(e,t,n,r){v.OCTAVE_MODE_NORMAL==t.octaveMode?t.currentOctave++:t.currentOctave--}},">":{args:[],callback:function(e,t,n,r){v.OCTAVE_MODE_NORMAL==t.octaveMode?t.currentOctave--:t.currentOctave++}},"@":{sequence:"ciopv",args:[{def:0,min:0,max:255}],callback:function(e,t,n,r){if(v.HARDWARE_MODE_FAMICOM==t.mode){if(t.lineObject.directive==2)throw new v.CompileError(t.lineObject,t.offset,"'@' is not supported in famicom mode channel 3");if(2!=r[0]&&4!=r[0]&&6!=r[0]&&7!=r[0])throw new v.CompileError(t.lineObject,t.offset,"voice id "+r[0]+" is invalid in famicom mode")}t.data.push(d.CMD_VOICE_CHANGE),t.data.push(r[0])}},"@c":{args:[{def:0,min:0,max:127},{def:0,min:0,max:127}],callback:function(e,t,n,r){t.data.push(d.CMD_CONTROL_CHANGE),t.data.push(r[0]),t.data.push(r[1])}},"@i":{args:[{def:0,min:0,max:8},{def:0,min:0,max:3}],callback:function(e,t,n,r){t.data.push(d.CMD_FM_IN),t.data.push(r[0]<<4|r[1])}},"@o":{args:[{def:0,min:0,max:2},{def:0,min:0,max:3}],callback:function(e,t,n,r){t.data.push(d.CMD_FM_OUT),t.data.push(r[0]<<4|r[1])}},"@p":{args:[{def:0,min:0,max:3},{def:0,min:0,max:127}],callback:function(e,t,n,r){t.data.push(d.CMD_PORT_CHANGE),t.data.push(r[0]),t.data.push(r[1])}},"@v":{args:[{def:10,min:0,max:255},{def:0,min:0,max:255}],callback:function(e,t,n,r){t.volumeShift=0,1==r.length?(t.currentVolume.l=r[0],t.currentVolume.r=-1,t.data.push(d.CMD_VOLUME_MONO),t.data.push(r[0])):(t.currentVolume.l=r[0],t.currentVolume.r=r[1],t.data.push(d.CMD_VOLUME_LEFT),t.data.push(r[0]),t.data.push(d.CMD_VOLUME_RIGHT),t.data.push(r[1]))}},"]":{args:[],callback:function(e,t,n,r){if(0==t.loop.count)throw new v.CompileError(t.lineObject,t.offset,"']' found without '['");if(--t.loop.count==0)return;t.loop.end.line=t.line,t.loop.end.offset=t.offset,t.line=t.loop.line,t.offset=t.loop.offset,t.lineObject=e.channels[t.lineObject.directive][t.line]}},"[":{args:[{def:2,min:2,max:65535}],callback:function(e,t,n,r){t.loop.count=r[0],t.loop.line=t.line,t.loop.offset=t.offset}},_:{args:[],callback:n},"|":{args:[],callback:function(e,t,n,r){if(t.loop.count>1)return;t.line=t.loop.end.line,t.offset=t.loop.end.offset,t.lineObject=e.channels[t.lineObject.directive][t.line]}},"~":{args:[],callback:n},k:{args:[{def:0,min:-128,max:127}],callback:function(e,t,n,r){t.data.push(d.CMD_DETUNE),t.data.push(v._toUint8(r[0]))}},l:{args:[{def:4,min:1,max:1024}],callback:function(e,t,n,r){t.defaultLength=r[0],t.defaultDot=0;for(;;){var i=v._getCharacter(t.lineObject,t.offset,".");if(i<0)break;t.offset=i+1,t.defaultDot++}}},m:{sequence:"p",args:[],callback:n},mp:{args:[{def:undefined,min:0,max:65535},{def:undefined,min:0,max:255},{def:undefined,min:0,max:255},{def:undefined,min:-128,max:127},{def:undefined,min:0,max:255}],callback:function(e,t,n,r){typeof r[0]!="undefined"&&(t.data.push(d.CMD_PITCH_MODULATION_DELAY),t.data.push(r[0]>>8),t.data.push(r[0]&255));if(r.length<2)return;typeof r[1]!="undefined"&&(t.data.push(d.CMD_PITCH_MODULATION_DEPTH),t.data.push(r[1]));if(r.length<3)return;typeof r[2]!="undefined"&&(t.data.push(d.CMD_PITCH_MODULATION_WIDTH),t.data.push(r[2]));if(r.length<4)return;typeof r[3]!="undefined"&&(t.data.push(d.CMD_PITCH_MODULATION_HEIGHT),t.data.push(v._toUint8(r[3])));if(r.length<5)return;typeof r[4]!="undefined"&&(t.data.push(d.CMD_PITCH_MODULATION_DELTA),t.data.push(r[4]))}},n:{sequence:"ast"},na:{args:[{def:0,min:0,max:255},{def:0,min:0,max:255}],callback:function(e,t,n,r){t.data.push(d.CMD_AMP_EMVELOPE),t.data.push(r[0]),t.data.push(r[1])}},ns:{args:[],callback:n},nt:{args:[],callback:n},o:{args:[{def:4,min:0,max:10}],callback:function(e,t,n,r){t.currentOctave=r[0]}},p:{sequence:"h",args:[{def:0,min:0,max:3}],callback:function(e,t,n,r){t.data.push(d.CMD_PANPOT),t.data.push(r[0])}},ph:{args:[],callback:n},q:{args:[{def:e,min:0,max:e}],callback:function(e,t,n,r){t.currentGate=r[0]}},r:{args:[],callback:function(e,n,r,i){if("r"!=r)if(n.currentOctave<0||10<n.currentOctave)throw new v.CompileError(n.lineObject,n.offset,"current octave is out of range");n.offset+=n.lineObject.data.countSpaces(n.offset);var s=0;if(n.offset<n.lineObject.data.byteLength()){var o=n.lineObject.data.charAt(n.offset);if("-"==o||"+"==o||"#"==o)n.offset++,"-"==o?s=-1:s=1}var u=0;for(;;){var a=v._getNumberParameter(n.lineObject,n.offset),f=0,l=0;typeof a.parameter=="undefined"?(f=n.defaultLength,l=n.defaultDot):(f=a.parameter,n.offset=a.end+1);for(;;){var c=v._getCharacter(n.lineObject,n.offset,".");if(c<0)break;n.offset=c+1,l++}0!=n.clock%f&&t.getLog().warn("TSS: time resolution is not enough for length "+f);var h=~~(n.clock/f);u+=h;while(l-->0){if(0!=h%2)throw new v.CompileError(n.lineObject,n.offset,"too many '.' against time resolution");h/=2,u+=h}c=v._getCharacter(n.lineObject,n.offset,"^");if(c<0)break;n.offset=c+1}var p=0;n.count+=u,"r"==r?n.data.push(d.CMD_NOTE_OFF):(s+=n.currentOctave*12+v._TONE_TABLE[r],s<0?(t.getLog().warn("TSS: too low tone (clamped)"),s=0):s>127&&(t.getLog().warn("TSS: too high tone (clamped)"),s=127),n.data.push(s),p=u,u=~~(u*n.currentGate/n.maxGate),p-=u),e.logMmlCompile&&t.getLog().info(u+","+p);if(u<255)n.data.push(u);else{if(!(u<65535))throw new v.CompileError(n.lineObject,n.offset,"note length is too long");n.data.push(255),n.data.push(u>>8),n.data.push(u&255)}if(p>0){n.data.push(d.CMD_NOTE_OFF);if(p<255)n.data.push(p);else{if(!(p<65535))throw new v.CompileError(n.lineObject,n.offset,"rest length is too long");n.data.push(255),n.data.push(p>>8),n.data.push(p&255)}}}},s:{args:[{def:undefined,min:0,max:255},{def:undefined,min:-128,max:127}],callback:function(e,t,n,r){typeof r[0]!="undefined"&&(t.data.push(d.CMD_SUSTAIN_MODE),t.data.push(r[0])),2==r.length&&typeof r[1]!="undefined"&&(t.data.push(d.CMD_PORTAMENT),t.data.push(v._toUint8(r[1])))}},t:{args:[{def:120,min:1,max:512}],callback:function(e,t,n,r){var i=~~(27562.5/r[0]);t.data.push(d.CMD_TEMPO),t.data.push(i>>8),t.data.push(i&255)}},v:{args:[{def:10,min:0,max:15},{def:0,min:0,max:15}],callback:function(e,t,n,r){if(d.HARDWARE_MODE_GAMEBOY==t.mode&&2==t.lineObject.directive)for(var i=0;i<r.length;i++)if(r[i]>3)throw new v.CompileError(t.lineObject,t.offset,"volume must be less than 4 for channel 2 in gameboy mode");var s=0;t.volumeShift=3,d.HARDWARE_MODE_GAMEBOY==t.mode?t.volumeShift=0:v.VOLUME_RANGE_MODE_NORMAL==t.volumeRangeMode?t.volumeShift=4:s=128,1==r.length?(t.currentVolume.l=s+(r[0]<<t.volumeShift),t.currentVolume.r=-1,t.data.push(d.CMD_VOLUME_MONO),t.data.push(t.currentVolume.l)):(t.currentVolume.l=s+(r[0]<<t.volumeShift),t.currentVolume.r=s+(r[1]<<t.volumeShift),t.data.push(d.CMD_VOLUME_LEFT),t.data.push(t.currentVolume.l),t.data.push(d.CMD_VOLUME_RIGHT),t.data.push(t.currentVolume.r))}},x:{args:[{def:undefined,min:0,max:17},{def:undefined,min:0,max:3}],callback:function(e,t,n,r){if(r[0]!=undefined){if((r[0]&15)>1)throw new v.CompileError(t.lineObject,t.offset,"invalid volume mode "+r[0]+" for 'x'");(r[0]&16)==0?t.volumeRangeMode=v.VOLUME_RANGE_MODE_NORMAL:t.volumeRangeMode=v.VOLUME_RANGE_MODE_UPPER,t.data.push(d.CMD_VOLUME_MODE_CHANGE),t.data.push(r[0]&15)}r[1]!=undefined&&(t.data.push(d.CMD_FREQUENCY_MODE_CHANGE),t.data.push(r[1]))}}};for(var s=0;s<this.tags.channels;s++){var o={offset:0,line:0,lineObject:null,clock:192,maxGate:e,mode:this.modes.hardware,volumeRangeMode:v.VOLUME_RANGE_MODE_NORMAL,volumeRelativeMode:this.modes.volumeRelative,volumeShift:0,octaveMode:this.modes.octave,currentVolume:{l:0,r:0},currentOctave:4,currentGate:e,defaultDot:0,defaultLength:4,loop:{offset:0,line:0,count:0,end:{offset:0,line:0}},localLoopId:0,count:0,data:[],dataLength:0};0==s&&(o.data.push(d.CMD_FINENESS),o.data.push(this.tags.fineness>>8),o.data.push(this.tags.fineness&255)),v.HARDWARE_MODE_FAMICOM==o.mode?(o.data.push(d.CMD_MODULE_CHANGE),2!=s?o.data.push(1):o.data.push(4)):v.HARDWARE_MODE_GAMEBOY==o.mode&&(o.data.push(d.CMD_MODULE_CHANGE),3==s?o.data.push(15):2==s?o.data.push(14):o.data.push(13),o.data.push(d.CMD_FREQUENCY_MODE_CHANGE),2==s&&o.data.push(3));for(o.line=0;o.line<this.channels[s].length;o.line++){o.lineObject=this.channels[s][o.line];for(o.offset=0;o.offset<o.lineObject.data.byteLength();){o.offset+=o.lineObject.data.countSpaces(o.offset);if(o.offset>=o.lineObject.data.byteLength())break;var u=o.lineObject.data.lowerCharAt(o.offset),a=u,f=[];"a"<=u&&u<="g"&&(u="r");if(!i[u])throw new v.CompileError(o.lineObject,o.offset,"unknown command '"+u+"'");o.offset++;if(i[u].sequence){o.offset+=o.lineObject.data.countSpaces(o.offset);if(o.offset>=o.lineObject.data.byteLength())break;var l=o.lineObject.data.lowerCharAt(o.offset);i[u].sequence.indexOf(l)>=0&&(u+=l,a=u,o.offset++)}this.logMmlCompile&&t.getLog().info("command "+a+" with parameters as follows");for(var c=0;c<i[u].args.length;c++){if(0!=c){var h=v._getCharacter(o.lineObject,o.offset,",");if(h<0)break;o.offset=h+1}var p=v._getNumberParameter(o.lineObject,o.offset);if(typeof p.parameter=="undefined"){if(typeof i[u].args[c].def=="undefined"&&i[u].args[c].mandatory)throw new v.CompileError(o.lineObject,o.offset,"missing argument for '"+u+"'");f.push(i[u].args[c].def)}else f.push(p.parameter),o.offset=p.end+1}this.logMmlCompile&&t.getLog().info(f),o.dataLength=o.data.length,i[u].callback&&i[u].callback(this,o,a,f);if(this.logMmlCompile){var m="> "+o.dataLength.toString(16)+": ";for(c=o.dataLength;c<o.data.length;c++)c!=o.dataLength&&(m+=", "),m+=o.data[c].toString(16);t.getLog().info(m)}o.dataLength=o.data.length}}o.data.push(d.CMD_END),this.channelData[s]=o.data,t.getLog().info("TSS: DATA "+(s+1)+"> "+o.data.length+" Byte(s) / "+o.count+" Tick(s)")}},v.prototype._generateTsd=function(){var e=this.tags.title.byteLength();0!=e%2&&e++;var n=18+e+2+8*this.tags.channels+4,r=n;t.getLog().info("TSS: HEADER SIZE> "+r);var i;for(i=0;i<this.tags.channels;i++)r+=this.channelData[i].length;var s=r;r+=2,t.getLog().info("TSS: WAVE> "+this.validWaves);for(i=0;i<this.waves.length;i++){if(!this.waves[i])continue;t.getLog().info("TSS:  "+i+"> "+this.waves[i].length),r+=2+this.waves[i].length}r+=2,t.getLog().info("TSS: TABLE> "+this.validTables);for(i=0;i<this.tables.length;i++){if(!this.tables[i])continue;t.getLog().info("TSS:  "+i+"> "+this.tables[i].length),r+=2+this.tables[i].length}var o=new Uint8Array(r);t.getLog().info("TSS: TOTAL SIZE> "+r);var u=m.createFromUint8Array(o),a=u.setASCII(0,"T'SoundSystem");u.setAt(a++,Math.floor(v.VERSION)),u.setAt(a++,Math.floor(v.VERSION*100)%100),a=u.setUint16(a,this.tags.title.byteLength()),a=u.setTString(a,this.tags.title),0==this.tags.title.byteLength()%2&&a--,a=u.setUint16(a,this.tags.channels);var f=n;for(i=0;i<this.tags.channels;i++){var l=this.channelData[i].length;a=u.setUint32(a,f),a=u.setUint32(a,l);for(var c=0;c<l;c++)u.setAt(f+c,this.channelData[i][c]);f+=l}a=u.setUint32(a,s),a=u.setUint16(s,this.validWaves);for(i=0;i<this.validWaves;i++){if(!this.waves[i])continue;u.setAt(a++,i);var h=this.waves[i].length;u.setAt(a++,h);for(var p=0;p<h;p++)u.setAt(a++,v._toUint8(this.waves[i][p]))}a=u.setUint16(a,this.validTables);for(i=0;i<this.validTables;i++){if(!this.tables[i])continue;u.setAt(a++,i),h=this.tables[i].length,u.setAt(a++,h);for(p=0;p<h;p++)u.setAt(a++,v._toUint8(this.tables[i][p]))}return o.buffer},v.prototype._compile=function(){try{return this._parseLines(),this._parseDirectives(),this._parseChannels(),this._generateTsd()}catch(e){return t.getLog().error(e.stack),t.getLog().error(e.toString()),null}},v.prototype.compile=function(e){return typeof e=="string"?this.source=m.createFromString(e):this.source=m.createFromUint8Array(new Uint8Array(e)),this._compile()};var m=function(){this.object=null};m.CODE_NUL=0,m.CODE_HT=9,m.CODE_LF=10,m.CODE_CR=13,m.CODE_SP=32,m.CODE_0=48,m.CODE_9=57,m.CODE_A=65,m.CODE_Z=90,m.CODE_a=97,m.CODE_z=122,m._isBMP=function(e){return e<0||65536<=e?!1:e<55296?!0:e>=57344?!0:!1},m._isHighSurrogates=function(e){return 55296<=e&&e<56320?!0:!1},m._isLowSurrogates=function(e){return 56320<=e&&e<57344?!0:!1},m._decodeSurrogatePair=function(e,t){if(!m._isHighSurrogates(e)||!m._isLowSurrogates(t))throw new RangeError("TString: invalid surrogate pair ("+e+", "+t+")");var n=e>>6&15,r=n+1,i=(e&63)<<10|t&1023,s=(r<<16)+i;return s<0?4294967296+s:s},m._bytesInUTF8=function(e){if(e<0)throw new RangeError("TString: invalid UCS-2 code "+e);if(e<128)return 1;if(e<2048)return 2;if(e<65536)return 3;if(e<2097152)return 4;if(e<67108864)return 5;if(e<2147483648)return 6;throw new RangeError("TString: invalid UCS-2 code "+e)},m._countString=function(e){var t=0;for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(!m._isBMP(r)){if(++n>=e.length)throw new RangeError("TString: invalid surrogate pair");r=m._decodeSurrogatePair(r,e.charCodeAt(n))}t+=m._bytesInUTF8(r)}return t},m._setUcs2=function(e,t,n){if(n<0)throw new RangeError("TString: invalid UCS-2 code "+n);if(n<128)return e[t]=n,1;if(n<2048)return e[t+0]=192|n>>6,e[t+1]=128|n&63,2;if(n<65536)return e[t+0]=224|n>>12,e[t+1]=128|n>>6&63,e[t+2]=128|n&63,3;if(n<2097152)return e[t+0]=240|n>>18,e[t+1]=128|n>>12&63,e[t+2]=128|n>>6&63,e[t+3]=128|n&63,4;if(n<67108864)return e[t+0]=248|n>>24,e[t+1]=128|n>>18&63,e[t+2]=128|n>>12&63,e[t+3]=128|n>>6&63,e[t+4]=128|n&63,5;if(n<2147483648)return e[t+0]=252|n>>30,e[t+1]=128|n>>24&63,e[t+2]=128|n>>18&63,e[t+3]=128|n>>12&63,e[t+4]=128|n>>6&63,e[t+5]=128|n&63,6;throw new RangeError("TString: invalid UCS-2 code "+n)},m._buildUint8ArrayString=function(e){var t=m._countString(e),n=new Uint8Array(t),r=0;for(var i=0;i<e.length;i++){var s=e.charCodeAt(i);if(!m._isBMP(s)){if(++i>=e.length)throw new RangeError("TString: invalid surrogate pair");s=m._decodeSurrogatePair(s,e.charCodeAt(i))}r+=m._setUcs2(n,r,s)}return n},m.createFromString=function(e){var t=new m;return t._fromString(e),t},m.createFromUint8Array=function(e){var t=new m;return t._fromUint8Array(e),t},m.prototype._fromString=function(e){this.object=m._buildUint8ArrayString(e)},m.prototype._fromUint8Array=function(e){this.object=e},m.prototype.at=function(e){if(e>=this.object.byteLength)throw new RangeError("TString: offset is out of range");return this.object[e]},m.prototype.charAt=function(e){return String.fromCharCode(this.at(e))},m.prototype.lowerCharAt=function(e){var t=this.at(e);return m.CODE_A<=t&&t<=m.CODE_Z&&(t|=32),String.fromCharCode(t)},m.prototype.numberAt=function(e){return this.isNumber(e)?this.object[e]-m.CODE_0:-1},m.prototype.setAt=function(e,t){if(e>=this.object.byteLength)throw new RangeError("TString: offset is out of range");this.object[e]=t},m.prototype.setCharAt=function(e,t){this.setAt(e,t.charCodeAt(0))},m.prototype.setASCII=function(e,t){for(var n=0;n<t.length;n++)this.setAt(e+n,t.charCodeAt(n));return this.setAt(e+t.length,0),e+t.length+1},m.prototype.setTString=function(e,t){for(var n=0;n<t.byteLength();n++)this.setAt(e+n,t.at(n));return this.setAt(e+t.byteLength(),0),e+t.byteLength()+1},m.prototype.setUint16=function(e,t){return this.setAt(e,t>>8),this.setAt(e+1,t&255),e+2},m.prototype.setUint32=function(e,t){return this.setAt(e,t>>24),this.setAt(e+1,t>>16&255),this.setAt(e+2,t>>8&255),this.setAt(e+3,t&255),e+4},m.prototype.byteLength=function(){return this.object.length},m.prototype.slice=function(e,t){return m.createFromUint8Array(this.object.subarray(e,t))},m.prototype.containString=function(e,t){var n=m.createFromString(t);return this.containUint8Array(e,n.object)},m.prototype.containUint8Array=function(e,t){for(var n=0;n<t.length;n++)if(this.object[e+n]!=t[n])return!1;return!0},m.prototype.containASCII=function(e,t){for(var n=0;n<t.length;n++)if(this.object[e+n]!=t.charCodeAt(n))return!1;return!0},m.prototype.countLine=function(e){var t=0;for(var n=e;n<this.object.length;n++){var r=this.object[n];if(m.CODE_CR==r||m.CODE_LF==r)break;t++}return t},m.prototype.countLineDelimiter=function(e){if(e>=this.object.length)return 0;var t=0,n=this.object[e++];if(m.CODE_CR==n){if(e==this.object.length)return 1;t++,n=this.object[e]}return m.CODE_LF==n&&t++,t},m.prototype.countSpaces=function(e){var t=0;for(var n=e;n<this.object.length;n++){var r=this.object[n];if(m.CODE_NUL!=r&&m.CODE_HT!=r&&m.CODE_SP!=r)break;t++}return t},m.prototype.alphabetIndex=function(e){var t=this.object[e];return m.CODE_A<=t&&t<=m.CODE_Z?t-m.CODE_A:m.CODE_a<=t&&t<=m.CODE_z?t-m.CODE_a:-1},m.prototype.isNumber=function(e){if(e>=this.object.byteLength)return!1;var t=this.object[e];return t<m.CODE_0||m.CODE_9<t?!1:!0},m.prototype.find=function(e,t){for(var n=e;n<this.object.length;n++)if(this.object[n]==t)return n;return-1},m.prototype.toString=function(e,t){arguments.length<1&&(e=0),arguments.length<2&&(t=this.byteLength()-e);var n="",r=!0,i=1,s=0;for(var o=0;o<t&&o<this.object.length;o++){var u=this.object[e+o];if(r){if(0==u)break;if(u<128){n+=String.fromCharCode(u);continue}r=!1;if(u<194)throw new TypeError("TString: invalid UTF-8");if(u<224)i=2,s=u&31;else if(u<240)i=3,s=u&15;else if(u<248)i=4,s=u&7;else if(u<252)i=5,s=u&3;else{if(!(u<254))throw new TypeError("TString: invalid UTF-8");i=6,s=u&1}i--}else{if(u<128||191<u)throw new TypeError("TString: invalid UTF-8");s=s<<6|u&63,i--;if(0==i){r=!0;if(s<55296||57344<=s)n+=String.fromCharCode(s);else{var a=s>>16&31,f=a-1,l=s&65535;n+=String.fromCharCode(55296+(f<<6)+(l>>10)),n+=String.fromCharCode(56320+(l&1023))}}}}if(!r)throw new TypeError("TString: invalid UTF-8");return n},e.TString=m;var g=function(){this.masterChannel=null,this.input=null,this.offset=0,this.psg=null,this.minorVersion=0,this.snClock=a.CLOCK_3_58MHZ,this.error=!1,this.loop=!1,this.loopSkipOffset=0,this.interval=g._PLAYER_INTERVAL_NTSC,this.wait=0,this.writtenSamples=0}
;g._GZ_ID1=31,g._GZ_ID2=139,g._VGM_ID1="V".charCodeAt(0),g._VGM_ID2="g".charCodeAt(0),g._VGM_ID3="m".charCodeAt(0),g._VGM_ID4=" ".charCodeAt(0),g._VGM_IDENT_SIZE=4,g._VGM_VERSION_SIZE=4,g._VERSION_1_00=0,g._VERSION_1_01=1,g._VERSION_1_10=16,g._VERSION_1_50=80,g._UINT_SIZE=4,g._BYTE_MASK=255,g._OFFSET_0=0,g._OFFSET_1=1,g._OFFSET_2=2,g._OFFSET_3=3,g._LSHIFT_0_BYTE=0,g._LSHIFT_1_BYTE=8,g._LSHIFT_2_BYTE=16,g._LSHIFT_3_BYTE=24,g._PLAYER_INTERVAL_NTSC=17,g._PLAYER_INTERVAL_PAL=20,g._VGM_DEFAULT_DATA_OFFSET=64,g._VGM_1_00_EOH=36,g._CMD_WRITE_GG=79,g._CMD_WRITE_SN=80,g._CMD_WRITE_YM2413=81,g._CMD_WRITE_YM2612A=82,g._CMD_WRITE_YM2612B=83,g._CMD_WRITE_YM2151=84,g._CMD_WAIT_NNNN=97,g._CMD_WAIT_735=98,g._CMD_WAIT_882=99,g._CMD_EOD=102,g._WAIT_735=735,g._WAIT_882=882,g.prototype.readUInt=function(e,t){if(e.length<=t+g._UINT_SIZE)throw new Error("Unexpected EOF");var n=(e[t+g._OFFSET_0]&g._BYTE_MASK)<<g._LSHIFT_0_BYTE,r=(e[t+g._OFFSET_1]&g._BYTE_MASK)<<g._LSHIFT_1_BYTE,i=(e[t+g._OFFSET_2]&g._BYTE_MASK)<<g._LSHIFT_2_BYTE,s=(e[t+g._OFFSET_3]&g._BYTE_MASK)<<g._LSHIFT_3_BYTE,o=s|i|r|n;return o<0?4294967296+o:o},g.prototype.setMasterChannel=function(e){this.psg=new a,this.psg.setMode(a.MODE_SIGNED),this.psg.setDevice(a.DEVICE_SN76489),e.clearChannel(),e.addChannel(this.psg),e.setPlayer(this),e.setPlayerInterval(g._PLAYER_INTERVAL_NTSC),this.interval=g._WAIT_735,t.getLog().info("VGM: assume as NTSC"),this.masterChannel=e},g.prototype.updateDevice=function(){if(this.error||this.input==null)return;this.wait-=this.interval;if(this.wait>0)return;try{for(;;){var e=this.input[this.offset++],n,r;switch(e){case g._CMD_WRITE_GG:n=this.input[this.offset++],this.psg.writeRegister(0,n&g._BYTE_MASK),this.writtenSamples++;break;case g._CMD_WRITE_SN:n=this.input[this.offset++],this.psg.writeRegister(0,n&g._BYTE_MASK),this.writtenSamples++;break;case g._CMD_WRITE_YM2413:case g._CMD_WRITE_YM2612A:case g._CMD_WRITE_YM2612B:case g._CMD_WRITE_YM2151:this.error=!0,t.getLog().warn("VGM: FM sound is not supported");return;case g._CMD_WAIT_NNNN:n=this.input[this.offset++],r=this.input[this.offset++],this.wait=n&g._BYTE_MASK|(r&g._BYTE_MASK)<<g._LSHIFT_1_BYTE;return;case g._CMD_WAIT_735:this.wait+=g._WAIT_735,this.masterChannel.setPlayerInterval(g._PLAYER_INTERVAL_NTSC),this.interval!=g._WAIT_735&&(t.getLog().info("VGM: detect as NTSC"),this.interval=g._WAIT_735);return;case g._CMD_WAIT_882:this.wait+=g._WAIT_882,this.masterChannel.setPlayerInterval(g._PLAYER_INTERVAL_PAL),this.interval!=g._WAIT_882&&(t.getLog().info("VGM: detect as PAL"),this.interval=g._WAIT_882);return;case g._CMD_EOD:if(!this.loop){this.error=!0;return}this.offset=this.loopSkipOffset,t.getLog().info("VGM: loop");break;default:t.getLog().warn("VGM: unknown command 0x"+(e&g._BYTE_MASK).toString(16)),t.getLog().warn("written samples = "+this.writtenSamples);return}}}catch(i){t.getLog().error("VGM: "+i.toString()),this.error=!0}},g.prototype.play=function(e){try{this.input=null,this.offset=0,this.error=!1,this.loop=!1;var n=new Uint8Array(e);if(g._GZ_ID1==n[0]&&g._GZ_ID2==n[1])return t.getLog().info("VGM: GZip compressed, aka VGZ"),t.getLog().error("VGZ: Not supported"),!1;var r=0;if(n.byteLength<=r+g._VGM_IDENT_SIZE)return!1;if(n[r+g._OFFSET_0]!=g._VGM_ID1||n[r+g._OFFSET_1]!=g._VGM_ID2||n[r+g._OFFSET_2]!=g._VGM_ID3||n[r+g._OFFSET_3]!=g._VGM_ID4)return t.getLog().error("VGM: Invalid IDENT"),!1;r+=g._VGM_IDENT_SIZE,t.getLog().info("VGM: detect VGM indent");var i=this.readUInt(n,r)+g._UINT_SIZE;r+=4,t.getLog().info("VGM: file length = "+i);if(n.byteLength<=r+g._VGM_VERSION_SIZE)return!1;var s=new Array(g._VGM_VERSION_SIZE);for(var o=0;o<g._VGM_VERSION_SIZE;o++)s[o]=n[r++];if(s[g._OFFSET_3]!=0||s[g._OFFSET_2]!=0||s[g._OFFSET_1]!=1)return t.getLog().error("VGM: version is not 1.x ("+s[g._OFFSET_3]+"."+s[g._OFFSET_2]+"."+s[g._OFFSET_1]+"."+s[g._OFFSET_0]+")"),!1;this.minorVersion=s[g._OFFSET_0]&g._BYTE_MASK;switch(this.minorVersion){case g._VERSION_1_00:t.getLog().info("VGM: version 1.00");break;case g._VERSION_1_01:t.getLog().info("VGM: version 1.01");break;case g._VERSION_1_10:t.getLog().info("VGM: version 1.10");break;case g._VERSION_1_50:t.getLog().info("VGM: version 1.50");break;default:return t.getLog().info("VGM: unknown version 1.["+this.minorVersion+"]"),!1}var u;u=this.readUInt(n,r),r+=4;if(0==u)return t.getLog().warn("VGM: SN76489 is not used"),!1;t.getLog().info("VGM: SN76489 clock is "+u+" Hz"),u!=this.snClock&&(t.getLog().info("VGM:   not "+this.snClock+" Hz"),this.snClock=u),this.psg.setClock(this.snClock),u=this.readUInt(n,r),r+=4;if(0!=u)return t.getLog().info("VGM: YM2413 clock is "+u+" Hz"),!1;var a=this.readUInt(n,r);r+=4,t.getLog().info("VGM: GD3 offset = "+a);var f=this.readUInt(n,r);t.getLog().info("VGM: Total # samples = "+f),r+=4;var l=this.readUInt(n,r);t.getLog().info("VGM: Loop offset = "+l),0!=l&&(this.loop=!0,this.loopSkipOffset=r+l),r+=4;var c=this.readUInt(n,r);return t.getLog().info("VGM: Loop # samples = "+c),r+=4,this.minorVersion==g._VERSION_1_00?(r+=g._VGM_DEFAULT_DATA_OFFSET-g._VGM_1_00_EOH,this.offset=r,this.input=n,!0):this.minorVersion<=g._VERSION_1_50?(r+=g._VGM_DEFAULT_DATA_OFFSET-g._VGM_1_00_EOH,this.offset=r,this.input=n,!0):!1}catch(h){return!1}};var y=function(e){this.port=e};y.prototype=new u,y.prototype.constructor=y,y.initialized=!1,y.inputs=[],y.outputs=[],y._access=null,y.initialize=function(e){if(y.initialized)return e&&e(!0),!0;if(navigator.requestMIDIAccess===undefined)return t.getLog().info("Web MIDI API is not available."),e&&e(!1),!1;var n=e;navigator.requestMIDIAccess({sysex:!0}).then(function(e){y._access=e,t.getLog().info("Web MIDI API is available."),y.initialized=!0,n&&n(!0),y.inputs=e.inputs(),t.getLog().info("MIDI inputs: "+y.inputs.length),y.outputs=e.outputs(),t.getLog().info("MIDI outputs: "+y.outputs.length);for(var r=0;r<y.outputs.length;++r)t.getLog().info("<"+r+">"),t.getLog().info("  id          : "+y.outputs[r].id),t.getLog().info("  manufacturer: "+y.outputs[r].manufacturer),t.getLog().info("  name        : "+y.outputs[r].name),t.getLog().info("  version     : "+y.outputs[r].version)},function(e){t.getLog().error("Web MIDI API report an error on initialization."),t.getLog().error(e),n&&n(!1)})},function(){y.initialize()}(),y.prototype.processNoteOff=function(e,t,n){this.sendToMIDI(128+e,t,n)},y.prototype.processNoteOn=function(e,t,n){this.sendToMIDI(144+e,t,n)},y.prototype.processKeyPressure=function(e,t,n){this.sendToMIDI(160+e,t,n)},y.prototype.processControlChange=function(e,t,n){this.sendToMIDI(176+e,t,n)},y.prototype.processProgramChange=function(e,t){this.sendToMIDI(192+e,t)},y.prototype.processChannelPressure=function(e,t){this.sendToMIDI(208+e,t)},y.prototype.processPitchBend=function(e,t){this.sendToMIDI(224+e,t>>7&127,t&127)},y.prototype.processSystemExclusive=function(e){this.sendToMIDI.apply(this,e)},y.prototype.processSystemCommonMessage=function(e){this.sendToMIDI.apply(this,e)},y.prototype.processSystemRealtimeMessage=function(e){this.sendToMIDI.apply(this,e)},y.prototype.processSystemReset=function(){this.sendToMIDI(255)},y.prototype.processMetaData=function(e){this.sendToMIDI.apply(this,e)},y.prototype.sendToMIDI=function(){this.port&&this.port.send(Array.prototype.slice.call(arguments))};var b=function(e){this.port=e};b.prototype=new u,b.prototype.constructor=b,b.prototype.processNoteOff=function(e,t,n){this.sendToWebMidiLink(128+e,t,n)},b.prototype.processNoteOn=function(e,t,n){this.sendToWebMidiLink(144+e,t,n)},b.prototype.processKeyPressure=function(e,t,n){this.sendToWebMidiLink(160+e,t,n)},b.prototype.processControlChange=function(e,t,n){this.sendToWebMidiLink(176+e,t,n)},b.prototype.processProgramChange=function(e,t){this.sendToWebMidiLink(192+e,t)},b.prototype.processChannelPressure=function(e,t){this.sendToWebMidiLink(208+e,t)},b.prototype.processPitchBend=function(e,t){this.sendToWebMidiLink(224+e,t>>7&127,t&127)},b.prototype.processSystemExclusive=function(e){this.sendToWebMidiLink.apply(this,e)},b.prototype.processSystemCommonMessage=function(e){this.sendToWebMidiLink.apply(this,e)},b.prototype.processSystemRealtimeMessage=function(e){this.sendToWebMidiLink.apply(this,e)},b.prototype.processSystemReset=function(){this.sendToWebMidiLink(255)},b.prototype.processMetaData=function(e){this.sendToWebMidiLink.apply(this,e)},b.prototype.sendToWebMidiLink=function(){var e=["midi"];for(var t=0;t<arguments.length;++t)e.push(arguments[t].toString(16));this.port&&this.port.postMessage(e.join(","),"*")};var w=function(){this.buffer=null,this.lfsr=65535,this.data=w.DEFAULT_VOLUME};w.DEFAULT_VOLUME=1024,w.prototype.setBufferLength=function(e){this.buffer=new Int32Array(e)},w.prototype.setSampleRate=function(e){},w.prototype.getBuffer=function(){return this.buffer},w.prototype.generate=function(e){for(var t=0;t<e;t+=2){var n=this.lfsr&1^(this.lfsr&2048)>>11^(this.lfsr&4096)>>12^(this.lfsr&8192)>>13,r=0!=n?this.data:-this.data;this.lfsr=this.lfsr>>1|n<<15,this.buffer[t+0]=r,this.buffer[t+1]=r}},this.AudioLooper=n,this.BiquadFilterChannel=r,this.Format=i,this.FrequencyConversionChannel=s,this.MasterChannel=o,this.MidiChannel=u,this.PsgDeviceChannel=a,this.SimpleMidiChannel=f,this.SimpleSlaveChannel=l,this.SmfPlayer=c,this.TimerMasterChannel=h,this.TssChannel=p,this.TsdPlayer=d,this.TssCompiler=v,this.TString=m,this.VgmPlayer=g,this.WebMidiChannel=y,this.WebMidiLinkMidiChannel=b,this.WhiteNoiseChannel=w,this.createAudioLooper=function(e){return new n(e)},this.createBiquadFilterChannel=function(){return new r},this.createFrequencyConversionChannel=function(){return new s},this.createMasterChannel=function(){return new o},this.createMidiChannel=function(){return new u},this.createPsgDeviceChannel=function(){return new a},this.createSimpleMidiChannel=function(){return new f},this.createSimpleSlaveChannel=function(e){return new l(e)},this.createSmfPlayer=function(){return new c},this.createTimerMasterChannel=function(e){return new h(e)},this.createTssChannel=function(){return new p},this.createTString=function(){return new m},this.createVgmPlayer=function(){return new g},this.createWebMidiChannel=function(e){return new y(e)},this.createWebMidiLinkMidiChannel=function(){return new b(port)},this.createWhiteNoiseChannel=function(){return new w}}});